<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DeepSeek 語音潤色修飾助手</title>
        <meta name="theme-color" content="#165DFF">
        <link rel="manifest" href="manifest.webmanifest">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/v4-shims.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#722ED1',
                        accent: '#FF7D00',
                        success: '#00B42A',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        info: '#168CFF'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 50%, #06B6D4 100%);
            }
            .brand-bg {
                background: radial-gradient(1200px 600px at 10% 0%, rgba(59,130,246,0.12), transparent 60%),
                            radial-gradient(1200px 600px at 90% 10%, rgba(139,92,246,0.12), transparent 60%),
                            linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            }
            .card-shadow {
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            }
            .btn-hover {
                transition: all 0.3s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            }
            .pulse-animation {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .slide-in {
                animation: slideIn 0.5s ease-out;
            }
            @keyframes slideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .loading-shimmer {
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
                background-size: 200% 100%;
                animation: shimmer 1.5s infinite;
            }
            @keyframes shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            .token-badge {
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }
            .status-badge {
                padding: 4px 12px;
                border-radius: 16px;
                font-size: 13px;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
            }
            .token-card {
                transition: all 0.3s ease;
            }
            .token-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            }
        }
    </style>
</head>
<body class="font-inter brand-bg min-h-screen">
    <!-- 顶部导航 -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fa fa-magic text-2xl"></i>
                    <h1 class="text-xl font-bold">DeepSeek 語音潤色修飾助手</h1>
                </div>
                <div class="text-sm opacity-90">
                    API狀態監控 | Token精確統計
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="container mx-auto px-4 py-8">
        <!-- API设置区域 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-8 slide-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fa fa-cog mr-2 text-primary"></i>DeepSeek API 設置
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="text" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                           placeholder="請輸入您的DeepSeek API Key" value="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                    <p class="text-xs text-gray-500 mt-1">取得API Key: <a href="https://platform.deepseek.com/" target="_blank" class="text-primary hover:underline">DeepSeek平台</a></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模型選擇</label>
                    <select id="modelSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="deepseek-chat">deepseek-chat (預設)</option>
                        <option value="deepseek-coder">deepseek-coder</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="saveApiKey" class="mr-2">
                    <label for="saveApiKey" class="text-sm text-gray-700">儲存API Key (僅儲存在您的瀏覽器中)</label>
                </div>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-8 slide-in">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fa fa-comment mr-2 text-info"></i>輸入要潤色修飾的內容
            </h2>
            <div class="space-y-4">
                <div class="relative">
                    <textarea id="inputText" class="w-full px-3 py-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                              rows="4" placeholder="請輸入小學生說的話...例如：爬山今天 困難更的 期待"></textarea>
                    <div id="tokenCounter" class="absolute bottom-2 right-3 text-xs text-gray-500">
                        0 / 500 tokens
                    </div>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button id="analyzeBtn" class="px-6 py-3 bg-primary text-white rounded-lg btn-hover flex items-center" onclick="analyzeText(event)">
                        <i class="fa fa-bullseye mr-2"></i>DeepSeek 分析
                    </button>
                    <button id="clearBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg btn-hover">
                        <i class="fa fa-trash mr-2"></i>清除
                    </button>
                    <button id="voiceBtn" class="px-6 py-3 bg-rose-600 text-white rounded-lg btn-hover flex items-center">
                        <i class="fa fa-microphone mr-2"></i>語音輸入
                    </button>
                </div>
            </div>
        </div>

        <!-- API调用状态 - 重点优化区域 -->
        <div id="apiStatus" class="hidden mb-6">
            <div class="bg-white rounded-2xl p-6 card-shadow border-l-4 border-primary">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <!-- 状态信息 -->
                    <div class="flex items-center">
                        <div id="statusIconWrapper" class="w-12 h-12 rounded-full bg-success/10 flex items-center justify-center mr-4">
                            <i id="statusIcon" class="fa fa-check-circle text-success text-2xl"></i>
                        </div>
                        <div>
                            <h3 id="statusTitle" class="font-bold text-success text-lg">API 調用成功</h3>
                            <p id="statusMessage" class="text-sm text-gray-600">已成功獲取DeepSeek分析結果</p>
                            <div class="flex items-center mt-2">
                                <span id="apiResponseTime" class="text-xs text-gray-500 mr-4">
                                    <i class="fa fa-clock-o mr-1"></i>響應時間: 0ms
                                </span>
                                <span id="apiModelUsed" class="text-xs text-gray-500">
                                    <i class="fa fa-server mr-1"></i>模型: deepseek-chat
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Token总计 -->
                    <div class="bg-primary/5 p-4 rounded-lg token-card">
                        <div class="text-center">
                            <div class="text-xs text-primary/70 mb-1">總計使用</div>
                            <div class="text-2xl font-bold text-primary" id="totalTokensDisplay">0</div>
                            <div class="text-xs text-primary/70">tokens</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细Token统计 - 重点优化区域 -->
        <div id="detailedTokenStats" class="hidden mb-8">
            <div class="bg-white rounded-2xl p-6 card-shadow">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa fa-bar-chart mr-2 text-info"></i>詳細 Token 統計
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 输入Token -->
                    <div class="bg-blue-50 p-5 rounded-lg token-card">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-blue-800">輸入 Token</h4>
                            <i class="fa fa-arrow-right text-blue-400"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600" id="inputTokens">0</div>
                            <div class="text-sm text-blue-500 mt-1">提示詞 + 輸入內容</div>
                        </div>
                    </div>

                    <!-- 输出Token -->
                    <div class="bg-green-50 p-5 rounded-lg token-card">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-green-800">輸出 Token</h4>
                            <i class="fa fa-arrow-left text-green-400"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600" id="outputTokens">0</div>
                            <div class="text-sm text-green-500 mt-1">AI 生成結果</div>
                        </div>
                    </div>

                    <!-- 总计Token -->
                    <div class="bg-purple-50 p-5 rounded-lg token-card">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-purple-800">總計 Token</h4>
                            <i class="fa fa-calculator text-purple-400"></i>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold text-purple-600" id="totalTokensCount">0</div>
                            <div class="text-sm text-purple-500 mt-1">輸入 + 輸出</div>
                        </div>
                    </div>
                </div>

                <!-- 每结果Token统计 -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="font-medium text-gray-700 mb-3">
                        <i class="fa fa-list mr-2 text-gray-500"></i>每個結果 Token 統計
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">最佳講法</div>
                            <div class="font-bold text-gray-800" id="result1TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">記敘文（敘事）版</div>
                            <div class="font-bold text-gray-800" id="result2TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">描寫文（描寫）版</div>
                            <div class="font-bold text-gray-800" id="result3TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">議論文（總分總）版</div>
                            <div class="font-bold text-gray-800" id="result4TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">作文（寫作方式）版</div>
                            <div class="font-bold text-gray-800" id="result5TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-xs text-gray-500 mb-1">文言文版</div>
                            <div class="font-bold text-gray-800" id="result6TokenCount">0</div>
                            <div class="text-xs text-gray-500">tokens</div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-700 mb-3">
                            <i class="fa fa-code mr-2 text-blue-500"></i>輸入 Token 內容
                        </h4>
                        <div id="inputTokenContent" class="flex flex-wrap gap-2 bg-gray-50 p-3 rounded-lg"></div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-medium text-gray-700 mb-3">
                            <i class="fa fa-file-text-o mr-2 text-purple-500"></i>提示詞內容（送往模型的文本）
                        </h4>
                        <pre id="promptText" class="text-xs bg-gray-50 p-3 rounded-lg overflow-auto max-h-48"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- 处理状态 -->
        <div id="processingStatus" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-8 hidden fade-in">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mr-3"></div>
                <div>
                    <h3 class="font-medium text-blue-800">正在分析中...</h3>
                    <p class="text-sm text-blue-600">DeepSeek API 正在處理您的請求，請稍候...</p>
                </div>
            </div>
        </div>

        <!-- 错误提示 - 增强版 -->
        <div id="errorAlert" class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-8 hidden fade-in">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-times-circle text-red-500 text-xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="font-medium text-red-800">API 調用失敗</h3>
                    <p class="text-sm text-red-600 mb-2" id="errorMessage"></p>
                    <div class="text-xs text-red-500" id="errorDetails"></div>
                    <div class="mt-2 flex space-x-2">
                        <button onclick="showErrorHelp()" class="text-xs text-primary hover:underline">
                            <i class="fa fa-question-circle mr-1"></i>查看解決方案
                        </button>
                        <button onclick="hideError()" class="text-xs text-gray-500 hover:underline">
                            <i class="fa fa-times mr-1"></i>關閉
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果显示区域 -->
        <div id="resultArea" class="bg-white rounded-2xl p-6 card-shadow mb-8 hidden fade-in">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
                <i class="fa fa-trophy mr-2 text-accent"></i>最佳講法推薦
            </h2>
            
            <div class="space-y-4">
                <!-- 最佳讲法 1 -->
                <div class="bg-gradient-to-r from-primary/10 to-primary/5 p-4 rounded-lg border-l-4 border-primary">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold text-primary text-lg">
                            <i class="fa fa-star text-yellow-500 mr-2"></i>推薦講法
                        </h3>
                        <div class="flex items-center">
                            <span class="token-badge bg-primary/20 text-primary mr-2" id="result1Tokens">0 tokens</span>
                            <button onclick="playText('result1')" class="text-primary hover:text-primary/80 transition-colors">
                                <i class="fa fa-volume-up text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <p id="result1" class="text-gray-800"></p>
                    <div class="mt-2">
                        <button onclick="toggleMaterial('result1')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                        <div id="material-result1" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">連接詞</div>
                                    <div id="connectors-result1" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">句型庫</div>
                                    <div id="patterns-result1" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">段落大綱</div>
                                    <div id="outline-result1" class="space-y-1 text-xs"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">修辭工具箱</div>
                                    <div id="rhetoric-result1" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">教材提要</div>
                                    <div id="curriculumtips-result1" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                

                <!-- 其他讲法 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- 讲法 2 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow order-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" id="result2Title">記敘文（敘事）版</h4>
                            <div class="flex items-center">
                                <span class="token-badge bg-gray-200 text-gray-700 mr-2" id="result2Tokens">0 tokens</span>
                                <button onclick="playText('result2')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fa fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <p id="result2" class="text-gray-600"></p>
                        <div class="mt-2">
                            <button onclick="toggleMaterial('result2')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                        <div id="material-result2" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">連接詞</div>
                                        <div id="connectors-result2" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">句型庫</div>
                                        <div id="patterns-result2" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">段落大綱</div>
                                        <div id="outline-result2" class="space-y-1 text-xs"></div>
                                    </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">修辭工具箱</div>
                                    <div id="rhetoric-result2" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">教材提要</div>
                                    <div id="curriculumtips-result2" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">用法指引</div>
                                    <div id="usage-result2" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 讲法 3 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow order-2">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" id="result3Title">描寫文（描寫）版</h4>
                            <div class="flex items-center">
                                <span class="token-badge bg-gray-200 text-gray-700 mr-2" id="result3Tokens">0 tokens</span>
                                <button onclick="playText('result3')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fa fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <p id="result3" class="text-gray-600"></p>
                        <div class="mt-2">
                            <button onclick="toggleMaterial('result3')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                        <div id="material-result3" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">連接詞</div>
                                        <div id="connectors-result3" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">句型庫</div>
                                        <div id="patterns-result3" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">段落大綱</div>
                                        <div id="outline-result3" class="space-y-1 text-xs"></div>
                                    </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">修辭工具箱</div>
                                    <div id="rhetoric-result3" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">教材提要</div>
                                    <div id="curriculumtips-result3" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">用法指引</div>
                                    <div id="usage-result3" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 讲法 4 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow order-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700">議論文（總分總）版</h4>
                            <div class="flex items-center">
                                <span class="token-badge bg-gray-200 text-gray-700 mr-2" id="result4Tokens">0 tokens</span>
                                <button onclick="playText('result4')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fa fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <p id="result4" class="text-gray-600"></p>
                        <div class="mt-2">
                            <button onclick="toggleMaterial('result4')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                        <div id="material-result4" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">連接詞</div>
                                        <div id="connectors-result4" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">句型庫</div>
                                        <div id="patterns-result4" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">段落大綱</div>
                                        <div id="outline-result4" class="space-y-1 text-xs"></div>
                                    </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">修辭工具箱</div>
                                    <div id="rhetoric-result4" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">教材提要</div>
                                    <div id="curriculumtips-result4" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 讲法 5 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow order-5">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" id="result5Title">作文（寫作方式）版</h4>
                            <div class="flex items-center">
                                <span class="token-badge bg-gray-200 text-gray-700 mr-2" id="result5Tokens">0 tokens</span>
                                <button onclick="playText('result5')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fa fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                        <p id="result5" class="text-gray-600"></p>
                        <div class="mt-2">
                            <button onclick="toggleMaterial('result5')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                        <div id="material-result5" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">連接詞</div>
                                        <div id="connectors-result5" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">句型庫</div>
                                        <div id="patterns-result5" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">段落大綱</div>
                                        <div id="outline-result5" class="space-y-1 text-xs"></div>
                                    </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">修辭工具箱</div>
                                    <div id="rhetoric-result5" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="md:col-span-3">
                                    <div class="text-xs text-gray-500 mb-1">教材提要</div>
                                    <div id="curriculumtips-result5" class="flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- 讲法 6 -->
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-shadow order-6">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-gray-700" id="result6Title">高中文言文（風格可選）</h4>
                            <div class="flex items-center">
                                <span class="token-badge bg-gray-200 text-gray-700 mr-2" id="result6Tokens">0 tokens</span>
                                <button onclick="playText('result6')" class="text-gray-600 hover:text-gray-800 transition-colors">
                                    <i class="fa fa-volume-up"></i>
                                </button>
                                <select id="wenyanLevelSelect" class="ml-3 px-2 py-1 text-xs border rounded">
                                    <option value="senior" selected>高中</option>
                                </select>
                                <select id="wenyanStyleSelect" class="ml-2 px-2 py-1 text-xs border rounded">
                                    <option value="none">核心古文風格（選擇）</option>
                                    <option value="chibi">赤壁賦（典雅景象、感懷達觀）</option>
                                    <option value="xiangjixuan">項脊軒志（親情敘述、懷舊細節）</option>
                                    <option value="hongmen">鴻門宴（史傳敘事、人物權謀）</option>
                                    <option value="chushibiao">出師表（奏表語氣、忠誠克制）</option>
                                    <option value="shishuo">師說（設論體、論證清晰）</option>
                                    <option value="taohuayuan">桃花源記（隱逸理想、景物清新）</option>
                                    <option value="quraanke">虯髯客傳（傳奇俠義、情節緊湊）</option>
                                    <option value="wanliu">晚遊六橋待月記（性靈審美、景物美）</option>
                                    <option value="laoshan">勞山道士（諷刺神怪、意味深長）</option>
                                    <option value="dazhongxiaokang">大同與小康（政治理想、語義端正）</option>
                                    <option value="jianzhuke">諫逐客書（論辯風格、包容人才）</option>
                                    <option value="quanhelun">勸和論（台灣題材、族群視角）</option>
                                    <option value="luguang">鹿港乘桴記（台灣歷史、地景滄桑）</option>
                                    <option value="huaju">畫菊自序（女性視角、性情描寫）</option>
                                </select>
                            </div>
                        </div>
                        <p id="result6" class="text-gray-600"></p>
                        <div class="mt-2">
                            <button onclick="toggleMaterial('result6')" class="px-2 py-1 text-xs bg-primary/10 text-primary rounded">素材</button>
                            <div id="material-result6" class="hidden mt-2 p-3 bg-gray-50 rounded-lg border">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">風格用字白名單</div>
                                        <div id="stylewords-result6" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">允許典故清單</div>
                                        <div id="styleallusions-result6" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">風格句式模板</div>
                                        <div id="styletemplates-result6" class="flex flex-wrap gap-2"></div>
                                    </div>
                                    <div class="md:col-span-3">
                                        <div class="text-xs text-gray-500 mb-1">用法指引</div>
                                        <div id="usage-result6" class="flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
                <div class="flex flex-wrap gap-3 mt-6">
                    <button id="copyAllBtn" class="px-6 py-3 bg-success text-white rounded-lg btn-hover">
                        <i class="fa fa-copy mr-2"></i>複製全部
                    </button>
                    <button id="newAnalysisBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg btn-hover">
                        <i class="fa fa-bullseye mr-2"></i>重新分析
                    </button>
                    <button id="manageWenyanBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg btn-hover">
                        <i class="fa fa-pencil mr-2"></i>文言詞表管理
                    </button>
                </div>
            <div id="wenyanManager" class="hidden mt-6 bg-white rounded-2xl p-6 card-shadow border">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fa fa-book mr-2 text-indigo-600"></i>文言詞表管理
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <div class="text-sm text-gray-700 mb-2">可用字表（校本優先）</div>
                        <textarea id="wenyanAllowedInput" class="w-full h-28 p-3 border rounded" placeholder="以、者、也、其…"></textarea>
                    </div>
                    <div>
                        <div class="text-sm text-gray-700 mb-2">可用常用詞（校本）</div>
                        <textarea id="wenyanCommonInput" class="w-full h-28 p-3 border rounded" placeholder="心、志、學、行…"></textarea>
                    </div>
                    <div>
                        <div class="text-sm text-gray-700 mb-2">禁用字表（校本）</div>
                        <textarea id="wenyanBannedInput" class="w-full h-28 p-3 border rounded" placeholder="曩、踽、黼黻…"></textarea>
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button id="saveWenyanBtn" class="px-6 py-2 bg-success text-white rounded-lg btn-hover">
                        <i class="fa fa-check mr-2"></i>保存
                    </button>
                    <button id="closeWenyanBtn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg btn-hover">
                        <i class="fa fa-times mr-2"></i>關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 核心优化规则 -->
        <div class="bg-gradient-to-r from-primary/5 to-secondary/5 border border-primary/20 rounded-xl p-4 mb-6">
            <h3 class="text-base font-bold text-gray-800 mb-3">
                <i class="fa fa-cogs mr-2 text-primary"></i>核心優化規則（必須嚴格遵守）
            </h3>
            <ul class="list-disc pl-5 space-y-1 text-xs text-gray-700">
                <li>調整語序，使語句通順（例：「爬山今天」→「今天爬山」）</li>
                <li>補全用詞，說清楚意思（例：「困難更的」→「更困難的山路」）</li>
                <li>保持口語化與簡單詞彙，適合小學生</li>
                <li>情緒合理，與內容相符（期待、開心等，不浮誇）</li>
                <li>句子可長可短，100字以內，易懂</li>
                <li>嚴格保留原意與因果／時序，不更改指涉</li>
                <li>用字規範：繁體中文（臺灣用字），不使用簡體字或簡化標點</li>
            </ul>
        </div>

        <!-- 使用说明 -->
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-6">
            <h3 class="text-base font-bold text-gray-800 mb-3">
                <i class="fa fa-info-circle mr-2 text-info"></i>使用說明
            </h3>
            <div class="space-y-1 text-xs text-gray-600">
                <p>• 點擊「DeepSeek 分析」即時調用API並刷新六行結果</p>
                <p>• 顯示詳細的API狀態與Token統計，便於成本管控</p>
                <p>• 輸入限制：最多 <span class="font-bold text-primary">100 Token</span></p>
                <p>• 每行結果均計數；統計採用官方計算方式</p>
                <p>• 嚴格遵守核心優化規則，文字易懂不浮誇</p>
                <p>• 文言行輸出：格式為「文言｜白話解釋」，兩段不可留空</p>
                <p>• 點「素材」可取得連接詞、句型庫、修辭工具、段落大綱與用法指引</p>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">DeepSeek 語音潤色修飾助手 © 2025</p>
            <p class="text-gray-500 text-sm mt-2">專為小學生語言表達優化設計</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let currentUtterance = null;
        const MAX_TOKENS = 500; // Token数限制
        let isAnalyzing = false; // 防止重复提交
        let apiCallStartTime = 0; // API调用开始时间
        let recognition = null;
        let isRecording = false;
        let lastFinalSegment = '';
        const recentFinalSegments = [];
        let lastFinalSegmentNorm = '';
        const recentFinalSegmentsNorm = [];
        let lastAppendTime = 0;

        // DOM元素 - 使用安全的元素获取方式
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const saveApiKeyCheckbox = document.getElementById('saveApiKey');
        const inputText = document.getElementById('inputText');
        const tokenCounter = document.getElementById('tokenCounter');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exampleBtn = document.getElementById('exampleBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const processingStatus = document.getElementById('processingStatus');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const resultArea = document.getElementById('resultArea');
        const copyAllBtn = document.getElementById('copyAllBtn');
        const newAnalysisBtn = document.getElementById('newAnalysisBtn');
        const apiStatus = document.getElementById('apiStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusIconWrapper = document.getElementById('statusIconWrapper');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const apiResponseTime = document.getElementById('apiResponseTime');
        const apiModelUsed = document.getElementById('apiModelUsed');
        const totalTokensDisplay = document.getElementById('totalTokensDisplay');
        const detailedTokenStats = document.getElementById('detailedTokenStats');
        const inputTokens = document.getElementById('inputTokens');
        const outputTokens = document.getElementById('outputTokens');
        const totalTokensCount = document.getElementById('totalTokensCount');
        const manageWenyanBtn = document.getElementById('manageWenyanBtn');
        const wenyanManager = document.getElementById('wenyanManager');
        const wenyanAllowedInput = document.getElementById('wenyanAllowedInput');
        const wenyanCommonInput = document.getElementById('wenyanCommonInput');
        const wenyanBannedInput = document.getElementById('wenyanBannedInput');
        const saveWenyanBtn = document.getElementById('saveWenyanBtn');
        const closeWenyanBtn = document.getElementById('closeWenyanBtn');
        const wenyanLevelSelect = document.getElementById('wenyanLevelSelect');
        const wenyanStyleSelect = document.getElementById('wenyanStyleSelect');
        const phaseSelect = document.getElementById('phaseSelect');
        const manageCurriculumBtn = document.getElementById('manageCurriculumBtn');
        const curriculumManager = document.getElementById('curriculumManager');
        const elementaryCurriculumInput = document.getElementById('elementaryCurriculumInput');
        const juniorCurriculumInput = document.getElementById('juniorCurriculumInput');
        const saveCurriculumBtn = document.getElementById('saveCurriculumBtn');
        const closeCurriculumBtn = document.getElementById('closeCurriculumBtn');
        const resultTokenCountElements = {
            result1: document.getElementById('result1TokenCount'),
            result2: document.getElementById('result2TokenCount'),
            result3: document.getElementById('result3TokenCount'),
            result4: document.getElementById('result4TokenCount'),
            result5: document.getElementById('result5TokenCount'),
            result6: document.getElementById('result6TokenCount')
        };
        const inputTokenContent = document.getElementById('inputTokenContent');
        const promptText = document.getElementById('promptText');

        // 结果元素和Token显示 - 使用安全的元素获取方式
        const resultElements = {
            result1: document.getElementById('result1'),
            result2: document.getElementById('result2'),
            result3: document.getElementById('result3'),
            result4: document.getElementById('result4'),
            result5: document.getElementById('result5'),
            result6: document.getElementById('result6')
        };

        const resultTokenElements = {
            result1: document.getElementById('result1Tokens'),
            result2: document.getElementById('result2Tokens'),
            result3: document.getElementById('result3Tokens'),
            result4: document.getElementById('result4Tokens'),
            result5: document.getElementById('result5Tokens'),
            result6: document.getElementById('result6Tokens')
        };

        // 安全的DOM操作函数
        function safeAddClass(element, className) {
            if (element && className) {
                element.classList.add(className);
            }
        }
        function safeRemoveClass(element, className) {
            if (element && className) {
                element.classList.remove(className);
            }
        }
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function safeSetText(element, text) {
            if (element && text !== undefined) {
                element.textContent = text;
            }
        }

        function safeSetHtml(element, html) {
            if (element && html !== undefined) {
                element.innerHTML = html;
            }
        }

        function focusInputEnd() {
            if (!inputText) return;
            inputText.focus();
            const len = inputText.value ? inputText.value.length : 0;
            try { inputText.setSelectionRange(len, len); } catch (e) {}
        }

        function displayInputTokens(tokens) {
            if (!inputTokenContent) return;
            inputTokenContent.innerHTML = '';
            if (!tokens || !Array.isArray(tokens)) return;
            const frag = document.createDocumentFragment();
            tokens.forEach(t => {
                const span = document.createElement('span');
                span.className = 'px-2 py-1 bg-white border border-gray-200 rounded text-xs text-gray-700';
                span.textContent = t;
                frag.appendChild(span);
            });
            inputTokenContent.appendChild(frag);
        }

        function displayPrompt(text) {
            if (promptText) {
                promptText.textContent = text || '';
            }
        }

        const MATERIALS = {
            connectors: {
                '因果': ['因此', '所以', '因而', '於是'],
                '並列': ['同時', '此外', '而且', '並且'],
                '對比': ['然而', '但是', '相反地'],
                '時間': ['首先', '接著', '最後', '同時'],
                '舉例': ['例如', '像是', '比方說']
            },
            patterns: ['因為…所以…', '如果…那麼…', '不僅…還…', '先…再…', '總之…', '除了…還…'],
            rhetoric: ['比喻：像…一樣', '比喻：如同…', '擬人：…在微笑', '排比：…，…，…']
        };

        function copyText(text) {
            if (!text) return;
            try {
                navigator.clipboard.writeText(text);
                showSuccessMessage('已複製');
            } catch (e) {}
        }

        function toggleMaterial(resultId) {
            const el = document.getElementById('material-' + resultId);
            if (!el) return;
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                populateMaterials(resultId);
            } else {
                el.classList.add('hidden');
            }
        }

        function populateMaterials(resultId) {
            const connWrap = document.getElementById('connectors-' + resultId);
            const patWrap = document.getElementById('patterns-' + resultId);
            const rhetWrap = document.getElementById('rhetoric-' + resultId);
            const outlineWrap = document.getElementById('outline-' + resultId);
            const styleWordsWrap = document.getElementById('stylewords-' + resultId);
            const styleTemplatesWrap = document.getElementById('styletemplates-' + resultId);
            const styleAllusionsWrap = document.getElementById('styleallusions-' + resultId);
            const usageWrap = document.getElementById('usage-' + resultId);
            if (connWrap) {
                connWrap.innerHTML = '';
                const frag = document.createDocumentFragment();
                Object.keys(MATERIALS.connectors).forEach(cat => {
                    MATERIALS.connectors[cat].forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                        btn.textContent = item;
                        btn.onclick = () => copyText(item);
                        frag.appendChild(btn);
                    });
                });
                connWrap.appendChild(frag);
            }
            if (patWrap) {
                patWrap.innerHTML = '';
                const frag = document.createDocumentFragment();
                MATERIALS.patterns.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                    btn.textContent = item;
                    btn.onclick = () => copyText(item);
                    frag.appendChild(btn);
                });
                patWrap.appendChild(frag);
            }
            if (rhetWrap) {
                rhetWrap.innerHTML = '';
                const frag = document.createDocumentFragment();
                MATERIALS.rhetoric.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                    btn.textContent = item;
                    btn.onclick = () => copyText(item);
                    frag.appendChild(btn);
                });
                rhetWrap.appendChild(frag);
            }
            if (outlineWrap) {
                outlineWrap.innerHTML = '';
                const textEl = document.getElementById(resultId);
                const base = textEl ? textEl.textContent : '';
                const intro = '導入：' + (base || '主題引入');
                const body = '展開：此外，補充一個要點';
                const concl = '結論：因此，總結並呼應主題';
                [intro, body, concl].forEach(line => {
                    const div = document.createElement('div');
                    div.className = 'px-2 py-1 bg-white border border-gray-200 rounded';
                    div.textContent = line;
                    div.onclick = () => copyText(line);
                    outlineWrap.appendChild(div);
                });
            }
            const curriculumTipsWrap = document.getElementById('curriculumtips-' + resultId);
            if (curriculumTipsWrap) {
                curriculumTipsWrap.innerHTML = '';
                const phase = phaseSelect ? phaseSelect.value : 'senior';
                const tips = phase === 'elementary' ? DEFAULT_TIPS_ELEMENTARY : (phase === 'junior' ? DEFAULT_TIPS_JUNIOR : []);
                const frag = document.createDocumentFragment();
                tips.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                    btn.textContent = item;
                    btn.onclick = () => copyText(item);
                    frag.appendChild(btn);
                });
                curriculumTipsWrap.appendChild(frag);
            }
            if (usageWrap) {
                usageWrap.innerHTML = '';
                const phase = phaseSelect ? phaseSelect.value : 'senior';
                const frag = document.createDocumentFragment();
                if (resultId === 'result2' && phase === 'elementary') {
                    const list = getCurriculumElementary();
                    list.forEach(book => {
                        const tips = USAGE_GUIDE_ELEMENTARY[book] || ['描寫清楚主題','結合生活例子','語句簡潔自然'];
                        tips.forEach(t => {
                            const btn = document.createElement('button');
                            btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                            btn.textContent = book + '：' + t;
                            btn.onclick = () => copyText(btn.textContent);
                            frag.appendChild(btn);
                        });
                    });
                } else if (resultId === 'result3' && phase === 'junior') {
                    const list = getCurriculumJunior();
                    list.forEach(book => {
                        const tips = USAGE_GUIDE_JUNIOR[book] || ['語氣端正','結構清晰','修辭節制'];
                        tips.forEach(t => {
                            const btn = document.createElement('button');
                            btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                            btn.textContent = book + '：' + t;
                            btn.onclick = () => copyText(btn.textContent);
                            frag.appendChild(btn);
                        });
                    });
                } else if (resultId === 'result6' && (wenyanLevelSelect ? wenyanLevelSelect.value === 'senior' : true)) {
                    const styleKey = wenyanStyleSelect ? wenyanStyleSelect.value : 'none';
                    const tips = WENYAN_USAGE_GUIDE[styleKey] || [];
                    tips.forEach(t => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                        btn.textContent = t;
                        btn.onclick = () => copyText(t);
                        frag.appendChild(btn);
                    });
                }
                usageWrap.appendChild(frag);
            }
            // 文言風格專屬素材（僅 result6）
            if (resultId === 'result6') {
                const styleKey = wenyanStyleSelect ? wenyanStyleSelect.value : 'none';
                const styleObj = WENYAN_STYLE_RULES[styleKey] || { whitelist: [], templates: [], allowedAllusions: [] };
                if (styleWordsWrap) {
                    styleWordsWrap.innerHTML = '';
                    const frag = document.createDocumentFragment();
                    (styleObj.whitelist || []).forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                        btn.textContent = item;
                        btn.onclick = () => copyText(item);
                        frag.appendChild(btn);
                    });
                    styleWordsWrap.appendChild(frag);
                }
                if (styleTemplatesWrap) {
                    styleTemplatesWrap.innerHTML = '';
                    const frag = document.createDocumentFragment();
                    (styleObj.templates || []).forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                        btn.textContent = item;
                        btn.onclick = () => copyText(item);
                        frag.appendChild(btn);
                    });
                    styleTemplatesWrap.appendChild(frag);
                }
                if (styleAllusionsWrap) {
                    styleAllusionsWrap.innerHTML = '';
                    const frag = document.createDocumentFragment();
                    (styleObj.allowedAllusions || []).forEach(item => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-1 text-xs bg-white border border-gray-200 rounded hover:bg-gray-100';
                        btn.textContent = item;
                        btn.onclick = () => copyText(item);
                        frag.appendChild(btn);
                    });
                    styleAllusionsWrap.appendChild(frag);
                }
            }
        }

        function parseListInput(text) {
            if (!text) return [];
            return text.split(/[，、,\s]+/).map(s => s.trim()).filter(s => s.length > 0);
        }

        function getStoredArray(key, fallback) {
            try {
                const v = localStorage.getItem(key);
                if (!v) return fallback;
                let arr = [];
                try { arr = JSON.parse(v); } catch (e) { arr = parseListInput(v); }
                if (!Array.isArray(arr)) return fallback;
                return arr;
            } catch (e) { return fallback; }
        }

        function setStoredArray(key, arr) {
            try { localStorage.setItem(key, JSON.stringify(arr || [])); } catch (e) {}
        }

        const DEFAULT_WENYAN_ALLOWED = ['之','於','以','者','也','其','然','乃','故','且','若','或','雖','而','則','皆','亦','未','既','焉','乎','矣'];
        const DEFAULT_WENYAN_COMMON = ['心','志','學','行','善','理','友','師','家','書','路','山','水','日','夜','風','雨','笑','悲','思','求'];
        const DEFAULT_WENYAN_BANNED = ['曩','踽','黼黻','囹圄','觥籌','蹁躚','斫輪','齏','赬','罔'];
        const DEFAULT_CURRICULUM_ELEMENTARY = ['靜夜思','登鸛雀樓','成語故事'];
        const DEFAULT_CURRICULUM_JUNIOR = ['兒時記趣','五柳先生傳','陋室銘'];
        const DEFAULT_TIPS_ELEMENTARY = ['白日依山盡，黃河入海流。','床前明月光，疑是地上霜。','千山鳥飛絕，萬徑人蹤滅。','月落烏啼霜滿天。','慈母手中線，遊子身上衣。','鋤禾日當午，汗滴禾下土。'];
        const DEFAULT_TIPS_JUNIOR = ['山不在高，有仙則名；水不在深，有龍則靈。','談笑有鴻儒，往來無白丁。','不求甚解；每有會意，便欣然忘食。','出淤泥而不染，濯清漣而不妖。','學而時習之，不亦說乎。','吾日三省吾身。','忽有龐然大物，拔山倒樹而來。'];
        const USAGE_GUIDE_ELEMENTARY = {
            '成語故事': ['用成語解釋情境','舉例生活應用','延伸寓意'],
            '靜夜思': ['改寫為白話描寫','連結生活感受','加入比喻語句'],
            '登鸛雀樓': ['描述景物變化','引出感悟','以總結收束']
        };
        const USAGE_GUIDE_JUNIOR = {
            '兒時記趣': ['回憶片段組織','細節刻畫','情感克制收束'],
            '五柳先生傳': ['自我品德描寫','淡泊生活對比','語氣平實'],
            '陋室銘': ['排比句式運用','比喻說理','主旨鮮明收束']
        };
        const WENYAN_USAGE_GUIDE = {
            none: ['選擇風格後顯示用法'],
            chibi: ['景物先行情志後述','比喻排比搭配','典故點到為止'],
            xiangjixuan: ['物件細節帶情','懷舊敘述克制','家室詞彙呼應'],
            hongmen: ['史傳語氣敘事','人物權謀暗示','語句凝練'],
            chushibiao: ['提出忠誠責任','奏表語氣端正','以不敢不收束'],
            shishuo: ['明確論點','層遞例證','以是故收束'],
            taohuayuan: ['建構理想境','景物清新簡約','語氣平淡有致'],
            quraanke: ['情節緊湊推進','果決語氣','少冗贅敘述'],
            wanliu: ['光影與心境互映','閒適幽雅語調','景物細描'],
            laoshan: ['鋪陳神怪','諷刺意味隱含','結尾不明說'],
            dazhongxiaokang: ['對比兩種理想','語義端正','結構分明'],
            jianzhuke: ['設問反詰','主張包容人才','論辯層次'],
            quanhelun: ['倡和止鬥','以善相勸','語義平正'],
            luguang: ['昔今對比','地景人事滄桑','語氣沉著'],
            huaju: ['女性視角自陳','性情描寫','語氣婉約不柔弱']
        };

        const WENYAN_STYLE_RULES = {
            none: { desc: '', whitelist: [], templates: [], allowedAllusions: [], allusionMax: 0 },
            chibi: {
                desc: '典雅景象描寫；情志感懷而不哀傷過度；可用比喻與排比，語勢舒暢。',
                whitelist: ['江風','月色','清風','明月','長空','江上','客','舟','煙波','故人'],
                templates: ['見……而感……','清風徐來，……','念及往事，……','乃知……之可貴'],
                allowedAllusions: ['赤壁','周郎','東風','烏林','江上客'],
                allusionMax: 1
            },
            xiangjixuan: {
                desc: '親情敘述，懷舊氛圍；家室細節與物件描寫；情感克制而真切。',
                whitelist: ['庭','舍','室','案','燭','影','書','親','祖','童時'],
                templates: ['憶昔……，今則……','念親恩而不敢忘','室中……，猶在目','因……而悟……'],
                allowedAllusions: [],
                allusionMax: 0
            },
            hongmen: {
                desc: '史傳語氣；人物心機與權謀暗示；敘事清楚，語句凝練。',
                whitelist: ['謀','計','權','客','主人','宴','席','兵','劍','心'],
                templates: ['是時……','其人……，貌恭而意不平','乃置……於座','終以……而定'],
                allowedAllusions: ['鴻門','項羽','劉邦','范增','張良'],
                allusionMax: 0
            },
            chushibiao: {
                desc: '奏表體；忠誠、責任與憂懼；語氣恭敬，詞義端正。',
                whitelist: ['陳','表','臣','誠','憂','責','願','敢','以','是'],
                templates: ['臣以為……','竊以為……','是以……','不敢不……'],
                allowedAllusions: [],
                allusionMax: 0
            },
            shishuo: {
                desc: '設論與論證；中心論點明確；例證、層遞、對比。',
                whitelist: ['師','道','學','教','生','友','問','答','故','然'],
                templates: ['夫……者，……也','故曰……','若……，則……','是故……'],
                allowedAllusions: [],
                allusionMax: 0
            },
            taohuayuan: {
                desc: '理想鄉意象；景物清新簡約；語氣平淡而有致。',
                whitelist: ['花','源','溪','林','村','田','人','居','樂','淨'],
                templates: ['有……之境','人居其中，……','不知……之所在','遂……'],
                allowedAllusions: ['桃花源','武陵人'],
                allusionMax: 0
            },
            quraanke: {
                desc: '傳奇俠義；情節緊湊；語氣果決，少冗贅。',
                whitelist: ['俠','劍','行','義','客','道','夜','疾','救','助'],
                templates: ['忽聞……','乃拔劍而……','不顧……','終成……'],
                allowedAllusions: [],
                allusionMax: 0
            },
            wanliu: {
                desc: '性靈審美；閒適幽雅；景物的光影、月色與心境互映。',
                whitelist: ['月','橋','風','柳','影','水','波','晚','閒','靜'],
                templates: ['晚遊於……','月上……','風過……而……','心與景相契'],
                allowedAllusions: ['六橋','西湖'],
                allusionMax: 0
            },
            laoshan: {
                desc: '諷刺神怪；語帶機鋒；結尾含義隱而不明說。',
                whitelist: ['道','士','異','幻','術','笑','人','市','事','怪'],
                templates: ['有術者……','人皆信之，……','卒以……知其妄','其意可悟而不言'],
                allowedAllusions: ['勞山','道士'],
                allusionMax: 0
            },
            dazhongxiaokang: {
                desc: '政治理想對比；語義端正；結構分明。',
                whitelist: ['大同','小康','仁','義','民','治','法','德','事','業'],
                templates: ['夫大同者……','小康則……','然……與……異','是以……為上'],
                allowedAllusions: ['大同','小康'],
                allusionMax: 0
            },
            jianzhuke: {
                desc: '論辯風格；設問與反詰；包容人才的主張。',
                whitelist: ['客','逐','主','國','利','害','才','用','納','拒'],
                templates: ['夫逐客何利？','若納之，則……','拒之，則……','故不如……'],
                allowedAllusions: ['逐客'],
                allusionMax: 0
            },
            quanhelun: {
                desc: '台灣族群視角；倡和而止鬥；語義平正。',
                whitelist: ['族','和','鬥','民','鄉','里','善','止','議','同'],
                templates: ['倡和而止鬥','以善相勸','共保……','終歸……'],
                allowedAllusions: [],
                allusionMax: 0
            },
            luguang: {
                desc: '台灣歷史情懷；地景與人事滄桑；語氣沉著。',
                whitelist: ['鹿港','桴','潮','市','舟','商','衰','昔','今','人'],
                templates: ['乘桴而……','視市中……','昔盛而今衰','感其變而……'],
                allowedAllusions: ['鹿港'],
                allusionMax: 0
            },
            huaju: {
                desc: '女性視角；性情描寫；語氣婉約而不柔弱。',
                whitelist: ['菊','筆','墨','志','心','性','清','雅','自','序'],
                templates: ['畫菊以誌心','不以俗誘','性情自陳','於……見其志'],
                allowedAllusions: ['畫菊'],
                allusionMax: 0
            }
        };

        function getWenyanAllowed() { return getStoredArray('wenyan_allowed', DEFAULT_WENYAN_ALLOWED); }
        function getWenyanCommon() { return getStoredArray('wenyan_common', DEFAULT_WENYAN_COMMON); }
        function getWenyanBanned() { return getStoredArray('wenyan_banned', DEFAULT_WENYAN_BANNED); }
        function getCurriculumElementary() { return getStoredArray('curriculum_elementary', DEFAULT_CURRICULUM_ELEMENTARY); }
        function getCurriculumJunior() { return getStoredArray('curriculum_junior', DEFAULT_CURRICULUM_JUNIOR); }

        function openWenyanManager() {
            if (!wenyanManager) return;
            const a = getWenyanAllowed();
            const c = getWenyanCommon();
            const b = getWenyanBanned();
            if (wenyanAllowedInput) wenyanAllowedInput.value = a.join('、');
            if (wenyanCommonInput) wenyanCommonInput.value = c.join('、');
            if (wenyanBannedInput) wenyanBannedInput.value = b.join('、');
            safeRemoveClass(wenyanManager, 'hidden');
        }

        function closeWenyanManager() {
            if (!wenyanManager) return;
            safeAddClass(wenyanManager, 'hidden');
        }

        function saveWenyanLists() {
            const a = parseListInput(wenyanAllowedInput ? wenyanAllowedInput.value : '');
            const c = parseListInput(wenyanCommonInput ? wenyanCommonInput.value : '');
            const b = parseListInput(wenyanBannedInput ? wenyanBannedInput.value : '');
            setStoredArray('wenyan_allowed', a.length ? a : DEFAULT_WENYAN_ALLOWED);
            setStoredArray('wenyan_common', c.length ? c : DEFAULT_WENYAN_COMMON);
            setStoredArray('wenyan_banned', b.length ? b : DEFAULT_WENYAN_BANNED);
            showSuccessMessage('已保存文言詞表');
            closeWenyanManager();
        }

        function openCurriculumManager() {
            if (!curriculumManager) return;
            const e = getCurriculumElementary();
            const j = getCurriculumJunior();
            if (elementaryCurriculumInput) elementaryCurriculumInput.value = e.join('、');
            if (juniorCurriculumInput) juniorCurriculumInput.value = j.join('、');
            safeRemoveClass(curriculumManager, 'hidden');
        }

        function closeCurriculumManager() {
            if (!curriculumManager) return;
            safeAddClass(curriculumManager, 'hidden');
        }

        function saveCurriculumLists() {
            const e = parseListInput(elementaryCurriculumInput ? elementaryCurriculumInput.value : '');
            const j = parseListInput(juniorCurriculumInput ? juniorCurriculumInput.value : '');
            setStoredArray('curriculum_elementary', e.length ? e : DEFAULT_CURRICULUM_ELEMENTARY);
            setStoredArray('curriculum_junior', j.length ? j : DEFAULT_CURRICULUM_JUNIOR);
            showSuccessMessage('已保存教材清單');
            closeCurriculumManager();
        }

        // 初始化 - 确保DOM完全加载后再执行
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM完全加载，初始化应用...');
            
            // 加载保存的API Key
            loadSavedApiKey();
            
            // 添加事件监听器 - 使用安全的方式
            if (clearBtn) clearBtn.addEventListener('click', clearInput);
            if (voiceBtn) voiceBtn.addEventListener('click', toggleVoiceInput);
            if (copyAllBtn) copyAllBtn.addEventListener('click', copyAllResults);
            if (newAnalysisBtn) newAnalysisBtn.addEventListener('click', resetForm);
            if (saveApiKeyCheckbox) saveApiKeyCheckbox.addEventListener('change', saveApiKeyIfChecked);
            if (inputText) inputText.addEventListener('input', updateTokenCounter);
            if (wenyanLevelSelect) {
                const toggleStyle = () => {
                    if (wenyanStyleSelect) {
                        if (wenyanLevelSelect.value === 'senior') {
                            safeRemoveClass(wenyanStyleSelect, 'hidden');
                        } else {
                            safeAddClass(wenyanStyleSelect, 'hidden');
                        }
                    }
                };
                wenyanLevelSelect.addEventListener('change', toggleStyle);
                toggleStyle();
            }

            function applyPhaseLabels() {
                const phase = phaseSelect ? phaseSelect.value : 'senior';
                const t2 = document.getElementById('result2Title');
                const t3 = document.getElementById('result3Title');
                const t6 = document.getElementById('result6Title');
                if (phase === 'elementary') {
                    if (t2) t2.textContent = '白話文／兒童文學版';
                    if (t3) t3.textContent = '描寫文（描寫）版';
                    if (t6) t6.textContent = '高中文言文（風格可選）';
                    if (wenyanLevelSelect) wenyanLevelSelect.value = 'senior';
                } else if (phase === 'junior') {
                    if (t2) t2.textContent = '記敘文（敘事）版';
                    if (t3) t3.textContent = '國中文言文散文';
                    if (t6) t6.textContent = '高中文言文（風格可選）';
                    if (wenyanLevelSelect) wenyanLevelSelect.value = 'senior';
                } else {
                    if (t2) t2.textContent = '記敘文（敘事）版';
                    if (t3) t3.textContent = '描寫文（描寫）版';
                    if (t6) t6.textContent = '高中文言文（風格可選）';
                    if (wenyanLevelSelect) wenyanLevelSelect.value = 'senior';
                }
                // 同步風格顯示
                const ev = new Event('change');
                if (wenyanLevelSelect) wenyanLevelSelect.dispatchEvent(ev);
            }
            if (phaseSelect) {
                phaseSelect.addEventListener('change', applyPhaseLabels);
                applyPhaseLabels();
            }
            if (wenyanStyleSelect) {
                wenyanStyleSelect.addEventListener('change', () => populateMaterials('result6'));
            }
            
            // 初始更新Token计数器
            updateTokenCounter();
            
            console.log('应用初始化完成');
        });

        // 分析文本 - 确保每次点击都重新计算
        async function analyzeText(event) {
            if (event) event.preventDefault();
            
            // 防止重复提交
            if (isAnalyzing) return;
            
            console.log('开始分析文本...');
            
            try {
                const apiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
                const textToAnalyze = inputText ? inputText.value.trim() : '';
                
                // 验证输入
                if (!apiKey) {
                    showError('請輸入您的DeepSeek API Key', 'API Key 是調用DeepSeek服務的必要條件');
                    return;
                }
                
                if (!textToAnalyze) {
                    showError('請輸入要潤色修飾的內容', '請在輸入框中輸入小學生的原始表達');
                    return;
                }
                
                // 检查Token数
                const inputTokensArr = tokenizeInput(textToAnalyze);
                const inputTokenCount = inputTokensArr.length;
                if (inputTokenCount > MAX_TOKENS) {
                    showError(`輸入內容太長 (目前${inputTokenCount} tokens)`, 
                              `請簡化至${MAX_TOKENS} tokens以內，避免API調用失敗`);
                    return;
                }
                
                // 设置分析状态
                isAnalyzing = true;
                if (analyzeBtn) {
                    analyzeBtn.disabled = true;
                    safeSetHtml(analyzeBtn, '<i class="fa fa-spinner fa-spin mr-2"></i>分析中...');
                }
                
                // 清理旧数据和状态
                clearPreviousData();
                
                // 显示处理状态
                showProcessingStatus();
                
                // 记录API调用开始时间
                apiCallStartTime = Date.now();
                
                // 准备API请求
                const model = modelSelect ? modelSelect.value : 'deepseek-chat';
                const prompt = createExpertPrompt(textToAnalyze, inputTokensArr);
                
                console.log('准备调用API，输入Token数:', inputTokenCount);
                console.log('使用的提示词:', prompt);
                displayPrompt(prompt);
                console.log('使用的模型:', model);
                
                // 调用实际的DeepSeek API
                const apiResult = await callDeepSeekApi(apiKey, model, prompt, textToAnalyze, inputTokenCount);
                
                // 计算API响应时间
                const responseTime = Date.now() - apiCallStartTime;
                console.log(`API调用成功，响应时间: ${responseTime}ms，结果:`, apiResult);
                
                // 显示API状态和详细统计
                displayInputTokens(inputTokensArr);
                showApiStatus(true, apiResult.tokenStats, model, responseTime);
                
                // 显示结果
                displayResults(apiResult.results, apiResult.tokenStats);
                ['result1','result2','result3','result4','result5','result6'].forEach(populateMaterials);
                speakResultsSequential(['result1','result2','result3','result4','result5']);
                
            } catch (error) {
                console.error('分析錯誤:', error);
                
                // 计算API响应时间（即使失败）
                const responseTime = Date.now() - apiCallStartTime;
                
                // 显示错误状态
                showApiStatus(false, { 
                    error: error.message || '未知錯誤',
                    details: error.stack || ''
                }, modelSelect ? modelSelect.value : 'deepseek-chat', responseTime);
                
                // 显示错误信息
                showError(
                    error.message || '分析過程中發生錯誤',
                    error.stack || '請檢查您的API Key和網絡連接'
                );
                
            } finally {
                // 恢复按钮状态
                isAnalyzing = false;
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    safeSetHtml(analyzeBtn, '<i class="fa fa-bullseye mr-2"></i>DeepSeek 分析');
                }
                
                // 隐藏处理状态
                hideProcessingStatus();
                
                console.log('分析完成');
            }
        }

        // 调用实际的DeepSeek API
        async function callDeepSeekApi(apiKey, model, prompt, originalText, inputTokenCount) {
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: '你是專業的小學生語言潤色修飾專家，所有輸出必須使用繁體中文（臺灣用字），不得使用簡體字或簡化標點。' },
                            { role: 'user', content: prompt }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });
                if (!response.ok) {
                    let errorData = {};
                    try { errorData = await response.json(); } catch (e) {}
                    const message = (errorData && errorData.error && errorData.error.message) ? errorData.error.message : 'API調用失敗';
                    throw new Error(`${response.status} ${response.statusText}: ${message}`);
                }
                const data = await response.json();
                const content = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content : '';
                const results = parseResults(content);
                const analysis = parseAnalysis(content);
                const { resultTokenCounts, totalOutputTokens } = calculateResultTokens(results);
                const promptTokens = (data && data.usage && typeof data.usage.prompt_tokens === 'number') ? data.usage.prompt_tokens : 0;
                const completionTokens = (data && data.usage && typeof data.usage.completion_tokens === 'number') ? data.usage.completion_tokens : totalOutputTokens;
                const totalTokens = (data && data.usage && typeof data.usage.total_tokens === 'number') ? data.usage.total_tokens : (promptTokens + completionTokens);
                return {
                    results,
                    analysis,
                    tokenStats: {
                        promptTokens: promptTokens,
                        inputTokens: inputTokenCount || 0,
                        totalInputTokens: promptTokens + (inputTokenCount || 0),
                        outputTokens: completionTokens,
                        total: totalTokens,
                        resultTokenCounts
                    }
                };
            } catch (error) {
                console.error('DeepSeek API调用错误:', error);
                throw error;
            }
        }

        // 创建专家级提示词 - 严格遵循5大优化规则
        function createExpertPrompt(text, tokens) {
            const tokenLine = (tokens && Array.isArray(tokens)) ? tokens.join(' ') : '';
            const wenyanAllowed = getWenyanAllowed().join('、');
            const wenyanCommon = getWenyanCommon().join('、');
            const wenyanBanned = getWenyanBanned().join('、');
            const wenyanLevel = wenyanLevelSelect ? wenyanLevelSelect.value : 'senior';
            const wenyanStyle = wenyanStyleSelect ? wenyanStyleSelect.value : 'none';
            const wenyanStyleText = WENYAN_STYLE_RULES[wenyanStyle] || '';
            const styleObj = WENYAN_STYLE_RULES[wenyanStyle] || { whitelist: [], templates: [], allowedAllusions: [], allusionMax: 0 };
            const elementaryList = getCurriculumElementary().join('、');
            const juniorList = getCurriculumJunior().join('、');
            const phase = phaseSelect ? phaseSelect.value : 'senior';
            const wenyanLevelRules = '（高中）遵循108課綱；可用常見虛詞；禁用校本生僻字；不過度用典；文言與白話各≤50字。';
            const levelRefLine = '';
            const curriculumLine = '';
            return `
                # 小學生語言潤色修飾專家系統 - 嚴格遵循5大規則
                
                ## 任務說明
                您是專業的小學生語言潤色修飾專家，需要將小學生的原始口語表達轉化為標準、自然、生動的口語表達。
                
                ## 原始內容
                ${text}
                
                ## 輸入 token 序列（供理解用）
                ${tokenLine}
                
                ## 核心優化規則（必須嚴格遵守）
                - 調整語序，使語句通順（如「爬山今天」→「今天爬山」）
                - 補全用詞，說清楚意思（如「困難更的」→「更困難的山路」）
                - 保持口語化與簡單詞彙，適合小學生
                - 情緒合理，與內容相符（如期待、開心等）
                - 100個字以內，易懂
                - 必須嚴格符合輸入字詞的原意，不改變指涉對象、事件順序或因果邏輯
                - 在內部思考中完成：意圖識別、語意分析、同音不同義的辨識；請將這些考量融入輸出句子，但不要輸出分析文本
                - 用字規範：所有輸出一律使用繁體中文（臺灣用字），不得使用簡體字或簡化標點

                ## 108課綱對齊標準（內部遵循，不輸出說明）
                - 邏輯連貫：因果、並列、轉折清晰，主旨一致
                - 語彙適切：避免艱深詞，選用可理解、年段適配的詞彙
                - 修辭恰當：不浮誇，服務於意義與情感（比喻、擬人、排比）
                - 結構清楚：句子完整、指涉一致、時態一致
                - 文體意識：敘事／描寫／議論／文言等各版遵循相應規則
                - 標點正確：中文標點使用得當，避免長句拖沓
                
                ## 輸出要求（僅文本，六行）
                - 第一行：最佳／推薦講法（最口語化、最自然），僅輸出純文字一句話；必須完整表述，包含主語+動詞+賓語，並在可用時加入時間／地點／感受或目的；不得使用片段或省略號；以「。」結尾；若缺主語，以「我」補足
                - 第二行：${phase === 'elementary' ? '白話文／兒童文學版' : '記敘文（敘事）版'}，僅輸出純文字一句話；滿足：
                  定義：以記人、敘事、寫景、狀物為主要內容，透過具體事件表達情感或道理。
                  六要素：時間、地點、人物、事件（起因、經過、結果）。
                  表達方式：以敘述為主，輔以描寫、抒情。
                  目的：透過故事感染讀者，傳遞情感或啟示。
                - 第三行：${phase === 'junior' ? '國中文言文散文' : '描寫文（描寫）版'}，僅輸出純文字一句話；滿足：
                  定義：以描寫為主要表達方式，生動描繪人物、景物、場景等，使讀者產生直觀感受。
                  表達方式：正面描寫（直接描述特徵）、側面描寫（以周圍事物烘托主體）、細節描寫（捕捉微小特徵增強真實感）。
                - 第四行：議論文「總-分-總」版，使用2–3短句完成：
                  總述（立場/觀點）→ 分述（2–3個簡潔要點）→ 總結（重申並呼應），整體不浮誇、邏輯清晰、嚴格保留原意
                - 第五行：作文（寫作方式）版，以敘述+描寫提升文采但不浮誇；必含一個場景描寫與一個比喻；適度運用意象與細節、節奏控制與轉折；嚴格保留原意；僅輸出純文字一句話
                - 第六行：${phase === 'senior' ? '高中文言文（可選風格）' : '文言文版'}，格式：文言一句｜白話解釋一句（僅一行）；滿足：
                以淺易文言表達原意；語氣典雅精煉；嚴格保留原意；規則如下：
                  可用字表（校本優先）：${wenyanAllowed}
                  可用常用詞（校本）：${wenyanCommon}
                  禁用字表（校本）：${wenyanBanned}
                  禁用：過於艱澀典故或冷僻成語，不得改變原意。
                  等級規則：${wenyanLevelRules}
                  風格偏向：${wenyanStyle === 'none' ? '不指定' : wenyanStyle}；${styleObj.desc || ''}
                風格用字白名單：${(styleObj.whitelist && styleObj.whitelist.length) ? styleObj.whitelist.join('、') : '（無）'}
                允許典故清單：${(styleObj.allowedAllusions && styleObj.allowedAllusions.length) ? styleObj.allowedAllusions.join('、') : '（無）'}（只可使用清單內典故）
                典故上限（風格）：${(typeof styleObj.allusionMax === 'number') ? styleObj.allusionMax : 0}（不可超出；未列清單者不得使用）
                句式模板（參考）：${(styleObj.templates && styleObj.templates.length) ? styleObj.templates.join(' ｜ ') : '（無）'}
                ${levelRefLine}
                ${curriculumLine}
                禁止：直接引用或仿作原文句，需用原意自行表述。
            - 第六行必須包含分隔符號「｜」，前為文言句、後為白話解釋，兩段皆不得留空；若未包含，請立即補全並重新輸出
            - 在內部選擇恰當連接詞（因此、此外、然而、首先、例如等）與修辭（比喻、擬人、排比），並融入輸出句子
                - 嚴格遵守：恰好六行、每行一句話、六行均不得留空、不得輸出任何額外說明或標題
            - 不要使用JSON或任何結構化格式；不要輸出標題、編號或分析內容
            `.trim();
        }

        // 清理之前的数据和状态
        function clearPreviousData() {
            console.log('清理旧数据...');
            
            // 清除结果区域内容并添加加载占位符
            for (const key in resultElements) {
                if (resultElements[key]) {
                    safeSetHtml(resultElements[key], 
                        '<span class="loading-shimmer inline-block w-full h-6 bg-gray-200 rounded"></span>');
                }
                if (resultTokenElements[key]) {
                    safeSetText(resultTokenElements[key], '計算中...');
                }
                if (resultTokenCountElements[key]) {
                    safeSetText(resultTokenCountElements[key], '0');
                }
            }
            
            // 隐藏结果区域和统计信息
            safeAddClass(resultArea, 'hidden');
            safeAddClass(apiStatus, 'hidden');
            safeAddClass(detailedTokenStats, 'hidden');
            
            // 隐藏错误提示
            hideError();
            if (manageWenyanBtn) manageWenyanBtn.addEventListener('click', openWenyanManager);
            if (saveWenyanBtn) saveWenyanBtn.addEventListener('click', saveWenyanLists);
            if (closeWenyanBtn) closeWenyanBtn.addEventListener('click', closeWenyanManager);
            if (manageCurriculumBtn) manageCurriculumBtn.addEventListener('click', openCurriculumManager);
            if (saveCurriculumBtn) saveCurriculumBtn.addEventListener('click', saveCurriculumLists);
            if (closeCurriculumBtn) closeCurriculumBtn.addEventListener('click', closeCurriculumManager);
        }

        // 显示API状态 - 增强版
        function showApiStatus(success, tokenStatsData, model, responseTime) {
            console.log('显示API状态:', success, tokenStatsData, model, responseTime);
            
            if (!apiStatus) return;
            
            if (success && tokenStatsData) {
                // 成功状态
                if (statusIcon) {
                    safeSetText(statusIcon.className, 'fa fa-check-circle text-success text-2xl');
                }
                if (statusIconWrapper) {
                    safeSetText(statusIconWrapper.className, 'w-12 h-12 rounded-full bg-success/10 flex items-center justify-center mr-4');
                }
                if (statusTitle) {
                    safeSetText(statusTitle.className, 'font-bold text-success text-lg');
                    safeSetText(statusTitle, 'API 調用成功');
                }
                if (statusMessage) {
                    safeSetText(statusMessage, `已成功獲取DeepSeek分析結果 (${tokenStatsData.total} tokens)｜已套用108課綱標準`);
                }
                if (apiResponseTime && responseTime !== undefined) {
                    safeSetText(apiResponseTime, `<i class="fa fa-clock-o mr-1"></i>響應時間: ${responseTime}ms`);
                }
                if (apiModelUsed && model) {
                    safeSetText(apiModelUsed, `<i class="fa fa-server mr-1"></i>模型: ${model}`);
                }
                if (totalTokensDisplay) {
                    safeSetText(totalTokensDisplay, tokenStatsData.total);
                }
                
                // 更新详细Token统计
                if (inputTokens) safeSetText(inputTokens, tokenStatsData.totalInputTokens || 0);
                if (outputTokens) safeSetText(outputTokens, tokenStatsData.outputTokens || 0);
                if (totalTokensCount) safeSetText(totalTokensCount, tokenStatsData.total || 0);
                
                // 更新每结果Token统计
                if (tokenStatsData.resultTokenCounts) {
                    for (const key in resultTokenCountElements) {
                        if (resultTokenCountElements[key] && tokenStatsData.resultTokenCounts[key]) {
                            safeSetText(resultTokenCountElements[key], tokenStatsData.resultTokenCounts[key]);
                        }
                    }
                }
                
                // 显示统计信息
                safeRemoveClass(detailedTokenStats, 'hidden');
                
            } else {
                // 失败状态
                if (statusIcon) {
                    safeSetText(statusIcon.className, 'fa fa-times-circle text-danger text-2xl');
                }
                if (statusIconWrapper) {
                    safeSetText(statusIconWrapper.className, 'w-12 h-12 rounded-full bg-danger/10 flex items-center justify-center mr-4');
                }
                if (statusTitle) {
                    safeSetText(statusTitle.className, 'font-bold text-danger text-lg');
                    safeSetText(statusTitle, 'API 調用失敗');
                }
                if (statusMessage) {
                    safeSetText(statusMessage, tokenStatsData.error || '無法連接DeepSeek API');
                }
                if (apiResponseTime && responseTime !== undefined) {
                    safeSetText(apiResponseTime, `<i class="fa fa-clock-o mr-1"></i>響應時間: ${responseTime}ms`);
                }
                if (apiModelUsed && model) {
                    safeSetText(apiModelUsed, `<i class="fa fa-server mr-1"></i>模型: ${model}`);
                }
                if (totalTokensDisplay) {
                    safeSetText(totalTokensDisplay, '錯誤');
                }
                
                // 隐藏详细统计信息
                safeAddClass(detailedTokenStats, 'hidden');
            }
            
            // 显示状态区域
            safeRemoveClass(apiStatus, 'hidden');
            
            // 滚动到状态区域
            if (apiStatus) {
                apiStatus.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 更新Token计数器
        function updateTokenCounter() {
            const text = inputText ? inputText.value.trim() : '';
            const tokenCount = estimateTokenCount(text);
            
            if (tokenCounter) {
                safeSetText(tokenCounter, `${tokenCount} / ${MAX_TOKENS} tokens`);
                
                // 根据Token数改变颜色 - 使用安全的方式
                safeRemoveClass(tokenCounter, 'text-red-500', 'text-yellow-500', 'text-gray-500', 'font-bold');
                
                if (tokenCount > MAX_TOKENS) {
                    safeAddClass(tokenCounter, 'text-red-500', 'font-bold');
                } else if (tokenCount > MAX_TOKENS * 0.8) {
                    safeAddClass(tokenCounter, 'text-yellow-500', 'font-bold');
                } else {
                    safeAddClass(tokenCounter, 'text-gray-500');
                }
            }
        }

        // 加载保存的API Key
        function loadSavedApiKey() {
            try {
                const savedApiKey = localStorage.getItem('deepseekApiKey');
                if (savedApiKey && apiKeyInput) {
                    apiKeyInput.value = savedApiKey;
                    if (saveApiKeyCheckbox) {
                        saveApiKeyCheckbox.checked = true;
                    }
                }
            } catch (error) {
                console.error('加载API Key失败:', error);
            }
        }

        // 保存API Key（如果勾选）
        function saveApiKeyIfChecked() {
            try {
                if (saveApiKeyCheckbox && saveApiKeyCheckbox.checked && apiKeyInput) {
                    localStorage.setItem('deepseekApiKey', apiKeyInput.value);
                } else {
                    localStorage.removeItem('deepseekApiKey');
                }
            } catch (error) {
                console.error('保存API Key失败:', error);
            }
        }

        // 估算Token数（简单实现）
        function tokenizeInput(text) {
            const tokens = [];
            if (!text) return tokens;
            let i = 0;
            while (i < text.length) {
                const ch = text[i];
                const code = ch.charCodeAt(0);
                const isCJK = (code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF) || (code >= 0x20000 && code <= 0x2A6DF) || (code >= 0x2A700 && code <= 0x2B73F) || (code >= 0x2B740 && code <= 0x2B81F) || (code >= 0x2B820 && code <= 0x2CEAF) || (code >= 0xF900 && code <= 0xFAFF) || (code >= 0x2F800 && code <= 0x2FA1F);
                const isLetter = /[A-Za-z]/.test(ch);
                const isDigit = /[0-9]/.test(ch);
                const isSpace = /\s/.test(ch);
                if (isSpace) { i++; continue; }
                if (isCJK) { tokens.push(ch); i++; continue; }
                if (isLetter || isDigit) {
                    let start = i;
                    i++;
                    while (i < text.length && /[A-Za-z0-9]/.test(text[i])) i++;
                    tokens.push(text.slice(start, i));
                    continue;
                }
                tokens.push(ch);
                i++;
            }
            return tokens;
        }

        function estimateTokenCount(text) {
            return tokenizeInput(text).length;
        }

        // 计算结果的Token数
        function calculateResultTokens(results) {
            let totalOutputTokens = 0;
            const resultTokenCounts = {};
            
            if (results && Array.isArray(results)) {
                results.forEach((result, index) => {
                    const tokenCount = estimateTokenCount(result);
                    resultTokenCounts[`result${index + 1}`] = tokenCount;
                    totalOutputTokens += tokenCount;
                });
            }
            
            return {
                resultTokenCounts,
                totalOutputTokens
            };
        }

        function parseResults(content) {
            if (!content || typeof content !== 'string') return ['','','','','',''];
            let best = '';
            let creative = '';
            let literacy = '';
            let essay = '';
            let writing = '';
            let wenyan = '';
            try {
                const obj = JSON.parse(content);
                if (obj && Array.isArray(obj.results)) {
                    best = String(obj.results[0] || '').trim();
                    creative = String(obj.results[1] || '').trim();
                    literacy = String(obj.results[2] || '').trim();
                    essay = String(obj.results[3] || '').trim();
                    writing = String(obj.results[4] || '').trim();
                    wenyan = String(obj.results[5] || '').trim();
                }
            } catch (e) {}
            if (!best || !creative || !literacy || !essay || !writing || !wenyan) {
                const lines = content.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
                if (!best && lines.length > 0) {
                    best = lines[0].replace(/^\d+[\.\) 、]/, '').trim();
                }
                if (!creative && lines.length > 1) {
                    creative = lines[1].replace(/^\d+[\.\) 、]/, '').trim();
                }
                if (!literacy && lines.length > 2) {
                    literacy = lines[2].replace(/^\d+[\.\) 、]/, '').trim();
                }
                if (!essay && lines.length > 3) {
                    essay = lines[3].replace(/^\d+[\.\) 、]/, '').trim();
                }
                if (!writing && lines.length > 4) {
                    writing = lines[4].replace(/^\d+[\.\) 、]/, '').trim();
                }
                if (!wenyan && lines.length > 5) {
                    wenyan = lines[5].replace(/^\d+[\.\) 、]/, '').trim();
                }
            }
            if (!best) best = '';
            if (!creative) creative = '';
            if (!literacy) literacy = '';
            if (!essay) essay = '';
            if (!writing) writing = '';
            if (!wenyan) wenyan = '';
            return [best, creative, literacy, essay, writing, wenyan];
        }

        function parseAnalysis(content) {
            const result = { intent: '', semantic: '', homophone: '' };
            if (!content || typeof content !== 'string') return result;
            const lines = content.split(/\r?\n/).map(s => s.trim());
            lines.forEach(l => {
                if (/^意圖\s*[:：]/.test(l)) {
                    result.intent = l.replace(/^意圖\s*[:：]\s*/, '');
                } else if (/^語意分析\s*[:：]/.test(l)) {
                    result.semantic = l.replace(/^語意分析\s*[:：]\s*/, '');
                } else if (/^同音不同義辨識\s*[:：]/.test(l)) {
                    result.homophone = l.replace(/^同音不同義辨識\s*[:：]\s*/, '');
            }

            if ('serviceWorker' in navigator) {
                try { navigator.serviceWorker.register('./sw.js'); } catch (e) {}
            }
        });
            return result;
        }

        // 显示结果
        function displayResults(results, tokenStatsData) {
            console.log('显示结果:', results, tokenStatsData);
            
            if (!results || !Array.isArray(results) || results.length === 0) {
                showError('未獲取到有效的潤色修飾結果', 'API返回的結果格式不正確，請重試');
                return;
            }
            
            const displayArr = [...results];
            while (displayArr.length < 6) displayArr.push('');
            for (let i = 0; i < 6; i++) {
                const resultId = `result${i + 1}`;
                if (resultElements[resultId]) {
                    const val = displayArr[i] || '無結果';
                    if (resultId === 'result6') {
                        const hasSep = val.indexOf('｜') !== -1;
                        let wenyan = '';
                        let gloss = '';
                        if (hasSep) {
                            const parts = val.split('｜');
                            wenyan = parts[0] ? parts[0].trim() : '';
                            gloss = parts.slice(1).join('｜').trim();
                        } else {
                            wenyan = val.trim();
                            gloss = '';
                        }
                        if (!gloss) {
                            const src = inputText ? String(inputText.value || '').trim() : '';
                            gloss = src ? src.slice(0, 50) : '請補全白話解釋';
                        }
                        if (!wenyan) {
                            wenyan = gloss.slice(0, 50);
                        }
                        resultElements[resultId].innerHTML = `<span class="text-gray-700">${escapeHtml(wenyan)}</span><span class="mx-1">｜</span><span class="text-red-600">${escapeHtml(gloss)}</span>`;
                    } else {
                        safeSetText(resultElements[resultId], val);
                    }
                }
                if (resultTokenElements[resultId] && tokenStatsData && tokenStatsData.resultTokenCounts) {
                    const tokenCount = tokenStatsData.resultTokenCounts[resultId] || 0;
                    safeSetText(resultTokenElements[resultId], `${tokenCount} tokens`);
                }
            }
            ['result2','result3','result4','result5','result6'].forEach(showId => {
                const showEl = document.getElementById(showId);
                if (showEl && showEl.parentElement) safeRemoveClass(showEl.parentElement, 'hidden');
                const showTokenEl = document.getElementById(showId + 'Tokens');
                if (showTokenEl && showTokenEl.parentElement && showTokenEl.parentElement.parentElement) safeRemoveClass(showTokenEl.parentElement.parentElement, 'hidden');
                const showStatEl = document.getElementById(showId + 'TokenCount');
                if (showStatEl && showStatEl.parentElement && showStatEl.parentElement.parentElement) safeRemoveClass(showStatEl.parentElement.parentElement, 'hidden');
            });
            
            // 显示结果区域
            safeRemoveClass(resultArea, 'hidden');
            
            // 滚动到结果区域
            if (resultArea) {
                resultArea.scrollIntoView({ behavior: 'smooth' });
            }
            focusInputEnd();
        }

        

        // 播放文本语音
        function playText(resultId) {
            const resultElement = document.getElementById(resultId);
            const text = resultElement ? resultElement.textContent : '';
            
            if (!text || text.includes('loading-shimmer')) return;
            
            // 停止当前播放
            if (currentUtterance) {
                window.speechSynthesis.cancel();
            }
            
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9; // 语速稍慢，适合小学生
                utterance.pitch = 1.1; // 音调稍高，更友好
                
                currentUtterance = utterance;
                window.speechSynthesis.speak(utterance);
            } catch (error) {
                showError(`語音播放錯誤: ${error.message}`, '請檢查您的瀏覽器語音合成功能是否正常');
            }
        }

        function speakResultsSequential(ids) {
            try {
                if (!Array.isArray(ids) || ids.length === 0) return;
                window.speechSynthesis.cancel();
                const texts = ids
                    .map(id => {
                        const el = document.getElementById(id);
                        const t = el ? el.textContent : '';
                        if (!t || t.includes('loading-shimmer')) return '';
                        return t.trim();
                    })
                    .filter(t => t && t.length > 0);
                let i = 0;
                const speakNext = () => {
                    if (i >= texts.length) return;
                    const u = new SpeechSynthesisUtterance(texts[i]);
                    u.lang = 'zh-TW';
                    u.rate = 0.9;
                    u.pitch = 1.1;
                    u.onend = () => { i++; speakNext(); };
                    u.onerror = () => { i++; speakNext(); };
                    currentUtterance = u;
                    window.speechSynthesis.speak(u);
                };
                speakNext();
            } catch (error) {
                showError(`語音播放錯誤: ${error.message}`, '請檢查您的瀏覽器語音合成功能是否正常');
            }
        }

        function initVoiceRecognition() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return null;
            const rec = new SR();
            rec.lang = 'zh-TW';
            rec.interimResults = true;
            rec.continuous = true;
            rec.maxAlternatives = 1;
            return rec;
        }

        function toggleVoiceInput() {
            if (isRecording) {
                try { if (recognition) recognition.stop(); } catch (e) {}
                isRecording = false;
                if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-microphone mr-2"></i>語音輸入';
                focusInputEnd();
                lastFinalSegment = '';
                recentFinalSegments.length = 0;
                lastFinalSegmentNorm = '';
                recentFinalSegmentsNorm.length = 0;
                lastAppendTime = 0;
                return;
            }
            recognition = initVoiceRecognition();
            if (!recognition) {
                showError('無法使用語音輸入', '您的瀏覽器不支援語音辨識');
                return;
            }
            isRecording = true;
            lastFinalSegment = '';
            recentFinalSegments.length = 0;
            lastFinalSegmentNorm = '';
            recentFinalSegmentsNorm.length = 0;
            lastAppendTime = 0;
            if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-stop mr-2"></i>停止錄音';
            recognition.onresult = (event) => {
                let appended = false;
                const idx = (typeof event.resultIndex === 'number') ? event.resultIndex : (event.results.length - 1);
                const res = event.results[idx];
                if (res && res.isFinal) {
                    const seg = (res[0] && res[0].transcript ? res[0].transcript : '').trim();
                    const norm = normalizeSeg(seg);
                    const now = Date.now();
                    const isDup = (
                        norm && (norm === lastFinalSegmentNorm || recentFinalSegmentsNorm.includes(norm))
                    );
                    const tooSoon = (now - lastAppendTime < 1500 && norm === lastFinalSegmentNorm);
                    if (seg && norm && !isDup && !tooSoon) {
                        const prev = inputText ? String(inputText.value || '') : '';
                        const next = (prev ? prev + ' ' : '') + seg;
                        if (inputText) inputText.value = next;
                        lastFinalSegment = seg;
                        lastFinalSegmentNorm = norm;
                        recentFinalSegments.push(seg);
                        recentFinalSegmentsNorm.push(norm);
                        if (recentFinalSegments.length > 5) recentFinalSegments.shift();
                        if (recentFinalSegmentsNorm.length > 5) recentFinalSegmentsNorm.shift();
                        lastAppendTime = now;
                        appended = true;
                    }
                }
                if (appended) {
                    updateTokenCounter();
                    showSuccessMessage('語音已轉文字');
                }
                focusInputEnd();
            };
            recognition.onend = () => {
                if (isRecording) {
                    try { recognition.start(); } catch (e) {}
                } else {
                    if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-microphone mr-2"></i>語音輸入';
                }
                focusInputEnd();
            };
            recognition.onerror = () => {
                if (isRecording) {
                    try { recognition.start(); } catch (e) {}
                } else {
                    if (voiceBtn) voiceBtn.innerHTML = '<i class="fa fa-microphone mr-2"></i>語音輸入';
                }
                focusInputEnd();
            };
            try { recognition.start(); } catch (e) {}
            focusInputEnd();
        }

        // 复制所有结果
        function copyAllResults() {
            let content = '最佳講法推薦：\n\n';
            
            for (let i = 1; i <= 6; i++) {
                const resultId = `result${i}`;
                const resultElement = document.getElementById(resultId);
                if (resultElement) {
                    content += `${i}. ${resultElement.textContent}\n`;
                }
            }
            
            content += `\nToken統計：\n`;
            if (inputTokens) content += `輸入總計: ${inputTokens.textContent} tokens\n`;
            if (outputTokens) content += `輸出生成: ${outputTokens.textContent} tokens\n`;
            if (totalTokensCount) content += `總計使用: ${totalTokensCount.textContent} tokens\n`;
            
            navigator.clipboard.writeText(content).then(() => {
                showSuccessMessage('所有結果已複製到剪貼簿');
            }).catch(err => {
                showError(`複製失敗: ${err.message}`, '請手動複製或檢查瀏覽器剪貼簿權限');
            });
        }

        // 清除输入
        function clearInput() {
            if (inputText) {
                inputText.value = '';
                updateTokenCounter();
            }
            hideError();
            focusInputEnd();
        }

        // 加载示例
        function loadExample() {
            if (inputText) {
                inputText.value = '爬山今天 困難更的 期待';
                updateTokenCounter();
            }
            hideError();
            focusInputEnd();
        }

        // 重置表单
        function resetForm() {
            if (inputText) {
                inputText.value = '';
                updateTokenCounter();
            }
            
            safeAddClass(resultArea, 'hidden');
            safeAddClass(apiStatus, 'hidden');
            safeAddClass(detailedTokenStats, 'hidden');
            
            hideError();
            focusInputEnd();
        }

        // 显示处理状态
        function showProcessingStatus() {
            safeRemoveClass(processingStatus, 'hidden');
            safeAddClass(errorAlert, 'hidden');
        }

        // 隐藏处理状态
        function hideProcessingStatus() {
            safeAddClass(processingStatus, 'hidden');
        }

        // 显示错误 - 增强版
        function showError(message, details = '') {
            console.error('错误:', message, details);
            
            if (errorMessage) {
                safeSetText(errorMessage, message);
            }
            if (errorDetails && details) {
                safeSetText(errorDetails, details);
                safeRemoveClass(errorDetails, 'hidden');
            } else if (errorDetails) {
                safeAddClass(errorDetails, 'hidden');
            }
            
            safeRemoveClass(errorAlert, 'hidden');
            
            // 滚动到错误区域
            if (errorAlert) {
                errorAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 隐藏错误
        function hideError() {
            safeAddClass(errorAlert, 'hidden');
        }

        // 显示错误帮助
        function showErrorHelp() {
            const helpMessages = {
                '請輸入您的DeepSeek API Key': '請前往DeepSeek平台(https://platform.deepseek.com/)申請API Key',
                '輸入內容太長': '請簡化您的輸入內容，確保在50 tokens以內',
                'API调用失败': '請檢查您的API Key是否有效，網絡連接是否正常',
                '語音播放錯誤': '請確保您的瀏覽器支援Web Speech API，並且語音合成功能正常'
            };
            
            const errorMsg = errorMessage ? errorMessage.textContent : '';
            const helpMsg = helpMessages[errorMsg] || '請檢查您的輸入和網絡連接，或稍後再試';
            
            alert(`錯誤解決方案：\n\n${helpMsg}`);
        }

        // 显示成功消息
        function showSuccessMessage(message) {
            try {
                // 创建临时提示
                const alert = document.createElement('div');
                alert.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
                alert.textContent = message;
                
                // 确保body存在
                if (document.body) {
                    document.body.appendChild(alert);
                    
                    setTimeout(() => {
                        // 安全移除元素
                        if (alert && alert.parentNode) {
                            alert.parentNode.removeChild(alert);
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('显示成功消息失败:', error);
            }
        }

        // 全局函数
        window.analyzeText = analyzeText;
        window.playText = playText;
        window.showErrorHelp = showErrorHelp;
        window.hideError = hideError;

        console.log('应用脚本加载完成');
    </script>
</body>
</html>
        function normalizeSeg(text) {
            if (!text) return '';
            return String(text)
                .replace(/[，、。！？；,.!?;\s]+/g, ' ') // 合併標點與空白
                .replace(/\s+/g, ' ') // 壓縮多重空白
                .trim();
        }
