<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊãçÁÖßÂàÜÊûêÂ∞çË©±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 13px;
            margin: 0;
        }

        .config-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            user-select: none;
        }

        .config-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .config-toggle-btn {
            font-size: 16px;
            font-weight: bold;
            color: white;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
        }

        .config-toggle-text {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .api-config {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .api-config.expanded {
            display: flex;
        }

        .api-config input[type="password"],
        .api-config input[type="text"] {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
        }

        .api-config input[type="password"]:focus,
        .api-config input[type="text"]:focus {
            outline: none;
            background: white;
        }

        .save-key-option {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
            margin-top: 5px;
        }

        .save-key-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .version-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .version-select-title {
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .version-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .version-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
        }

        .version-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .speech-rate-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .speech-rate-title {
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .speech-rate-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speech-rate-label {
            color: white;
            font-size: 11px;
            min-width: 20px;
            text-align: center;
        }

        .speech-rate-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .speech-rate-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .speech-rate-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .speech-rate-value {
            color: white;
            font-size: 11px;
            text-align: center;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 40px;
        }

        .keyword-highlight {
            color: #2196F3;
            font-weight: 600;
            background: rgba(33, 150, 243, 0.1);
            padding: 1px 3px;
            border-radius: 3px;
        }

        .message-text.ai {
            background: #f0f0f0;
            color: #333;
            margin-left: 0;
            text-align: left;
        }

        .ai-response-section {
            margin-bottom: 15px;
        }

        .ai-response-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 5px;
            color: #555;
        }

        .ai-response-content {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
        }

        .ai-response-content.formal {
            border-left-color: #667eea;
        }

        .ai-response-content.casual {
            border-left-color: #ff6b6b;
        }

        .ai-response-english {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #2196F3;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .ai-response-english:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .ai-response-english:active {
            background-color: rgba(102, 126, 234, 0.2);
        }

        .ai-response-analyze-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            margin: 8px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .ai-response-analyze-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .ai-response-analyze-toggle-btn {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }

        .ai-response-analyze-toggle-text {
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .ai-response-analyze {
            display: none;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .ai-response-analyze.expanded {
            display: block;
        }

        .analyze-section {
            margin-bottom: 15px;
        }

        .analyze-section:last-child {
            margin-bottom: 0;
        }

        .analyze-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #667eea;
        }

        .analyze-content {
            font-size: 13px;
            line-height: 1.6;
            color: #555;
        }

        .vocabulary-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .vocabulary-item {
            padding: 4px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .vocabulary-word {
            font-weight: 600;
            color: #667eea;
        }

        .vocabulary-pos {
            font-size: 12px;
            color: #888;
            margin: 0 4px;
        }

        .example-list {
            list-style: decimal;
            padding-left: 20px;
            margin: 8px 0;
        }

        .example-item {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 6px;
            color: #555;
        }

        .ai-response-chinese {
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            padding-top: 0;
        }

        .ai-response-sentence-translation {
            font-size: 13px;
            line-height: 1.5;
            color: #888;
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid #e0e0e0;
            font-style: italic;
        }

        .ai-response-english.speaking {
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            animation: speakingGlow 1s ease-in-out infinite alternate;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes speakingGlow {
            0% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            100% {
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }
        }

        .btn-play-all {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn-play-all:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-play-all:active {
            transform: scale(0.95);
        }

        .loading-indicator {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 14px;
        }

        .conversation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            min-height: 400px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
            width: 100%;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message-image {
            width: 100%;
            max-width: 100%;
            max-height: 50vh;
            height: auto;
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: contain;
        }

        .message-text {
            background: #f0f0f0;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            color: #333;
            font-size: clamp(14px, 3vw, 16px);
            word-wrap: break-word;
            max-width: 90%;
            margin-bottom: 8px;
            width: fit-content;
        }

        .message-text.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .camera-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .camera-preview {
            position: fixed;
            bottom: 120px;
            left: 20px;
            width: 80px;
            height: 142px;
            border-radius: 8px;
            object-fit: cover;
            display: block;
            background: #000;
            z-index: 50;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .preview-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 1px #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .background-speech-option {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
            justify-content: center;
        }

        .background-speech-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .background-speech-option label {
            cursor: pointer;
            user-select: none;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .btn-capture {
            background: #667eea;
            color: white;
            flex: 1;
            max-width: 150px;
        }

        .btn-capture:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-capture:active {
            transform: scale(0.95);
        }

        .btn-submit {
            background: #28a745;
            color: white;
            flex: 1;
            max-width: 200px;
            position: relative;
        }

        .btn-submit:hover:not(:active) {
            background: #218838;
        }

        .btn-submit:active {
            background: #1e7e34;
            transform: scale(0.95);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-reload {
            background: #28a745;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 10px;
        }

        .btn-reload:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-reload:active {
            transform: scale(0.95);
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            font-size: 16px;
        }

        /* È°ØÁ§∫ video È†êË¶Ω - 9:16 Ë¶èÊ†ºÔºåÂõ∫ÂÆöÂú®Â∑¶‰∏ãËßí */
        #videoElement {
            position: fixed;
            bottom: 120px;
            left: 20px;
            width: 80px;
            height: 142px;
            border-radius: 8px;
            object-fit: cover;
            display: block;
            background: #000;
            z-index: 50;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ ÊãçÁÖßÂàÜÊûêÂ∞çË©±</h1>
            <p>ÊãçÁÖß‰∏¶Áõ¥Êé•ÈÄÅÂá∫ÂàÜÊûê</p>
            <div class="config-toggle" id="configToggle">
                <div class="config-toggle-btn" id="toggleBtn">+</div>
                <div class="config-toggle-text">Ë®≠ÂÆö</div>
            </div>
            <div class="api-config" id="apiConfig">
                <input type="password" id="apiKey" placeholder="Ë´ãËº∏ÂÖ• API Key" />
                <div class="save-key-option">
                    <input type="checkbox" id="saveApiKey" />
                    <label for="saveApiKey">Â∞á key Â≠òÂú®ÁÄèË¶ΩÂô®Á´Ø</label>
                </div>
                <div class="version-select">
                    <div class="version-select-title">ÂõûË¶ÜÁâàÊú¨ÈÅ∏ÊìáÔºö</div>
                    <div class="version-checkbox-group">
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showFormal" />
                            <label for="showFormal">Ê≠£ÂºèÁâà (Formal)</label>
                        </div>
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showCasual" />
                            <label for="showCasual">Âè£Ë™ûÁâà (Casual)</label>
                        </div>
                    </div>
                </div>
                <div class="speech-rate-control">
                    <div class="speech-rate-title">Ë™ûÈü≥Êí≠ÊîæÈÄüÂ∫¶Ôºö</div>
                    <div class="speech-rate-slider-container">
                        <span class="speech-rate-label">ÊÖ¢</span>
                        <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.8" class="speech-rate-slider" />
                        <span class="speech-rate-label">Âø´</span>
                    </div>
                    <div class="speech-rate-value" id="speechRateValue">0.8x</div>
                </div>
            </div>
        </div>

        <div class="conversation" id="conversation">
            <div class="empty-state">ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÂ∞çË©±ÔºåÊãçÁÖß‰∏¶ÈÄÅÂá∫ÂàÜÊûêÂêßÔºÅ</div>
        </div>
    </div>

    <div class="camera-controls">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement" style="display: none;"></canvas>
        <img id="previewImage" class="camera-preview" alt="È†êË¶Ω" style="display: none;">
        
        <div class="background-speech-option">
            <input type="checkbox" id="backgroundSpeech" />
            <label for="backgroundSpeech">üîä ËÉåÊôØÊúóËÆÄÔºàËû¢ÂπïÈóúÈñâÊôÇÁπºÁ∫åÔºâ</label>
        </div>
        
        <div class="button-group">
            <button class="btn btn-capture" id="captureBtn">üì∑ ÊãçÁÖß</button>
            <button class="btn btn-reload" id="reloadBtn" title="ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢">üîÑ</button>
            <button class="btn btn-submit" id="submitBtn">üì§ ÈÄÅÂá∫ÁÖßÁâá</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const conversation = document.getElementById('conversation');
        const captureBtn = document.getElementById('captureBtn');
        const submitBtn = document.getElementById('submitBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const status = document.getElementById('status');
        const previewImage = document.getElementById('previewImage');

        let stream = null;
        let currentImageData = null;
        
        // API Áõ∏ÈóúËÆäÊï∏
        let apiKey = '';
        // Âõ∫ÂÆö‰ΩøÁî®Êñ∞Âä†Âù°Âú∞ÂçÄÔºåÁõ¥Êé•Ë™øÁî®
        const apiUrl = 'https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions';
        let conversationHistory = [];
        const apiKeyInput = document.getElementById('apiKey');
        const saveApiKeyCheckbox = document.getElementById('saveApiKey');
        const showFormalCheckbox = document.getElementById('showFormal');
        const showCasualCheckbox = document.getElementById('showCasual');
        const configToggle = document.getElementById('configToggle');
        const apiConfig = document.getElementById('apiConfig');
        const toggleBtn = document.getElementById('toggleBtn');
        const speechRateSlider = document.getElementById('speechRate');
        const speechRateValue = document.getElementById('speechRateValue');
        const backgroundSpeechCheckbox = document.getElementById('backgroundSpeech');
        
        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑ API Key
        const savedApiKey = localStorage.getItem('qwen_api_key');
        if (savedApiKey) {
            apiKey = savedApiKey;
            apiKeyInput.value = savedApiKey;
            saveApiKeyCheckbox.checked = true;
        }

        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑÁâàÊú¨ÈÅ∏Êìá
        const savedShowFormal = localStorage.getItem('showFormal');
        const savedShowCasual = localStorage.getItem('showCasual');
        if (savedShowFormal !== null) {
            showFormalCheckbox.checked = savedShowFormal === 'true';
        } else {
            showFormalCheckbox.checked = true; // È†êË®≠ÈÅ∏‰∏≠
        }
        if (savedShowCasual !== null) {
            showCasualCheckbox.checked = savedShowCasual === 'true';
        } else {
            showCasualCheckbox.checked = true; // È†êË®≠ÈÅ∏‰∏≠
        }

        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑË™ûÈü≥ÈÄüÂ∫¶
        const savedSpeechRate = localStorage.getItem('speechRate');
        if (savedSpeechRate !== null) {
            speechRateSlider.value = savedSpeechRate;
            speechRateValue.textContent = savedSpeechRate + 'x';
        }

        // Âæû localStorage ËºâÂÖ•ËÉåÊôØÊúóËÆÄË®≠ÂÆö
        const savedBackgroundSpeech = localStorage.getItem('backgroundSpeech');
        if (savedBackgroundSpeech !== null) {
            backgroundSpeechCheckbox.checked = savedBackgroundSpeech === 'true';
        }

        // Âæû localStorage ËºâÂÖ•ÈÖçÁΩÆÂçÄÂüüÂ±ïÈñãÁãÄÊÖãÔºàÈ†êË®≠Êî∂Á∏ÆÔºâ
        const savedConfigExpanded = localStorage.getItem('configExpanded');
        if (savedConfigExpanded === 'true') {
            apiConfig.classList.add('expanded');
            toggleBtn.textContent = '-';
        }

        // Ê™¢Êü•ÁÄèË¶ΩÂô®ÊîØÊè¥
        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

        // ÂïüÂãïÁõ∏Ê©üÔºàÂè™ÂïüÂãï‰∏ÄÊ¨°Ôºå‰øùÊåÅÈñãÂïüÔºâ
        async function startCamera() {
            try {
                // Â¶ÇÊûúÂ∑≤Á∂ìÊúâ stream Âú®ÈÅãË°åÔºåÂÖà‰∏çÈóúÈñâÔºå‰øùÊåÅÈñãÂïüÁãÄÊÖã
                if (stream) {
                    video.srcObject = stream;
                    status.textContent = 'Áõ∏Ê©üÂ∑≤Â∞±Á∑í';
                    return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // ‰ΩøÁî®ÂæåÁΩÆÁõ∏Ê©ü
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = stream;
                status.textContent = 'Áõ∏Ê©üÂ∑≤Â∞±Á∑í';
            } catch (err) {
                status.textContent = 'ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©ü: ' + err.message;
                console.error('Camera error:', err);
            }
        }

        // ÊãçÁÖß
        function capturePhoto() {
            if (!stream) {
                status.textContent = 'Ë´ãÂÖàÂïüÂãïÁõ∏Ê©ü';
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // ËΩâÊèõÁÇ∫ base64
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Èö±Ëóè video È†êË¶ΩÔºåÈ°ØÁ§∫ÊãçÊîùÁöÑÁÖßÁâáÈ†êË¶Ω
            video.style.display = 'none';
            previewImage.src = currentImageData;
            previewImage.style.display = 'block';
            
            status.textContent = 'ÁÖßÁâáÂ∑≤ÊãçÊîùÔºåÂèØ‰ª•ÈÄÅÂá∫ÂàÜÊûê';
        }

        // ËôïÁêÜÁÖßÁâáÊèê‰∫§
        async function handlePhotoSubmit() {
            if (currentImageData) {
                // Ê∏ÖÈô§Áï´Èù¢‰∏äÁöÑË≥áÊñô
                clearConversationData();
                
                // È°ØÁ§∫Áî®Êà∂Ë®äÊÅØÔºà‰∏çÈúÄË¶ÅË™ûÈü≥ÊñáÂ≠óÔºâ
                addUserMessage(currentImageData, "Ë´ãÂàÜÊûêÈÄôÂºµÁÖßÁâá");
                
                // Ê™¢Êü• API Key
                if (!apiKey) {
                    status.textContent = 'Ë´ãÂÖàËº∏ÂÖ• API Key';
                    resetForNextCapture();
                    return;
                }
                
                // Ë™øÁî® qwen3-vl-flash API
                try {
                    status.textContent = 'Ê≠£Âú®ËôïÁêÜ...';
                    const aiResponse = await callQwen2VL72B(currentImageData);
                    
                    // Ëß£ÊûêÁ¨¨‰∏ÄÊ¨°ÂõûÊáâ
                    const parsedResponse = parseAIResponse(aiResponse);
                    
                    // Á¨¨‰∫åÊ¨°APIË™øÁî®ÔºöÁøªË≠ØËã±ÊñáÂè•Â≠ê
                    status.textContent = 'Ê≠£Âú®ÁøªË≠ØËã±ÊñáÂè•Â≠ê...';
                    const translatedResponse = await translateEnglishSentences(parsedResponse);
                    
                    // È°ØÁ§∫ AI ÂõûÊáâÔºàÂåÖÂê´ÁøªË≠ØÔºâ
                    addAIMessage(aiResponse, translatedResponse);
                    
                    // Ëá™ÂãïÊúóËÆÄËã±ÊñáÔºàÊ†πÊìöÁî®Êà∂ÈÅ∏ÊìáÔºöÂÑ™ÂÖàËÆÄÂè£Ë™ûÁâàÔºåÂ¶ÇÊûúÊ≤íÊúâÂâáËÆÄÊ≠£ÂºèÁâàÔºâ
                    setTimeout(() => {
                        const showCasual = showCasualCheckbox.checked;
                        const showFormal = showFormalCheckbox.checked;
                        
                        // ÂÑ™ÂÖàËÆÄÂè£Ë™ûÁâà
                        if (showCasual && translatedResponse && translatedResponse.casual && translatedResponse.casual.sentences.length > 0) {
                            const casualSentences = [];
                            translatedResponse.casual.sentences.forEach((sentence, index) => {
                                const element = document.getElementById(`casual-sentence-${index}`);
                                if (element) {
                                    casualSentences.push({ element: element, text: sentence.english });
                                }
                            });
                            if (casualSentences.length > 0) {
                                speakAllSentences(casualSentences);
                            }
                        } else if (showFormal && translatedResponse && translatedResponse.formal && translatedResponse.formal.sentences.length > 0) {
                            // Â¶ÇÊûúÊ≤íÊúâÂè£Ë™ûÁâàÊàñÊú™ÈÅ∏ÊìáÂè£Ë™ûÁâàÔºåÂâáËÆÄÊ≠£ÂºèÁâà
                            const formalSentences = [];
                            translatedResponse.formal.sentences.forEach((sentence, index) => {
                                const element = document.getElementById(`formal-sentence-${index}`);
                                if (element) {
                                    formalSentences.push({ element: element, text: sentence.english });
                                }
                            });
                            if (formalSentences.length > 0) {
                                speakAllSentences(formalSentences);
                            }
                        } else {
                            // ÂõûÈÄÄÂà∞ÂéüÂßãÊúóËÆÄÊñπÂºèÔºàÂ¶ÇÊûúÊ≤íÊúâÁøªË≠ØÁµêÊûúÔºâ- ‰πü‰ΩøÁî®ÈÄêÂè•ÊúóËÆÄ
                            if (showCasual && parsedResponse.casual && parsedResponse.casual.english) {
                                const casualSentences = [];
                                const sentences = splitIntoSentences(parsedResponse.casual.english);
                                sentences.forEach((sentence, index) => {
                                    const element = document.getElementById(`casual-sentence-${index}`);
                                    if (element) {
                                        casualSentences.push({ element: element, text: sentence });
                                    }
                                });
                                if (casualSentences.length > 0) {
                                    speakAllSentences(casualSentences);
                                }
                            } else if (showFormal && parsedResponse.formal && parsedResponse.formal.english) {
                                const formalSentences = [];
                                const sentences = splitIntoSentences(parsedResponse.formal.english);
                                sentences.forEach((sentence, index) => {
                                    const element = document.getElementById(`formal-sentence-${index}`);
                                    if (element) {
                                        formalSentences.push({ element: element, text: sentence });
                                    }
                                });
                                if (formalSentences.length > 0) {
                                    speakAllSentences(formalSentences);
                                }
                            }
                        }
                    }, 500); // Âª∂ÈÅ≤500msËÆìDOMÂÖÉÁ¥†ÂÆåÂÖ®Ê∏≤Êüì
                    
                } catch (error) {
                    status.textContent = 'ÈåØË™§: ' + error.message;
                    console.error('API Ë™øÁî®Â§±Êïó:', error);
                }
                
                // ÈáçÁΩÆÁãÄÊÖãÔºåÊ∫ñÂÇô‰∏ã‰∏ÄÊ¨°ÊãçÁÖß
                resetForNextCapture();
            } else {
                status.textContent = 'Ë´ãÂÖàÊãçÁÖß';
            }
        }

        // ÈáçÁΩÆÁãÄÊÖãÔºåÊ∫ñÂÇô‰∏ã‰∏ÄÊ¨°ÊãçÁÖß
        function resetForNextCapture() {
            currentImageData = null;
            previewImage.style.display = 'none';
            // ÊÅ¢Âæ© video È†êË¶Ω
            video.style.display = 'block';
            status.textContent = 'Â∑≤ÈáçÁΩÆÔºåÂèØ‰ª•ÂÜçÊ¨°ÊãçÁÖß‰∏¶ÈÄÅÂá∫';
        }

        // Ê∑ªÂä†Áî®Êà∂Ë®äÊÅØÂà∞Â∞çË©±
        function addUserMessage(imageData, text) {
            // ÁßªÈô§Á©∫ÁãÄÊÖã
            const emptyState = conversation.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // ÂÖàÊ∑ªÂä†ÊñáÂ≠óÔºàÊúÉÈ°ØÁ§∫Âú®‰∏äÊñπÔºâ
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text user';
            textDiv.textContent = text;

            // ÂÜçÊ∑ªÂä†ÁÖßÁâáÔºàÊúÉÈ°ØÁ§∫Âú®‰∏ãÊñπÔºâ
            const img = document.createElement('img');
            img.src = imageData;
            img.className = 'message-image';
            img.alt = 'ÊãçÊîùÁöÑÁÖßÁâá';

            // ÂÖàÊ∑ªÂä†ÊñáÂ≠óÔºåÂÜçÊ∑ªÂä†ÁÖßÁâá
            messageDiv.appendChild(textDiv);
            messageDiv.appendChild(img);

            conversation.appendChild(messageDiv);
            
            // ÊªæÂãïÂà∞Â∫ïÈÉ®
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Ê™¢Êü•ÊòØÂê¶ÊúâËß£ÊûêÂÖßÂÆπ
        function hasAnalyzeContent(analyze) {
            return analyze.keyPoints || analyze.grammarAnalysis || 
                   analyze.vocabulary.length > 0 || analyze.examples.length > 0;
        }

        // ÂâµÂª∫Ëß£ÊûêÂçÄÂüü
        function createAnalyzeArea(analyze) {
            const analyzeContainer = document.createElement('div');
            analyzeContainer.className = 'ai-response-analyze';
            
            // ÂâµÂª∫Êî∂Á∏Æ/Â±ïÈñãÊåâÈàï
            const toggle = document.createElement('div');
            toggle.className = 'ai-response-analyze-toggle';
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'ai-response-analyze-toggle-btn';
            toggleBtn.textContent = '+';
            const toggleText = document.createElement('span');
            toggleText.className = 'ai-response-analyze-toggle-text';
            toggleText.textContent = 'üìñ ÂñÆÂ≠óÁâáË™ûÊñáÊ≥ïÈáçÈªûËß£Êûê';
            toggle.appendChild(toggleBtn);
            toggle.appendChild(toggleText);
            
            // ÂâµÂª∫Ëß£ÊûêÂÖßÂÆπÂçÄÂüü
            const analyzeContent = document.createElement('div');
            analyzeContent.className = 'ai-response-analyze';
            
            // ÈáçÈªûË™™Êòé
            if (analyze.keyPoints) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìå ÈáçÈªûË™™Êòé';
                const content = document.createElement('div');
                content.className = 'analyze-content';
                content.textContent = analyze.keyPoints;
                section.appendChild(title);
                section.appendChild(content);
                analyzeContent.appendChild(section);
            }
            
            // Ë™ûÊ≥ïÁµêÊßã
            if (analyze.grammarAnalysis) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìù Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ';
                const content = document.createElement('div');
                content.className = 'analyze-content';
                content.textContent = analyze.grammarAnalysis;
                section.appendChild(title);
                section.appendChild(content);
                analyzeContent.appendChild(section);
            }
            
            // Ë©ûÂΩôË°®
            if (analyze.vocabulary && analyze.vocabulary.length > 0) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìö Ë©ûÂΩôË°®ÔºàA2Á¥öÂà•Ôºâ';
                const vocabList = document.createElement('ul');
                vocabList.className = 'vocabulary-list';
                
                analyze.vocabulary.forEach(vocab => {
                    const item = document.createElement('li');
                    item.className = 'vocabulary-item';
                    item.innerHTML = `- ${vocab}`;
                    vocabList.appendChild(item);
                });
                
                section.appendChild(title);
                section.appendChild(vocabList);
                analyzeContent.appendChild(section);
            }
            
            // ‰æãÂè•
            if (analyze.examples && analyze.examples.length > 0) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üí° A2Á¥öÂà•‰æãÂè•';
                const exampleList = document.createElement('ol');
                exampleList.className = 'example-list';
                
                analyze.examples.forEach(example => {
                    const item = document.createElement('li');
                    item.className = 'example-item';
                    item.textContent = example;
                    exampleList.appendChild(item);
                });
                
                section.appendChild(title);
                section.appendChild(exampleList);
                analyzeContent.appendChild(section);
            }
            
            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂‰æÜÂ±ïÈñã/Êî∂Á∏Æ
            toggle.addEventListener('click', () => {
                const isExpanded = analyzeContent.classList.contains('expanded');
                if (isExpanded) {
                    analyzeContent.classList.remove('expanded');
                    toggleBtn.textContent = '+';
                } else {
                    analyzeContent.classList.add('expanded');
                    toggleBtn.textContent = '-';
                }
            });
            
            analyzeContainer.appendChild(toggle);
            analyzeContainer.appendChild(analyzeContent);
            
            return analyzeContainer;
        }

        // Ê∑ªÂä† AI Ë®äÊÅØÂà∞Â∞çË©±
        function addAIMessage(response, translatedResponse = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Ëß£ÊûêÂõûÊáâ
            const parsedResponse = parseAIResponse(response);

            // Ê™¢Êü•Áî®Êà∂ÈÅ∏ÊìáÁöÑÁâàÊú¨
            const showFormal = showFormalCheckbox.checked;
            const showCasual = showCasualCheckbox.checked;

            // ÂâµÂª∫ÂÆπÂô®
            const container = document.createElement('div');
            container.className = 'message-text ai';

            // Ê∑ªÂä†Ê≠£ÂºèÁâàÔºàÂ¶ÇÊûúÁî®Êà∂ÈÅ∏ÊìáÈ°ØÁ§∫Ôºâ
            if (showFormal && parsedResponse.formal && (parsedResponse.formal.english || parsedResponse.formal.chinese)) {
                const formalSection = document.createElement('div');
                formalSection.className = 'ai-response-section';
                
                const formalTitle = document.createElement('div');
                formalTitle.className = 'ai-response-title';
                formalTitle.textContent = 'üìù Ê≠£ÂºèÁâà (Formal Version)';
                
                const formalContent = document.createElement('div');
                formalContent.className = 'ai-response-content formal';
                
                // Ê∑ªÂä†Ëã±ÊñáÔºàÂèØÈªûÊìäÊúóËÆÄÔºâ
                if (parsedResponse.formal.english) {
                    // Â¶ÇÊûúÊúâÁøªË≠ØÁµêÊûúÔºåÈÄêÂè•È°ØÁ§∫
                    if (translatedResponse && translatedResponse.formal && translatedResponse.formal.sentences.length > 0) {
                        const formalSentences = [];
                        translatedResponse.formal.sentences.forEach((sentence, index) => {
                            // Ëã±ÊñáÂè•Â≠ê
                            const englishDiv = document.createElement('div');
                            englishDiv.className = 'ai-response-english';
                            englishDiv.id = `formal-sentence-${index}`;
                            englishDiv.textContent = sentence.english;
                            englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                            englishDiv.addEventListener('click', () => {
                                speakSentenceWithHighlight(sentence.english, englishDiv);
                            });
                            formalContent.appendChild(englishDiv);
                            formalSentences.push({ element: englishDiv, text: sentence.english });
                            
                            // ‰∏≠ÊñáÁøªË≠ØÔºàÁ∑äË∑üÂú®Ëã±Êñá‰∏ãÊñπÔºâ
                            const chineseDiv = document.createElement('div');
                            chineseDiv.className = 'ai-response-sentence-translation';
                            chineseDiv.textContent = sentence.chinese;
                            formalContent.appendChild(chineseDiv);
                        });
                        
                        // ÁÇ∫Êï¥ÂÄãÊ≠£ÂºèÁâàÊ∑ªÂä†ÂÖ®ÈÉ®ÊúóËÆÄÂäüËÉΩ
                        const playAllBtn = document.createElement('button');
                        playAllBtn.className = 'btn-play-all';
                        playAllBtn.textContent = 'üîä ÊúóËÆÄÂÖ®ÈÉ®';
                        playAllBtn.addEventListener('click', () => {
                            speakAllSentences(formalSentences);
                        });
                        formalContent.appendChild(playAllBtn);
                    } else {
                        // Ê≤íÊúâÁøªË≠ØÁµêÊûúÊôÇÁöÑÂéüÂßãÈ°ØÁ§∫ÊñπÂºè - ÊãÜÂàÜÊàêÂè•Â≠ê
                        const sentences = splitIntoSentences(parsedResponse.formal.english);
                        const formalSentences = [];
                        
                        sentences.forEach((sentence, index) => {
                            const englishDiv = document.createElement('div');
                            englishDiv.className = 'ai-response-english';
                            englishDiv.id = `formal-sentence-${index}`;
                            englishDiv.textContent = sentence;
                            englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                            englishDiv.addEventListener('click', () => {
                                speakSentenceWithHighlight(sentence, englishDiv);
                            });
                            formalContent.appendChild(englishDiv);
                            formalSentences.push({ element: englishDiv, text: sentence });
                        });
                        
                        // Ê∑ªÂä†ÂÖ®ÈÉ®ÊúóËÆÄÊåâÈàï
                        if (formalSentences.length > 1) {
                            const playAllBtn = document.createElement('button');
                            playAllBtn.className = 'btn-play-all';
                            playAllBtn.textContent = 'üîä ÊúóËÆÄÂÖ®ÈÉ®';
                            playAllBtn.addEventListener('click', () => {
                                speakAllSentences(formalSentences);
                            });
                            formalContent.appendChild(playAllBtn);
                        }
                        
                        // ‰øùÂ≠òÂè•Â≠êÂºïÁî®‰æõËá™ÂãïÊúóËÆÄ‰ΩøÁî®
                        formalContent.dataset.sentences = JSON.stringify(formalSentences.map(s => s.text));
                    }
                }
                
                // Ê∑ªÂä†ÁπÅÈ´î‰∏≠Êñá
                if (parsedResponse.formal.chinese) {
                    // Ê∑ªÂä†ÂàÜÈöîÁ∑ö
                    const hrElement = document.createElement('hr');
                    hrElement.style.margin = '15px 0';
                    hrElement.style.border = 'none';
                    hrElement.style.borderTop = '1px solid #e0e0e0';
                    formalContent.appendChild(hrElement);
                    
                    const chineseDiv = document.createElement('div');
                    chineseDiv.className = 'ai-response-chinese';
                    chineseDiv.textContent = parsedResponse.formal.chinese;
                    formalContent.appendChild(chineseDiv);
                }
                
                // Ê∑ªÂä†Ëß£ÊûêÂçÄÂüüÔºàÂú®ÁπÅÈ´î‰∏≠ÊñáÁøªË≠ØÂæåÈù¢Ôºâ
                if (parsedResponse.formal.analyze && hasAnalyzeContent(parsedResponse.formal.analyze)) {
                    const analyzeArea = createAnalyzeArea(parsedResponse.formal.analyze);
                    formalContent.appendChild(analyzeArea);
                }
                
                formalSection.appendChild(formalTitle);
                formalSection.appendChild(formalContent);
                container.appendChild(formalSection);
            }

            // Ê∑ªÂä†Âè£Ë™ûÁâàÔºàÂ¶ÇÊûúÁî®Êà∂ÈÅ∏ÊìáÈ°ØÁ§∫Ôºâ
            if (showCasual && parsedResponse.casual && (parsedResponse.casual.english || parsedResponse.casual.chinese)) {
                const casualSection = document.createElement('div');
                casualSection.className = 'ai-response-section';
                
                const casualTitle = document.createElement('div');
                casualTitle.className = 'ai-response-title';
                casualTitle.textContent = 'üí¨ Âè£Ë™ûÁâà (Casual Version)';
                
                const casualContent = document.createElement('div');
                casualContent.className = 'ai-response-content casual';
                
                // Ê∑ªÂä†Ëã±ÊñáÔºàÂèØÈªûÊìäÊúóËÆÄÔºâ
                if (parsedResponse.casual.english) {
                    // Â¶ÇÊûúÊúâÁøªË≠ØÁµêÊûúÔºåÈÄêÂè•È°ØÁ§∫
                    if (translatedResponse && translatedResponse.casual && translatedResponse.casual.sentences.length > 0) {
                        const casualSentences = [];
                        translatedResponse.casual.sentences.forEach((sentence, index) => {
                            // Ëã±ÊñáÂè•Â≠ê
                            const englishDiv = document.createElement('div');
                            englishDiv.className = 'ai-response-english';
                            englishDiv.id = `casual-sentence-${index}`;
                            englishDiv.textContent = sentence.english;
                            englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                            englishDiv.addEventListener('click', () => {
                                speakSentenceWithHighlight(sentence.english, englishDiv);
                            });
                            casualContent.appendChild(englishDiv);
                            casualSentences.push({ element: englishDiv, text: sentence.english });
                            
                            // ‰∏≠ÊñáÁøªË≠ØÔºàÁ∑äË∑üÂú®Ëã±Êñá‰∏ãÊñπÔºâ
                            const chineseDiv = document.createElement('div');
                            chineseDiv.className = 'ai-response-sentence-translation';
                            chineseDiv.textContent = sentence.chinese;
                            casualContent.appendChild(chineseDiv);
                        });
                        
                        // ÁÇ∫Êï¥ÂÄãÂè£Ë™ûÁâàÊ∑ªÂä†ÂÖ®ÈÉ®ÊúóËÆÄÂäüËÉΩ
                        const playAllBtn = document.createElement('button');
                        playAllBtn.className = 'btn-play-all';
                        playAllBtn.textContent = 'üîä ÊúóËÆÄÂÖ®ÈÉ®';
                        playAllBtn.addEventListener('click', () => {
                            speakAllSentences(casualSentences);
                        });
                        casualContent.appendChild(playAllBtn);
                    } else {
                        // Ê≤íÊúâÁøªË≠ØÁµêÊûúÊôÇÁöÑÂéüÂßãÈ°ØÁ§∫ÊñπÂºè - ÊãÜÂàÜÊàêÂè•Â≠ê
                        const sentences = splitIntoSentences(parsedResponse.casual.english);
                        const casualSentences = [];
                        
                        sentences.forEach((sentence, index) => {
                            const englishDiv = document.createElement('div');
                            englishDiv.className = 'ai-response-english';
                            englishDiv.id = `casual-sentence-${index}`;
                            englishDiv.textContent = sentence;
                            englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                            englishDiv.addEventListener('click', () => {
                                speakSentenceWithHighlight(sentence, englishDiv);
                            });
                            casualContent.appendChild(englishDiv);
                            casualSentences.push({ element: englishDiv, text: sentence });
                        });
                        
                        // Ê∑ªÂä†ÂÖ®ÈÉ®ÊúóËÆÄÊåâÈàï
                        if (casualSentences.length > 1) {
                            const playAllBtn = document.createElement('button');
                            playAllBtn.className = 'btn-play-all';
                            playAllBtn.textContent = 'üîä ÊúóËÆÄÂÖ®ÈÉ®';
                            playAllBtn.addEventListener('click', () => {
                                speakAllSentences(casualSentences);
                            });
                            casualContent.appendChild(playAllBtn);
                        }
                        
                        // ‰øùÂ≠òÂè•Â≠êÂºïÁî®‰æõËá™ÂãïÊúóËÆÄ‰ΩøÁî®
                        casualContent.dataset.sentences = JSON.stringify(casualSentences.map(s => s.text));
                    }
                }
                
                // Ê∑ªÂä†ÁπÅÈ´î‰∏≠Êñá
                if (parsedResponse.casual.chinese) {
                    // Ê∑ªÂä†ÂàÜÈöîÁ∑ö
                    const hrElement = document.createElement('hr');
                    hrElement.style.margin = '15px 0';
                    hrElement.style.border = 'none';
                    hrElement.style.borderTop = '1px solid #e0e0e0';
                    casualContent.appendChild(hrElement);
                    
                    const chineseDiv = document.createElement('div');
                    chineseDiv.className = 'ai-response-chinese';
                    chineseDiv.textContent = parsedResponse.casual.chinese;
                    casualContent.appendChild(chineseDiv);
                }
                
                // Ê∑ªÂä†Ëß£ÊûêÂçÄÂüüÔºàÂú®ÁπÅÈ´î‰∏≠ÊñáÁøªË≠ØÂæåÈù¢Ôºâ
                if (parsedResponse.casual.analyze && hasAnalyzeContent(parsedResponse.casual.analyze)) {
                    const analyzeArea = createAnalyzeArea(parsedResponse.casual.analyze);
                    casualContent.appendChild(analyzeArea);
                }
                
                casualSection.appendChild(casualTitle);
                casualSection.appendChild(casualContent);
                container.appendChild(casualSection);
            }

            messageDiv.appendChild(container);
            conversation.appendChild(messageDiv);
            
            // ÊªæÂãïÂà∞Â∫ïÈÉ®
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Ë™øÁî® qwen3-vl-flash API
        async function callQwen2VL72B(imageData) {
            const userMessage = {
                "role": "user",
                "content": [
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": imageData
                        }
                    },
                    {
                        "type": "text",
                        "text": `Ë´ãËß£ÊûêÈÄôÂºµÂúñÁâáÔºåÁî®Ëã±ÊñáÂÆåÊàê‰ª•‰∏ãÊèèËø∞Ôºö
- ÊåáÂá∫Âúñ‰∏≠ÁöÑ 2-3 ÂÄãÊ†∏ÂøÉ‰∫∫/Áâ©Ôºà‰ΩøÁî®Ë∫´‰ªΩÂêçË©ûÔºâ
- ÊèèËø∞ÊØèÂÄã‰∫∫/Áâ©ÁöÑ‰ΩçÁΩÆÔºà‰ΩøÁî®Êñπ‰Ωç‰ªãË©û/ÂâØË©ûÔºâ
- Ë™™Êòé‰∫∫/Áâ©ÁöÑÁâπÂæµÊàñÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂãï‰ΩúÔºà‰ΩøÁî®ÂΩ¢ÂÆπË©û/ÂãïË©ûÔºâ
- ÂÖ®ÈÉ®‰ΩøÁî® A2 Á¥öÂà•Ë©ûÂΩôÔºåÂè•Â≠êÁ∞°ÂñÆÊòìÊáÇ

Ë´ãÊèê‰æõÂÖ©Á®ÆÁâàÊú¨Ôºö
1. Ê≠£ÂºèÁâàÔºàFormal VersionÔºâÔºö‰ΩøÁî®Ê≠£Âºè„ÄÅÊ®ôÊ∫ñÁöÑËã±ÊñáË°®ÈÅî
2. Âè£Ë™ûÁâàÔºàCasual VersionÔºâÔºö‰ΩøÁî®Âè£Ë™û„ÄÅËºïÈ¨ÜÁöÑËã±ÊñáË°®ÈÅî

ÊØèÁ®ÆÁâàÊú¨ÁöÑËã±ÊñáÂÖßÂÆπÊ†ºÂºèÁØÑ‰æãÔºö
"There is a woman in front of the window. She is sitting at a small table. The table has a red cup of coffee on it. The woman looks happy. She is not eating‚Äîshe is just drinking her coffee."

ÊØèÁ®ÆÁâàÊú¨ÈÉΩÈúÄË¶ÅÂåÖÂê´Ôºö
- Ëã±ÊñáÂÖßÂÆπÔºàÊåâÁÖß‰∏äËø∞Ê†ºÂºèË¶ÅÊ±ÇÔºâ
- ÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø

ÂêåÊôÇË´ãÁÇ∫ÊØèÁ®ÆÁâàÊú¨Êèê‰æõË©≥Á¥∞Ëß£ÊûêÔºö
- ÈáçÈªûË™™ÊòéÔºöÂàóÂá∫ÈÄôÊÆµËã±ÊñáÊèèËø∞ÁöÑÈóúÈçµÈáçÈªû
- Ë™ûÊ≥ïÁµêÊßãÔºöÂàÜÊûêÂè•Â≠ê‰∏≠‰ΩøÁî®ÁöÑA2Ë™ûÊ≥ïÁµêÊßã
- A2Á¥öÂà•Ë©ûÂΩôË°®ÔºöÂæûÂúñÁâáÊèèËø∞‰∏≠Ëæ®Ë≠ò‰∏¶ÂàóÂá∫ÊâÄÊúâA2Á¥öÂà•Ë©ûÂΩôÔºåÊ†ºÂºèÁÇ∫ÔºöË©ûÂΩô (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄùÔºà‰æãÂ¶ÇÔºöwoman (n.) Â•≥‰∫∫Ôºâ
- A2Á¥öÂà•‰æãÂè•ÔºöÊèê‰æõ3ÂÄã‰ΩøÁî®ÈÄô‰∫õË©ûÂΩôÁöÑA2Á¥öÂà•‰æãÂè•

Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÂõûË¶ÜÔºö
„ÄêÊ≠£ÂºèÁâà„Äë
[Ê≠£ÂºèËã±ÊñáÂÖßÂÆπ - ÊåâÁÖßÁØÑ‰æãÊ†ºÂºèÔºöThere is... She is... The table has... Á≠â]


„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë
[ÈáçÈªûË™™Êòé]
[Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ]
[Ë©ûÂΩôË°®]ÔºàA2Á¥öÂà•Ôºâ
- Ë©ûÂΩô1 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
- Ë©ûÂΩô2 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
...
[‰æãÂè•]
1. ‰æãÂè•1
2. ‰æãÂè•2
3. ‰æãÂè•3

„ÄêÂè£Ë™ûÁâà„Äë
[Âè£Ë™ûËã±ÊñáÂÖßÂÆπ - ÊåâÁÖßÁØÑ‰æãÊ†ºÂºèÔºöThere is... She is... The table has... Á≠â]


„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë
[ÈáçÈªûË™™Êòé]
[Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ]
[Ë©ûÂΩôË°®]ÔºàA2Á¥öÂà•Ôºâ
- Ë©ûÂΩô1 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
- Ë©ûÂΩô2 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
...
[‰æãÂè•]
1. ‰æãÂè•1
2. ‰æãÂè•2
3. ‰æãÂè•3

Ë´ãÂàÜÊûêÈÄôÂºµÁÖßÁâá‰∏¶Êèê‰æõË©≥Á¥∞ÁöÑËã±ÊñáÊèèËø∞„ÄÇ`
                    }
                ]
            };

            const messages = [...conversationHistory, userMessage];

            const requestBody = {
                "model": "qwen3-vl-flash",
                "messages": messages,
                "max_tokens": 2000,
                "temperature": 0.7
            };

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'X-DashScope-SSE': 'disable'
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();

            if (data.choices && data.choices[0] && data.choices[0].message) {
                const aiResponse = data.choices[0].message.content;

                // Êõ¥Êñ∞Â∞çË©±Ê≠∑Âè≤
                conversationHistory.push(userMessage);
                conversationHistory.push({
                    "role": "assistant",
                    "content": aiResponse
                });

                return aiResponse;
            } else {
                throw new Error('API ËøîÂõûÊ†ºÂºèÁï∞Â∏∏: ' + JSON.stringify(data));
            }
        }

        // ÁøªË≠ØËã±ÊñáÂè•Â≠êÁöÑÂáΩÊï∏
        async function translateEnglishSentences(parsedResponse) {
            const translations = {
                formal: { sentences: [] },
                casual: { sentences: [] }
            };

            // ÁøªË≠ØÊ≠£ÂºèÁâàËã±Êñá
            if (parsedResponse.formal && parsedResponse.formal.english) {
                const formalTranslation = await callTranslationAPI(parsedResponse.formal.english);
                translations.formal.sentences = parseTranslationResponse(formalTranslation);
            }

            // ÁøªË≠ØÂè£Ë™ûÁâàËã±Êñá
            if (parsedResponse.casual && parsedResponse.casual.english) {
                const casualTranslation = await callTranslationAPI(parsedResponse.casual.english);
                translations.casual.sentences = parseTranslationResponse(casualTranslation);
            }

            return translations;
        }

        // Ë™øÁî®ÁøªË≠ØAPI
        async function callTranslationAPI(englishText) {
            const userMessage = {
                "role": "user",
                "content": `Ë´ãÂ∞á‰ª•‰∏ãËã±ÊñáÊÆµËêΩÈÄêÂè•ÁøªË≠ØÊàêÁπÅÈ´î‰∏≠ÊñáÔºå‰øùÊåÅÂéüÊúâÁöÑÂè•Â≠êÁµêÊßãÂíåÈ†ÜÂ∫èÔºö

${englishText}

Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÂõûË¶ÜÔºåÊØèÂÄãËã±ÊñáÂè•Â≠êÂæåÈù¢Á∑äË∑üÂÖ∂‰∏≠ÊñáÁøªË≠ØÔºö
Ëã±ÊñáÂè•Â≠ê1
‰∏≠ÊñáÁøªË≠Ø1
Ëã±ÊñáÂè•Â≠ê2
‰∏≠ÊñáÁøªË≠Ø2
...‰ª•Ê≠§È°ûÊé®`
            };

            const requestBody = {
                "model": "qwen3-vl-flash",
                "messages": [userMessage],
                "max_tokens": 1000,
                "temperature": 0.3
            };

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'X-DashScope-SSE': 'disable'
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ÁøªË≠ØAPIÈåØË™§ ${response.status}: ${errorText}`);
            }

            const data = await response.json();

            if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content;
            } else {
                throw new Error('ÁøªË≠ØAPIËøîÂõûÊ†ºÂºèÁï∞Â∏∏: ' + JSON.stringify(data));
            }
        }

        // Ëß£ÊûêÁøªË≠ØÂõûÊáâ
        function parseTranslationResponse(translationText) {
            const lines = translationText.split('\n').filter(line => line.trim());
            const sentences = [];
            
            for (let i = 0; i < lines.length; i += 2) {
                if (i + 1 < lines.length) {
                    sentences.push({
                        english: lines[i].trim(),
                        chinese: lines[i + 1].trim()
                    });
                }
            }
            
            return sentences;
        }

        // Ëß£Êûê AI ÂõûÊáâÔºåÊèêÂèñÊ≠£ÂºèÁâàÂíåÂè£Ë™ûÁâàÁöÑËã±Êñá„ÄÅÁπÅÈ´î‰∏≠ÊñáÂíåËß£ÊûêÂÖßÂÆπ
        function parseAIResponse(response) {
            const result = {
                formal: { 
                    english: '',
                    chinese: '',
                    analyze: {
                        keyPoints: '',
                        grammarAnalysis: '',
                        vocabulary: [],
                        examples: []
                    }
                },
                casual: { 
                    english: '',
                    chinese: '',
                    analyze: {
                        keyPoints: '',
                        grammarAnalysis: '',
                        vocabulary: [],
                        examples: []
                    }
                }
            };

            // ÊèêÂèñÊ≠£ÂºèÁâàÂíåÊ≠£ÂºèÁâàËß£Êûê
            const formalSectionMatch = response.match(/„ÄêÊ≠£ÂºèÁâà„Äë\s*([\s\S]*?)(?=„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë|„ÄêÂè£Ë™ûÁâà„Äë|$)/i);
            const formalAnalyzeMatch = response.match(/„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë\s*([\s\S]*?)(?=„ÄêÂè£Ë™ûÁâà„Äë|$)/i);
            
            if (formalSectionMatch) {
                const formalContent = formalSectionMatch[1].trim();
                const lines = formalContent.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of lines) {
                    const trimmedLine = line.trim();
                    // ÈÅéÊøæÊéâ‰∏çÈúÄË¶ÅÁöÑÊ®ôË®òÊñáÂ≠ó
                    if (trimmedLine.includes('Ê≠£ÂºèÁâàÁøªË≠Ø') || trimmedLine.includes('---') || trimmedLine === '---') {
                        continue;
                    }
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^„Äê.*„Äë$/)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                result.formal.english = englishParts.join('\n').trim();
                result.formal.chinese = chineseParts.join('\n').trim();
            }

            if (formalAnalyzeMatch) {
                const analyzeContent = formalAnalyzeMatch[1].trim();
                parseAnalyzeContent(analyzeContent, result.formal.analyze);
            }

            // ÊèêÂèñÂè£Ë™ûÁâàÂíåÂè£Ë™ûÁâàËß£Êûê
            const casualSectionMatch = response.match(/„ÄêÂè£Ë™ûÁâà„Äë\s*([\s\S]*?)(?=„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë|$)/i);
            const casualAnalyzeMatch = response.match(/„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë\s*([\s\S]*?)$/i);
            
            if (casualSectionMatch) {
                const casualContent = casualSectionMatch[1].trim();
                const lines = casualContent.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of lines) {
                    const trimmedLine = line.trim();
                    // ÈÅéÊøæÊéâ‰∏çÈúÄË¶ÅÁöÑÊ®ôË®òÊñáÂ≠ó
                    if (trimmedLine.includes('Âè£Ë™ûÁâàÁøªË≠Ø') || trimmedLine.includes('---') || trimmedLine === '---') {
                        continue;
                    }
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^„Äê.*„Äë$/)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                result.casual.english = englishParts.join('\n').trim();
                result.casual.chinese = chineseParts.join('\n').trim();
            }

            if (casualAnalyzeMatch) {
                const analyzeContent = casualAnalyzeMatch[1].trim();
                parseAnalyzeContent(analyzeContent, result.casual.analyze);
            }

            // Â¶ÇÊûúÊ≤íÊúâÂåπÈÖçÂà∞ÔºåÂòóË©¶Á∞°ÂñÆÊ†ºÂºè
            if (!result.formal.english && !result.casual.english) {
                const allLines = response.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of allLines) {
                    const trimmedLine = line.trim();
                    // ÈÅéÊøæÊéâ‰∏çÈúÄË¶ÅÁöÑÊ®ôË®òÊñáÂ≠ó
                    if (trimmedLine.includes('Ê≠£ÂºèÁâàÁøªË≠Ø') || trimmedLine.includes('Âè£Ë™ûÁâàÁøªË≠Ø') || 
                        trimmedLine.includes('---') || trimmedLine === '---') {
                        continue;
                    }
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                if (englishParts.length > 0) {
                    result.formal.english = englishParts.join('\n').trim();
                }
                if (chineseParts.length > 0) {
                    result.formal.chinese = chineseParts.join('\n').trim();
                }
                
                if (!result.formal.english) {
                    result.formal.english = response;
                }
            }

            return result;
        }

        // Ëß£ÊûêËß£ÊûêÂÖßÂÆπ
        function parseAnalyzeContent(content, analyzeObj) {
            // ÊèêÂèñÈáçÈªûË™™Êòé
            const keyPointsMatch = content.match(/\[ÈáçÈªûË™™Êòé\]\s*([\s\S]*?)(?=\[Ë™ûÊ≥ïÁµêÊßã\]|\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i);
            if (keyPointsMatch) {
                analyzeObj.keyPoints = keyPointsMatch[1].trim();
            }

            // ÊèêÂèñË™ûÊ≥ïÁµêÊßãÂàÜÊûê
            const grammarMatch = content.match(/\[Ë™ûÊ≥ïÁµêÊßã[^]*?A2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûê[^]*?\]\s*([\s\S]*?)(?=\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i) ||
                                content.match(/\[Ë™ûÊ≥ïÁµêÊßã[^]*?\]\s*([\s\S]*?)(?=\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i);
            if (grammarMatch) {
                analyzeObj.grammarAnalysis = grammarMatch[1].trim();
            }

            // ÊèêÂèñË©ûÂΩôË°®
            const vocabularyMatch = content.match(/\[Ë©ûÂΩôË°®\][^]*?A2Á¥öÂà•[^]*?\s*([\s\S]*?)(?=\[‰æãÂè•\]|$)/i) ||
                                  content.match(/\[Ë©ûÂΩôË°®\]\s*([\s\S]*?)(?=\[‰æãÂè•\]|$)/i);
            if (vocabularyMatch) {
                const vocabText = vocabularyMatch[1].trim();
                // ÊèêÂèñÊâÄÊúâ‰ª• - ÈñãÈ†≠ÁöÑË°å
                const vocabLines = vocabText.split('\n')
                    .filter(line => {
                        const trimmed = line.trim();
                        return trimmed.startsWith('-') && trimmed.length > 1;
                    })
                    .map(line => line.replace(/^-\s*/, '').trim())
                    .filter(line => line.length > 0);
                analyzeObj.vocabulary = vocabLines;
            }

            // ÊèêÂèñ‰æãÂè•
            const examplesMatch = content.match(/\[‰æãÂè•\]\s*([\s\S]*?)$/i);
            if (examplesMatch) {
                const examplesText = examplesMatch[1].trim();
                // ÊèêÂèñÊâÄÊúâ‰ª•Êï∏Â≠óÈñãÈ†≠ÁöÑË°å
                const exampleLines = examplesText.split('\n')
                    .filter(line => {
                        const trimmed = line.trim();
                        return /^\d+\./.test(trimmed) && trimmed.length > 2;
                    })
                    .map(line => line.replace(/^\d+\.\s*/, '').trim())
                    .filter(line => line.length > 0);
                analyzeObj.examples = exampleLines;
            }
        }

        // Ê®ôÁ§∫ÈóúÈçµËã±ÊñáÂñÆÂ≠óÂíåÁâáË™û
        function highlightKeywords(text) {
            // Â∏∏Ë¶ãÁöÑ A2 Á¥öÂà•ÈóúÈçµË©ûÂíåÁâáË™û
            const keywords = [
                // Âü∫Êú¨ÂãïË©û
                'is', 'are', 'was', 'were', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'can', 'could', 'should', 'must',
                'go', 'come', 'get', 'make', 'take', 'give', 'put', 'see', 'look', 'watch', 'listen', 'hear', 'say', 'tell', 'speak', 'talk',
                'eat', 'drink', 'sleep', 'work', 'play', 'study', 'learn', 'teach', 'read', 'write', 'buy', 'sell', 'help', 'need', 'want', 'like', 'love',
                
                // Â∏∏Áî®ÂêçË©û
                'time', 'day', 'week', 'month', 'year', 'morning', 'afternoon', 'evening', 'night', 'today', 'tomorrow', 'yesterday',
                'home', 'house', 'room', 'kitchen', 'bedroom', 'bathroom', 'school', 'office', 'shop', 'store', 'restaurant', 'hospital',
                'family', 'friend', 'people', 'person', 'man', 'woman', 'child', 'children', 'boy', 'girl', 'baby',
                'food', 'water', 'coffee', 'tea', 'bread', 'rice', 'meat', 'fish', 'fruit', 'vegetable',
                'car', 'bus', 'train', 'plane', 'bike', 'phone', 'computer', 'book', 'table', 'chair', 'bed', 'door', 'window',
                
                // ÂΩ¢ÂÆπË©û
                'good', 'bad', 'big', 'small', 'long', 'short', 'tall', 'high', 'low', 'fast', 'slow', 'hot', 'cold', 'warm', 'cool',
                'new', 'old', 'young', 'easy', 'difficult', 'hard', 'soft', 'heavy', 'light', 'dark', 'bright', 'clean', 'dirty',
                'happy', 'sad', 'angry', 'tired', 'hungry', 'thirsty', 'busy', 'free', 'ready', 'sure', 'right', 'wrong',
                
                // ‰ªãË©ûÂíåÂâØË©û
                'in', 'on', 'at', 'to', 'from', 'with', 'without', 'for', 'about', 'under', 'over', 'between', 'behind', 'next to',
                'here', 'there', 'now', 'then', 'always', 'never', 'sometimes', 'often', 'usually', 'very', 'really', 'quite', 'too', 'also',
                
                // Â∏∏Áî®ÁâáË™û
                'how are you', 'nice to meet you', 'excuse me', 'thank you', 'you\'re welcome', 'i\'m sorry', 'no problem',
                'what time', 'how much', 'how many', 'how long', 'how often', 'what about', 'would you like', 'i would like',
                'there is', 'there are', 'used to', 'going to', 'have to', 'need to', 'want to', 'like to', 'love to',
                'look at', 'listen to', 'wait for', 'look for', 'think about', 'talk about', 'worry about', 'care about',
                'turn on', 'turn off', 'pick up', 'put down', 'get up', 'sit down', 'stand up', 'wake up', 'go out', 'come back',
                'right now', 'just now', 'a little', 'a lot', 'too much', 'not enough', 'of course', 'by the way', 'at least', 'at most'
            ];

            let highlightedText = text;
            
            // ÊåâÈï∑Â∫¶ÊéíÂ∫èÔºåÂÖàËôïÁêÜÈï∑ÁâáË™û
            keywords.sort((a, b) => b.length - a.length);
            
            keywords.forEach(keyword => {
                // ÂâµÂª∫Ê≠£ÂâáË°®ÈÅîÂºèÔºåÂåπÈÖçÂÆåÊï¥ÂñÆË©ûÊàñÁâáË™ûÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="keyword-highlight">$&</span>`);
            });
            
            return highlightedText;
        }

        // ÈóúÈñâÁõ∏Ê©üÂíåÈ†êË¶Ω
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.style.display = 'none';
            previewImage.style.display = 'none';
        }

        // ÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
        function restartCamera() {
            startCamera();
            // Á¢∫‰øùvideoÂÖÉÁ¥†È°ØÁ§∫
            video.style.display = 'block';
            // Èö±ËóèÈ†êË¶ΩÂúñÁâáÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
            previewImage.style.display = 'none';
        }

        // Ë™ûÈü≥ÂêàÊàêÔºàËÆÄÂèñËã±ÊñáÔºâ
        function speakText(text, lang = 'en-US') {
            if (!('speechSynthesis' in window)) {
                console.log('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥ÂêàÊàê');
                return;
            }

            // ÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ
            window.speechSynthesis.cancel();

            // ÂÖàÈÅéÊøæÊéâÁâπÂÆöÁöÑ‰∏≠ÊñáÂ≠ó‰∏≤
            let filteredText = text.replace(/Âè£Ë™ûÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '').replace(/Ê≠£ÂºèÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '');
            
            // ÈÅéÊøæÊéâ‰∏≠ÊñáÂ≠óÁ¨¶ÔºåÂè™‰øùÁïôËã±ÊñáÂ≠óÁ¨¶„ÄÅÊï∏Â≠ó„ÄÅÊ®ôÈªûÁ¨¶ËôüÂíåÁ©∫Ê†º
            const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
            
            if (!englishOnlyText) {
                console.log('Ê≤íÊúâËã±ÊñáÂÖßÂÆπÂèØ‰ª•ÊúóËÆÄ');
                return;
            }

            // Ê™¢Êü•ÊòØÂê¶ÂïüÁî®ËÉåÊôØÊúóËÆÄÊ®°Âºè
            const isBackgroundMode = backgroundSpeechCheckbox.checked;
            
            // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈóúÈñâÁõ∏Ê©ü
            if (!isBackgroundMode) {
                stopCamera();
            }

            const utterance = new SpeechSynthesisUtterance(englishOnlyText);
            utterance.lang = lang;
            utterance.volume = 0.8;
            utterance.rate = parseFloat(speechRateSlider.value); // ‰ΩøÁî®Áî®Êà∂Ë®≠ÂÆöÁöÑË™ûÈÄü
            utterance.pitch = 1;

            // ÈÅ∏ÊìáÂêàÈÅ©ÁöÑË™ûÈü≥ÔºàËã±ÊñáÔºâ
            const getVoices = () => {
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÁæéÂºèËã±Ë™ûÔºåÊâæ‰ªªÊÑèËã±Ë™ûË™ûÈü≥
                    const anyEnglish = voices.find(v => v.lang.startsWith('en'));
                    if (anyEnglish) {
                        utterance.voice = anyEnglish;
                    }
                }
                window.speechSynthesis.speak(utterance);
            };

            // Á¢∫‰øùË™ûÈü≥ÂàóË°®Â∑≤Âä†Ëºâ
            if (window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.onvoiceschanged = getVoices;
            } else {
                getVoices();
            }

            utterance.onstart = () => {
                status.textContent = isBackgroundMode ? 'Ê≠£Âú®ËÉåÊôØÊúóËÆÄËã±Êñá...' : 'Ê≠£Âú®ÊúóËÆÄËã±Êñá...';
            };

            utterance.onend = () => {
                status.textContent = 'ÊúóËÆÄÂÆåÊàê';
                // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                if (!isBackgroundMode) {
                    setTimeout(() => {
                        restartCamera();
                    }, 1000); // Âª∂ÈÅ≤1ÁßíÂæåÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                }
            };

            utterance.onerror = (event) => {
                console.error('Ë™ûÈü≥ÂêàÊàêÈåØË™§:', event.error);
                status.textContent = 'ÊúóËÆÄÂ§±Êïó';
                // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                if (!isBackgroundMode) {
                    setTimeout(() => {
                        restartCamera();
                    }, 1000);
                }
            };
        }

        // ÂñÆÂè•ÊúóËÆÄ‰∏¶È´ò‰∫Æ
        function speakSentenceWithHighlight(text, element) {
            if (!('speechSynthesis' in window)) {
                console.log('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥ÂêàÊàê');
                return;
            }

            // ÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ‰∏¶Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
            window.speechSynthesis.cancel();
            clearAllHighlights();

            // Ê™¢Êü•ÊòØÂê¶ÂïüÁî®ËÉåÊôØÊúóËÆÄÊ®°Âºè
            const isBackgroundMode = backgroundSpeechCheckbox.checked;
            
            // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈóúÈñâÁõ∏Ê©ü
            if (!isBackgroundMode) {
                stopCamera();
            }

            // ÈÅéÊøæÊñáÊú¨
            let filteredText = text.replace(/Âè£Ë™ûÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '').replace(/Ê≠£ÂºèÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '');
            const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
            
            if (!englishOnlyText) {
                console.log('Ê≤íÊúâËã±ÊñáÂÖßÂÆπÂèØ‰ª•ÊúóËÆÄ');
                // Â¶ÇÊûúÊ≤íÊúâÂÖßÂÆπ‰∏îÈùûËÉåÊôØÊ®°ÂºèÔºåÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                if (!isBackgroundMode) {
                    setTimeout(() => {
                        restartCamera();
                    }, 500);
                }
                return;
            }

            // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
            element.classList.add('speaking');

            const utterance = new SpeechSynthesisUtterance(englishOnlyText);
            utterance.lang = 'en-US';
            utterance.volume = 0.8;
            utterance.rate = parseFloat(speechRateSlider.value);
            utterance.pitch = 1;

            utterance.onstart = () => {
                status.textContent = (isBackgroundMode ? 'Ê≠£Âú®ËÉåÊôØÊúóËÆÄ: ' : 'Ê≠£Âú®ÊúóËÆÄ: ') + englishOnlyText.substring(0, 30) + '...';
            };

            utterance.onend = () => {
                element.classList.remove('speaking');
                status.textContent = 'ÊúóËÆÄÂÆåÊàê';
                // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                if (!isBackgroundMode) {
                    setTimeout(() => {
                        restartCamera();
                    }, 1000);
                }
            };

            utterance.onerror = (event) => {
                element.classList.remove('speaking');
                console.error('Ë™ûÈü≥ÂêàÊàêÈåØË™§:', event.error);
                status.textContent = 'ÊúóËÆÄÂ§±Êïó';
                // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                if (!isBackgroundMode) {
                    setTimeout(() => {
                        restartCamera();
                    }, 1000);
                }
            };

            // ÈÅ∏ÊìáË™ûÈü≥‰∏¶Êí≠Êîæ
            const voices = window.speechSynthesis.getVoices();
            const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US'));
            if (englishVoice) {
                utterance.voice = englishVoice;
            }

            window.speechSynthesis.speak(utterance);
        }

        // ÊúóËÆÄÊâÄÊúâÂè•Â≠ê
        function speakAllSentences(sentences) {
            if (!sentences || sentences.length === 0) return;

            // ÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ‰∏¶Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
            window.speechSynthesis.cancel();
            clearAllHighlights();
            
            // Ê™¢Êü•ÊòØÂê¶ÂïüÁî®ËÉåÊôØÊúóËÆÄÊ®°Âºè
            const isBackgroundMode = backgroundSpeechCheckbox.checked;
            
            // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈóúÈñâÁõ∏Ê©ü
            if (!isBackgroundMode) {
                stopCamera();
            }

            let currentIndex = 0;

            function speakNext() {
                if (currentIndex >= sentences.length) {
                    // ÂÖ®ÈÉ®ÊúóËÆÄÂÆåÊàê
                    status.textContent = 'ÂÖ®ÈÉ®ÊúóËÆÄÂÆåÊàê';
                    // ÈáãÊîæ wake lock
                    if (isBackgroundMode) {
                        releaseWakeLock();
                    }
                    // Âè™ÊúâÂú®ÈùûËÉåÊôØÊ®°Âºè‰∏ãÊâçÈáçÊñ∞ÂïüÂãïÁõ∏Ê©ü
                    if (!isBackgroundMode) {
                        setTimeout(() => {
                            restartCamera();
                        }, 1000);
                    }
                    return;
                }

                const sentence = sentences[currentIndex];
                const element = sentence.element;
                const text = sentence.text;

                // ÈÅéÊøæÊñáÊú¨
                let filteredText = text.replace(/Âè£Ë™ûÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '').replace(/Ê≠£ÂºèÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø/g, '');
                const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();

                if (!englishOnlyText) {
                    currentIndex++;
                    speakNext();
                    return;
                }

                // Ê∏ÖÈô§‰πãÂâçÁöÑÈ´ò‰∫ÆÔºåÊ∑ªÂä†Áï∂ÂâçÈ´ò‰∫Æ
                clearAllHighlights();
                element.classList.add('speaking');
                
                // ÊªæÂãïÂà∞Áï∂ÂâçÂè•Â≠ê
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });

                const utterance = new SpeechSynthesisUtterance(englishOnlyText);
                utterance.lang = 'en-US';
                utterance.volume = 0.8;
                utterance.rate = parseFloat(speechRateSlider.value);
                utterance.pitch = 1;

                utterance.onstart = () => {
                    const prefix = isBackgroundMode ? 'Ê≠£Âú®ËÉåÊôØÊúóËÆÄ' : 'Ê≠£Âú®ÊúóËÆÄ';
                    status.textContent = `${prefix} (${currentIndex + 1}/${sentences.length}): ${englishOnlyText.substring(0, 30)}...`;
                };

                utterance.onend = () => {
                    element.classList.remove('speaking');
                    currentIndex++;
                    // Âª∂ÈÅ≤‰∏ÄÈªûÂÜçÊúóËÆÄ‰∏ã‰∏ÄÂè•
                    setTimeout(speakNext, 500);
                };

                utterance.onerror = (event) => {
                    element.classList.remove('speaking');
                    console.error('Ë™ûÈü≥ÂêàÊàêÈåØË™§:', event.error);
                    currentIndex++;
                    setTimeout(speakNext, 500);
                };

                // ÈÅ∏ÊìáË™ûÈü≥‰∏¶Êí≠Êîæ
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }

                window.speechSynthesis.speak(utterance);
            }

            speakNext();
        }

        // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫ÆÊïàÊûú
        function clearAllHighlights() {
            const speakingElements = document.querySelectorAll('.ai-response-english.speaking');
            speakingElements.forEach(element => {
                element.classList.remove('speaking');
            });
        }

        // Â∞áÊñáÊú¨ÊãÜÂàÜÊàêÂè•Â≠ê
        function splitIntoSentences(text) {
            if (!text) return [];
            
            // ‰ΩøÁî®Ê≠£ÂâáË°®ÈÅîÂºèÊãÜÂàÜÂè•Â≠êÔºå‰øùÁïôÂè•Ëôü„ÄÅÂïèËôü„ÄÅÈ©öÂòÜËôü
            const sentences = text.split(/(?<=[.!?])\s+/)
                .map(sentence => sentence.trim())
                .filter(sentence => sentence.length > 0);
            
            return sentences;
        }

        // Ê∏ÖÈô§Â∞çË©±ÂçÄÂüüÁöÑË≥áÊñô
        function clearConversationData() {
            // ÂÅúÊ≠¢‰ªª‰ΩïÊ≠£Âú®ÈÄ≤Ë°åÁöÑÊúóËÆÄ
            window.speechSynthesis.cancel();
            clearAllHighlights();
            
            // Ê∏ÖÈô§Â∞çË©±ÂçÄÂüüÂÖßÂÆπÔºå‰ΩÜ‰øùÁïôÁ©∫ÁãÄÊÖãÊèêÁ§∫
            const conversation = document.getElementById('conversation');
            conversation.innerHTML = '<div class="empty-state">ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÂ∞çË©±ÔºåÊãçÁÖß‰∏¶ÈÄÅÂá∫ÂàÜÊûêÂêßÔºÅ</div>';
        }



        // ÊåâÈàï‰∫ã‰ª∂
        captureBtn.addEventListener('click', capturePhoto);
        
        // ÈáçÊñ∞ËºâÂÖ•ÊåâÈàï‰∫ã‰ª∂
        reloadBtn.addEventListener('click', () => {
            location.reload();
        });

        // ÈÄÅÂá∫ÁÖßÁâáÊåâÈàï‰∫ã‰ª∂
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (!currentImageData) {
                status.textContent = 'Ë´ãÂÖàÊãçÁÖß';
                return;
            }

            // Áõ¥Êé•ËôïÁêÜÁÖßÁâáÊèê‰∫§
            handlePhotoSubmit();
        });

        // API ÈÖçÁΩÆ‰∫ã‰ª∂
        apiKeyInput.addEventListener('input', (e) => {
            apiKey = e.target.value.trim();
            // Â¶ÇÊûúÂãæÈÅ∏‰∫Ü‰øùÂ≠òÔºåÂ∞±‰øùÂ≠òÂà∞ localStorage
            if (saveApiKeyCheckbox.checked && apiKey) {
                localStorage.setItem('qwen_api_key', apiKey);
            } else if (!saveApiKeyCheckbox.checked) {
                localStorage.removeItem('qwen_api_key');
            }
        });

        saveApiKeyCheckbox.addEventListener('change', (e) => {
            if (e.target.checked && apiKey) {
                // ‰øùÂ≠òÂà∞ localStorage
                localStorage.setItem('qwen_api_key', apiKey);
            } else {
                // Âæû localStorage ÁßªÈô§
                localStorage.removeItem('qwen_api_key');
            }
        });

        // ÁâàÊú¨ÈÅ∏ÊìáËÆäÊõ¥ÊôÇ‰øùÂ≠òÂà∞ localStorage
        showFormalCheckbox.addEventListener('change', (e) => {
            localStorage.setItem('showFormal', e.target.checked.toString());
        });

        showCasualCheckbox.addEventListener('change', (e) => {
            localStorage.setItem('showCasual', e.target.checked.toString());
        });

        // Ë™ûÈü≥ÈÄüÂ∫¶ÊªëÊ°ø‰∫ã‰ª∂
        speechRateSlider.addEventListener('input', (e) => {
            const rate = e.target.value;
            speechRateValue.textContent = rate + 'x';
            localStorage.setItem('speechRate', rate);
        });

        // ËÉåÊôØÊúóËÆÄÈÅ∏È†ÖËÆäÊõ¥‰∫ã‰ª∂
        backgroundSpeechCheckbox.addEventListener('change', (e) => {
            localStorage.setItem('backgroundSpeech', e.target.checked.toString());
            if (e.target.checked) {
                status.textContent = 'Â∑≤ÂïüÁî®ËÉåÊôØÊúóËÆÄÊ®°Âºè';
            } else {
                status.textContent = 'Â∑≤ÈóúÈñâËÉåÊôØÊúóËÆÄÊ®°Âºè';
            }
        });

        // Â±ïÈñã/Êî∂Á∏ÆÈÖçÁΩÆÂçÄÂüü
        configToggle.addEventListener('click', () => {
            const isExpanded = apiConfig.classList.contains('expanded');
            if (isExpanded) {
                apiConfig.classList.remove('expanded');
                toggleBtn.textContent = '+';
                localStorage.setItem('configExpanded', 'false');
            } else {
                apiConfig.classList.add('expanded');
                toggleBtn.textContent = '-';
                localStorage.setItem('configExpanded', 'true');
            }
        });

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂïüÂãïÁõ∏Ê©ü
        if (hasGetUserMedia) {
            startCamera();
        } else {
            status.textContent = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Áõ∏Ê©üÂäüËÉΩ';
        }

        // È†ÅÈù¢Âç∏ËºâÊôÇÂÅúÊ≠¢Áõ∏Ê©ü
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßÊîπËÆäÊôÇ‰øùÊåÅÁõ∏Ê©üÈñãÂïüÔºàÈÅøÂÖçÂàáÊèõÊ®ôÁ±§È†ÅÊôÇÈóúÈñâÔºâ
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && stream && stream.active) {
                // È†ÅÈù¢ÈáçÊñ∞ÂèØË¶ãÊôÇÔºåÁ¢∫‰øù video ÂÖÉÁ¥†È°ØÁ§∫ stream
                if (video.srcObject !== stream) {
                    video.srcObject = stream;
                }
            }
            
            // Â¶ÇÊûúÂïüÁî®ËÉåÊôØÊúóËÆÄÊ®°ÂºèÔºåÂú®È†ÅÈù¢Èö±ËóèÊôÇ‰øùÊåÅË™ûÈü≥ÂêàÊàêÊ¥ªË∫ç
            if (document.hidden && backgroundSpeechCheckbox.checked) {
                // Èò≤Ê≠¢È†ÅÈù¢Ë¢´Êö´ÂÅúÔºå‰øùÊåÅË™ûÈü≥ÂêàÊàêÈÅãË°å
                keepSpeechActive();
            }
        });

        // ‰øùÊåÅË™ûÈü≥ÂêàÊàêÂú®ËÉåÊôØÈÅãË°åÁöÑÂáΩÊï∏
        function keepSpeechActive() {
            // ÂâµÂª∫‰∏ÄÂÄãÈùúÈü≥ÁöÑË™ûÈü≥‰æÜ‰øùÊåÅ speechSynthesis Ê¥ªË∫ç
            if (window.speechSynthesis && backgroundSpeechCheckbox.checked) {
                const keepAlive = new SpeechSynthesisUtterance(' ');
                keepAlive.volume = 0; // ÈùúÈü≥
                keepAlive.rate = 10; // Âø´ÈÄüÊí≠Êîæ
                keepAlive.onend = () => {
                    // Â¶ÇÊûú‰ªçÂú®ËÉåÊôØÊ®°Âºè‰∏îÊúâË™ûÈü≥Âú®Êí≠ÊîæÔºåÁπºÁ∫å‰øùÊåÅÊ¥ªË∫ç
                    if (document.hidden && backgroundSpeechCheckbox.checked && window.speechSynthesis.speaking) {
                        setTimeout(keepSpeechActive, 5000); // ÊØè5ÁßíÈáçË§á‰∏ÄÊ¨°
                    }
                };
                window.speechSynthesis.speak(keepAlive);
            }
        }

        // Èò≤Ê≠¢È†ÅÈù¢Âú®ËÉåÊôØÊúóËÆÄÊôÇÈÄ≤ÂÖ•Áù°Áú†Ê®°Âºè
        let wakeLock = null;
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator && backgroundSpeechCheckbox.checked) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock Â∑≤ÂïüÁî®ÔºåÈò≤Ê≠¢Ëû¢ÂπïÈóúÈñâ');
                } catch (err) {
                    console.log('Wake lock Ë´ãÊ±ÇÂ§±Êïó:', err);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake lock Â∑≤ÈáãÊîæ');
            }
        }

        // Âú®ÈñãÂßãÊúóËÆÄÊôÇË´ãÊ±Ç wake lock
        const originalSpeakAllSentences = speakAllSentences;
        speakAllSentences = function(sentences) {
            if (backgroundSpeechCheckbox.checked) {
                requestWakeLock();
            }
            return originalSpeakAllSentences.call(this, sentences);
        };
    </script>
</body>
</html>
