<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë™ûÈü≥ÊãçÁÖßÂ∞çË©±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 13px;
            margin: 0;
        }

        .config-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            user-select: none;
        }

        .config-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .config-toggle-btn {
            font-size: 16px;
            font-weight: bold;
            color: white;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
        }

        .config-toggle-text {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .api-config {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .api-config.expanded {
            display: flex;
        }

        .api-config input[type="password"],
        .api-config input[type="text"] {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.9);
        }

        .api-config input[type="password"]:focus,
        .api-config input[type="text"]:focus {
            outline: none;
            background: white;
        }

        .save-key-option {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
            margin-top: 5px;
        }

        .save-key-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .version-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .version-select-title {
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .version-checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .version-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            font-size: 12px;
        }

        .version-checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .speech-rate-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .speech-rate-title {
            color: white;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .speech-rate-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speech-rate-label {
            color: white;
            font-size: 11px;
            min-width: 20px;
            text-align: center;
        }

        .speech-rate-slider {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            cursor: pointer;
        }

        .speech-rate-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .speech-rate-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .speech-rate-value {
            color: white;
            font-size: 11px;
            text-align: center;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 40px;
        }

        .keyword-highlight {
            color: #2196F3;
            font-weight: 600;
            background: rgba(33, 150, 243, 0.1);
            padding: 1px 3px;
            border-radius: 3px;
        }

        .message-text.ai {
            background: #f0f0f0;
            color: #333;
            margin-left: 0;
            text-align: left;
        }

        .ai-response-section {
            margin-bottom: 15px;
        }

        .ai-response-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 5px;
            color: #555;
        }

        .ai-response-content {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
        }

        .ai-response-content.formal {
            border-left-color: #667eea;
        }

        .ai-response-content.casual {
            border-left-color: #ff6b6b;
        }

        .ai-response-english {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #2196F3;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .ai-response-english:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .ai-response-english:active {
            background-color: rgba(102, 126, 234, 0.2);
        }

        .ai-response-analyze-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            margin: 8px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .ai-response-analyze-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .ai-response-analyze-toggle-btn {
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
        }

        .ai-response-analyze-toggle-text {
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .ai-response-analyze {
            display: none;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .ai-response-analyze.expanded {
            display: block;
        }

        .analyze-section {
            margin-bottom: 15px;
        }

        .analyze-section:last-child {
            margin-bottom: 0;
        }

        .analyze-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #667eea;
        }

        .analyze-content {
            font-size: 13px;
            line-height: 1.6;
            color: #555;
        }

        .vocabulary-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .vocabulary-item {
            padding: 4px 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .vocabulary-word {
            font-weight: 600;
            color: #667eea;
        }

        .vocabulary-pos {
            font-size: 12px;
            color: #888;
            margin: 0 4px;
        }

        .example-list {
            list-style: decimal;
            padding-left: 20px;
            margin: 8px 0;
        }

        .example-item {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 6px;
            color: #555;
        }

        .ai-response-chinese {
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
        }

        .loading-indicator {
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 14px;
        }

        .conversation {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 15px;
            min-height: 400px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
            width: 100%;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message-image {
            width: 100%;
            max-width: 100%;
            max-height: 50vh;
            height: auto;
            border-radius: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: contain;
        }

        .message-text {
            background: #f0f0f0;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            color: #333;
            font-size: clamp(14px, 3vw, 16px);
            word-wrap: break-word;
            max-width: 90%;
            margin-bottom: 8px;
            width: fit-content;
        }

        .message-text.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .camera-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .camera-preview {
            width: 100%;
            max-width: 200px;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
            background: #000;
        }

        .preview-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 1px #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            font-family: inherit;
        }

        .btn-capture {
            background: #667eea;
            color: white;
            flex: 1;
            max-width: 150px;
        }

        .btn-capture:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-capture:active {
            transform: scale(0.95);
        }

        .btn-record {
            background: #ff6b6b;
            color: white;
            flex: 1;
            max-width: 200px;
            position: relative;
        }

        .btn-record:hover:not(:active) {
            background: #ee5a5a;
        }

        .btn-record:active,
        .btn-record.recording {
            background: #dc3545;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
        }

        .btn-record.recording::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .status {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            font-size: 16px;
        }

        /* È°ØÁ§∫ video È†êË¶Ω */
        #videoElement {
            width: 100%;
            max-width: 200px;
            height: 150px;
            border-radius: 12px;
            object-fit: cover;
            margin: 0 auto 15px;
            display: block;
            background: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Ë™ûÈü≥ÊãçÁÖßÂ∞çË©±</h1>
            <p>ÊãçÁÖß‰∏¶Ë™™Âá∫‰Ω†ÁöÑÊÉ≥Ê≥ï</p>
            <div class="config-toggle" id="configToggle">
                <div class="config-toggle-btn" id="toggleBtn">+</div>
                <div class="config-toggle-text">Ë®≠ÂÆö</div>
            </div>
            <div class="api-config" id="apiConfig">
                <input type="password" id="apiKey" placeholder="Ë´ãËº∏ÂÖ• API Key" />
                <div class="save-key-option">
                    <input type="checkbox" id="saveApiKey" />
                    <label for="saveApiKey">Â∞á key Â≠òÂú®ÁÄèË¶ΩÂô®Á´Ø</label>
                </div>
                <div class="version-select">
                    <div class="version-select-title">ÂõûË¶ÜÁâàÊú¨ÈÅ∏ÊìáÔºö</div>
                    <div class="version-checkbox-group">
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showFormal" />
                            <label for="showFormal">Ê≠£ÂºèÁâà (Formal)</label>
                        </div>
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showCasual" />
                            <label for="showCasual">Âè£Ë™ûÁâà (Casual)</label>
                        </div>
                    </div>
                </div>
                <div class="speech-rate-control">
                    <div class="speech-rate-title">Ë™ûÈü≥Êí≠ÊîæÈÄüÂ∫¶Ôºö</div>
                    <div class="speech-rate-slider-container">
                        <span class="speech-rate-label">ÊÖ¢</span>
                        <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.8" class="speech-rate-slider" />
                        <span class="speech-rate-label">Âø´</span>
                    </div>
                    <div class="speech-rate-value" id="speechRateValue">0.8x</div>
                </div>
            </div>
        </div>

        <div class="conversation" id="conversation">
            <div class="empty-state">ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÂ∞çË©±ÔºåÈñãÂßã‰ΩøÁî®ÂêßÔºÅ</div>
        </div>
    </div>

    <div class="camera-controls">
        <div class="preview-toggle">
            <span>Áõ∏Ê©üÈ†êË¶Ω</span>
            <label class="toggle-switch">
                <input type="checkbox" id="previewToggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement" style="display: none;"></canvas>
        <img id="previewImage" class="camera-preview" alt="È†êË¶Ω" style="display: none;">
        
        <div class="button-group">
            <button class="btn btn-capture" id="captureBtn">üì∑ ÊãçÁÖß</button>
            <button class="btn btn-record" id="recordBtn">üé§ Êåâ‰ΩèË™™Ë©±</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const conversation = document.getElementById('conversation');
        const captureBtn = document.getElementById('captureBtn');
        const recordBtn = document.getElementById('recordBtn');
        const status = document.getElementById('status');
        const previewImage = document.getElementById('previewImage');
        const previewToggle = document.getElementById('previewToggle');

        let stream = null;
        let currentImageData = null;
        let recognition = null;
        let isRecording = false;
        
        // API Áõ∏ÈóúËÆäÊï∏
        let apiKey = '';
        // Âõ∫ÂÆö‰ΩøÁî®Êñ∞Âä†Âù°Âú∞ÂçÄÔºåÁõ¥Êé•Ë™øÁî®
        const apiUrl = 'https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions';
        let conversationHistory = [];
        const apiKeyInput = document.getElementById('apiKey');
        const saveApiKeyCheckbox = document.getElementById('saveApiKey');
        const showFormalCheckbox = document.getElementById('showFormal');
        const showCasualCheckbox = document.getElementById('showCasual');
        const configToggle = document.getElementById('configToggle');
        const apiConfig = document.getElementById('apiConfig');
        const toggleBtn = document.getElementById('toggleBtn');
        const speechRateSlider = document.getElementById('speechRate');
        const speechRateValue = document.getElementById('speechRateValue');
        
        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑ API Key
        const savedApiKey = localStorage.getItem('qwen_api_key');
        if (savedApiKey) {
            apiKey = savedApiKey;
            apiKeyInput.value = savedApiKey;
            saveApiKeyCheckbox.checked = true;
        }

        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑÁâàÊú¨ÈÅ∏Êìá
        const savedShowFormal = localStorage.getItem('showFormal');
        const savedShowCasual = localStorage.getItem('showCasual');
        if (savedShowFormal !== null) {
            showFormalCheckbox.checked = savedShowFormal === 'true';
        } else {
            showFormalCheckbox.checked = true; // È†êË®≠ÈÅ∏‰∏≠
        }
        if (savedShowCasual !== null) {
            showCasualCheckbox.checked = savedShowCasual === 'true';
        } else {
            showCasualCheckbox.checked = true; // È†êË®≠ÈÅ∏‰∏≠
        }

        // Âæû localStorage ËºâÂÖ•‰øùÂ≠òÁöÑË™ûÈü≥ÈÄüÂ∫¶
        const savedSpeechRate = localStorage.getItem('speechRate');
        if (savedSpeechRate !== null) {
            speechRateSlider.value = savedSpeechRate;
            speechRateValue.textContent = savedSpeechRate + 'x';
        }

        // Âæû localStorage ËºâÂÖ•ÈÖçÁΩÆÂçÄÂüüÂ±ïÈñãÁãÄÊÖãÔºàÈ†êË®≠Êî∂Á∏ÆÔºâ
        const savedConfigExpanded = localStorage.getItem('configExpanded');
        if (savedConfigExpanded === 'true') {
            apiConfig.classList.add('expanded');
            toggleBtn.textContent = '-';
        }

        // Ê™¢Êü•ÁÄèË¶ΩÂô®ÊîØÊè¥
        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        const hasSpeechRecognition = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;

        // ÂàùÂßãÂåñË™ûÈü≥Ë≠òÂà•
        if (hasSpeechRecognition) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                handleVoiceInput(transcript);
            };

            recognition.onerror = function(event) {
                status.textContent = 'Ë™ûÈü≥Ë≠òÂà•ÈåØË™§: ' + event.error;
                isRecording = false;
                recordBtn.classList.remove('recording');
            };

            recognition.onend = function() {
                isRecording = false;
                recordBtn.classList.remove('recording');
            };
        }

        // ÂïüÂãïÁõ∏Ê©üÔºàÂè™ÂïüÂãï‰∏ÄÊ¨°Ôºå‰øùÊåÅÈñãÂïüÔºâ
        async function startCamera() {
            try {
                // Â¶ÇÊûúÂ∑≤Á∂ìÊúâ stream Âú®ÈÅãË°åÔºåÂÖà‰∏çÈóúÈñâÔºå‰øùÊåÅÈñãÂïüÁãÄÊÖã
                if (stream) {
                    video.srcObject = stream;
                    status.textContent = 'Áõ∏Ê©üÂ∑≤Â∞±Á∑í';
                    return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // ‰ΩøÁî®ÂæåÁΩÆÁõ∏Ê©ü
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                video.srcObject = stream;
                status.textContent = 'Áõ∏Ê©üÂ∑≤Â∞±Á∑í';
            } catch (err) {
                status.textContent = 'ÁÑ°Ê≥ïÂïüÂãïÁõ∏Ê©ü: ' + err.message;
                console.error('Camera error:', err);
            }
        }

        // ÊãçÁÖß
        function capturePhoto() {
            if (!stream) {
                status.textContent = 'Ë´ãÂÖàÂïüÂãïÁõ∏Ê©ü';
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // ËΩâÊèõÁÇ∫ base64
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Èö±Ëóè video È†êË¶ΩÔºåÈ°ØÁ§∫ÊãçÊîùÁöÑÁÖßÁâáÈ†êË¶Ω
            video.style.display = 'none';
            previewImage.src = currentImageData;
            previewImage.style.display = 'block';
            
            status.textContent = 'ÁÖßÁâáÂ∑≤ÊãçÊîùÔºåÂèØ‰ª•ÈñãÂßãË™™Ë©±';
        }

        // ËôïÁêÜË™ûÈü≥Ëº∏ÂÖ•
        async function handleVoiceInput(text) {
            if (currentImageData) {
                // È°ØÁ§∫Áî®Êà∂Ë®äÊÅØ
                addUserMessage(currentImageData, text);
                
                // Ê™¢Êü• API Key
                if (!apiKey) {
                    status.textContent = 'Ë´ãÂÖàËº∏ÂÖ• API Key';
                    resetForNextCapture();
                    return;
                }
                
                // Ë™øÁî® qwen-vl-plus API
                try {
                    status.textContent = 'Ê≠£Âú®ËôïÁêÜ...';
                    const aiResponse = await callQwenVLPlus(currentImageData, text);
                    
                    // È°ØÁ§∫ AI ÂõûÊáâ
                    const parsedResponse = parseAIResponse(aiResponse);
                    addAIMessage(aiResponse);
                    
                    // Ë™ûÈü≥ÊúóËÆÄËã±ÊñáÔºàÊ†πÊìöÁî®Êà∂ÈÅ∏ÊìáÔºöÂÑ™ÂÖàËÆÄÂè£Ë™ûÁâàÔºåÂ¶ÇÊûúÊ≤íÊúâÂâáËÆÄÊ≠£ÂºèÁâàÔºâ
                    let textToSpeak = '';
                    const showCasual = showCasualCheckbox.checked;
                    const showFormal = showFormalCheckbox.checked;
                    
                    // ÂÑ™ÂÖàËÆÄÂè£Ë™ûÁâà
                    if (showCasual && parsedResponse.casual && parsedResponse.casual.english) {
                        textToSpeak = parsedResponse.casual.english;
                    } else if (showFormal && parsedResponse.formal && parsedResponse.formal.english) {
                        // Â¶ÇÊûúÊ≤íÊúâÂè£Ë™ûÁâàÊàñÊú™ÈÅ∏ÊìáÂè£Ë™ûÁâàÔºåÂâáËÆÄÊ≠£ÂºèÁâà
                        textToSpeak = parsedResponse.formal.english;
                    }
                    
                    if (textToSpeak) {
                        speakText(textToSpeak, 'en-US');
                    }
                    
                } catch (error) {
                    status.textContent = 'ÈåØË™§: ' + error.message;
                    console.error('API Ë™øÁî®Â§±Êïó:', error);
                }
                
                // ÈáçÁΩÆÁãÄÊÖãÔºåÊ∫ñÂÇô‰∏ã‰∏ÄÊ¨°ÊãçÁÖß
                resetForNextCapture();
            } else {
                status.textContent = 'Ë´ãÂÖàÊãçÁÖß';
            }
        }

        // ÈáçÁΩÆÁãÄÊÖãÔºåÊ∫ñÂÇô‰∏ã‰∏ÄÊ¨°ÊãçÁÖß
        function resetForNextCapture() {
            currentImageData = null;
            previewImage.style.display = 'none';
            // ÊÅ¢Âæ© video È†êË¶ΩÔºàÊ†πÊìöÈñãÈóúÁãÄÊÖãÔºâ
            video.style.display = previewToggle.checked ? 'block' : 'none';
            status.textContent = 'Â∑≤ÈáçÁΩÆÔºåÂèØ‰ª•ÂÜçÊ¨°ÊãçÁÖß';
        }

        // Ê∑ªÂä†Áî®Êà∂Ë®äÊÅØÂà∞Â∞çË©±
        function addUserMessage(imageData, text) {
            // ÁßªÈô§Á©∫ÁãÄÊÖã
            const emptyState = conversation.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // ÂÖàÊ∑ªÂä†ÊñáÂ≠óÔºàÊúÉÈ°ØÁ§∫Âú®‰∏äÊñπÔºâ
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text user';
            textDiv.textContent = text;

            // ÂÜçÊ∑ªÂä†ÁÖßÁâáÔºàÊúÉÈ°ØÁ§∫Âú®‰∏ãÊñπÔºâ
            const img = document.createElement('img');
            img.src = imageData;
            img.className = 'message-image';
            img.alt = 'ÊãçÊîùÁöÑÁÖßÁâá';

            // ÂÖàÊ∑ªÂä†ÊñáÂ≠óÔºåÂÜçÊ∑ªÂä†ÁÖßÁâá
            messageDiv.appendChild(textDiv);
            messageDiv.appendChild(img);

            conversation.appendChild(messageDiv);
            
            // ÊªæÂãïÂà∞Â∫ïÈÉ®
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Ê™¢Êü•ÊòØÂê¶ÊúâËß£ÊûêÂÖßÂÆπ
        function hasAnalyzeContent(analyze) {
            return analyze.keyPoints || analyze.grammarAnalysis || 
                   analyze.vocabulary.length > 0 || analyze.examples.length > 0;
        }

        // ÂâµÂª∫Ëß£ÊûêÂçÄÂüü
        function createAnalyzeArea(analyze) {
            const analyzeContainer = document.createElement('div');
            analyzeContainer.className = 'ai-response-analyze';
            
            // ÂâµÂª∫Êî∂Á∏Æ/Â±ïÈñãÊåâÈàï
            const toggle = document.createElement('div');
            toggle.className = 'ai-response-analyze-toggle';
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'ai-response-analyze-toggle-btn';
            toggleBtn.textContent = '+';
            const toggleText = document.createElement('span');
            toggleText.className = 'ai-response-analyze-toggle-text';
            toggleText.textContent = 'üìñ ÂñÆÂ≠óÁâáË™ûÊñáÊ≥ïÈáçÈªûËß£Êûê';
            toggle.appendChild(toggleBtn);
            toggle.appendChild(toggleText);
            
            // ÂâµÂª∫Ëß£ÊûêÂÖßÂÆπÂçÄÂüü
            const analyzeContent = document.createElement('div');
            analyzeContent.className = 'ai-response-analyze';
            
            // ÈáçÈªûË™™Êòé
            if (analyze.keyPoints) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìå ÈáçÈªûË™™Êòé';
                const content = document.createElement('div');
                content.className = 'analyze-content';
                content.textContent = analyze.keyPoints;
                section.appendChild(title);
                section.appendChild(content);
                analyzeContent.appendChild(section);
            }
            
            // Ë™ûÊ≥ïÁµêÊßã
            if (analyze.grammarAnalysis) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìù Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ';
                const content = document.createElement('div');
                content.className = 'analyze-content';
                content.textContent = analyze.grammarAnalysis;
                section.appendChild(title);
                section.appendChild(content);
                analyzeContent.appendChild(section);
            }
            
            // Ë©ûÂΩôË°®
            if (analyze.vocabulary && analyze.vocabulary.length > 0) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üìö Ë©ûÂΩôË°®ÔºàA2Á¥öÂà•Ôºâ';
                const vocabList = document.createElement('ul');
                vocabList.className = 'vocabulary-list';
                
                analyze.vocabulary.forEach(vocab => {
                    const item = document.createElement('li');
                    item.className = 'vocabulary-item';
                    item.innerHTML = `- ${vocab}`;
                    vocabList.appendChild(item);
                });
                
                section.appendChild(title);
                section.appendChild(vocabList);
                analyzeContent.appendChild(section);
            }
            
            // ‰æãÂè•
            if (analyze.examples && analyze.examples.length > 0) {
                const section = document.createElement('div');
                section.className = 'analyze-section';
                const title = document.createElement('div');
                title.className = 'analyze-title';
                title.textContent = 'üí° A2Á¥öÂà•‰æãÂè•';
                const exampleList = document.createElement('ol');
                exampleList.className = 'example-list';
                
                analyze.examples.forEach(example => {
                    const item = document.createElement('li');
                    item.className = 'example-item';
                    item.textContent = example;
                    exampleList.appendChild(item);
                });
                
                section.appendChild(title);
                section.appendChild(exampleList);
                analyzeContent.appendChild(section);
            }
            
            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂‰æÜÂ±ïÈñã/Êî∂Á∏Æ
            toggle.addEventListener('click', () => {
                const isExpanded = analyzeContent.classList.contains('expanded');
                if (isExpanded) {
                    analyzeContent.classList.remove('expanded');
                    toggleBtn.textContent = '+';
                } else {
                    analyzeContent.classList.add('expanded');
                    toggleBtn.textContent = '-';
                }
            });
            
            analyzeContainer.appendChild(toggle);
            analyzeContainer.appendChild(analyzeContent);
            
            return analyzeContainer;
        }

        // Ê∑ªÂä† AI Ë®äÊÅØÂà∞Â∞çË©±
        function addAIMessage(response) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            // Ëß£ÊûêÂõûÊáâ
            const parsedResponse = parseAIResponse(response);

            // Ê™¢Êü•Áî®Êà∂ÈÅ∏ÊìáÁöÑÁâàÊú¨
            const showFormal = showFormalCheckbox.checked;
            const showCasual = showCasualCheckbox.checked;

            // ÂâµÂª∫ÂÆπÂô®
            const container = document.createElement('div');
            container.className = 'message-text ai';

            // Ê∑ªÂä†Ê≠£ÂºèÁâàÔºàÂ¶ÇÊûúÁî®Êà∂ÈÅ∏ÊìáÈ°ØÁ§∫Ôºâ
            if (showFormal && parsedResponse.formal && (parsedResponse.formal.english || parsedResponse.formal.chinese)) {
                const formalSection = document.createElement('div');
                formalSection.className = 'ai-response-section';
                
                const formalTitle = document.createElement('div');
                formalTitle.className = 'ai-response-title';
                formalTitle.textContent = 'üìù Ê≠£ÂºèÁâà (Formal Version)';
                
                const formalContent = document.createElement('div');
                formalContent.className = 'ai-response-content formal';
                
                // Ê∑ªÂä†Ëã±ÊñáÔºàÂèØÈªûÊìäÊúóËÆÄÔºâ
                if (parsedResponse.formal.english) {
                    const englishDiv = document.createElement('div');
                    englishDiv.className = 'ai-response-english';
                    englishDiv.textContent = parsedResponse.formal.english;
                    englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                    // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂‰æÜÊúóËÆÄÈÄôÊÆµËã±Êñá
                    englishDiv.addEventListener('click', () => {
                        speakText(parsedResponse.formal.english, 'en-US');
                    });
                    formalContent.appendChild(englishDiv);
                }
                
                // Ê∑ªÂä†ÁπÅÈ´î‰∏≠Êñá
                if (parsedResponse.formal.chinese) {
                    const chineseDiv = document.createElement('div');
                    chineseDiv.className = 'ai-response-chinese';
                    chineseDiv.textContent = parsedResponse.formal.chinese;
                    formalContent.appendChild(chineseDiv);
                }
                
                // Ê∑ªÂä†Ëß£ÊûêÂçÄÂüüÔºàÂú®ÁπÅÈ´î‰∏≠ÊñáÁøªË≠ØÂæåÈù¢Ôºâ
                if (parsedResponse.formal.analyze && hasAnalyzeContent(parsedResponse.formal.analyze)) {
                    const analyzeArea = createAnalyzeArea(parsedResponse.formal.analyze);
                    formalContent.appendChild(analyzeArea);
                }
                
                formalSection.appendChild(formalTitle);
                formalSection.appendChild(formalContent);
                container.appendChild(formalSection);
            }

            // Ê∑ªÂä†Âè£Ë™ûÁâàÔºàÂ¶ÇÊûúÁî®Êà∂ÈÅ∏ÊìáÈ°ØÁ§∫Ôºâ
            if (showCasual && parsedResponse.casual && (parsedResponse.casual.english || parsedResponse.casual.chinese)) {
                const casualSection = document.createElement('div');
                casualSection.className = 'ai-response-section';
                
                const casualTitle = document.createElement('div');
                casualTitle.className = 'ai-response-title';
                casualTitle.textContent = 'üí¨ Âè£Ë™ûÁâà (Casual Version)';
                
                const casualContent = document.createElement('div');
                casualContent.className = 'ai-response-content casual';
                
                // Ê∑ªÂä†Ëã±ÊñáÔºàÂèØÈªûÊìäÊúóËÆÄÔºâ
                if (parsedResponse.casual.english) {
                    const englishDiv = document.createElement('div');
                    englishDiv.className = 'ai-response-english';
                    englishDiv.textContent = parsedResponse.casual.english;
                    englishDiv.title = 'ÈªûÊìäÊúóËÆÄ';
                    // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂‰æÜÊúóËÆÄÈÄôÊÆµËã±Êñá
                    englishDiv.addEventListener('click', () => {
                        speakText(parsedResponse.casual.english, 'en-US');
                    });
                    casualContent.appendChild(englishDiv);
                }
                
                // Ê∑ªÂä†ÁπÅÈ´î‰∏≠Êñá
                if (parsedResponse.casual.chinese) {
                    const chineseDiv = document.createElement('div');
                    chineseDiv.className = 'ai-response-chinese';
                    chineseDiv.textContent = parsedResponse.casual.chinese;
                    casualContent.appendChild(chineseDiv);
                }
                
                // Ê∑ªÂä†Ëß£ÊûêÂçÄÂüüÔºàÂú®ÁπÅÈ´î‰∏≠ÊñáÁøªË≠ØÂæåÈù¢Ôºâ
                if (parsedResponse.casual.analyze && hasAnalyzeContent(parsedResponse.casual.analyze)) {
                    const analyzeArea = createAnalyzeArea(parsedResponse.casual.analyze);
                    casualContent.appendChild(analyzeArea);
                }
                
                casualSection.appendChild(casualTitle);
                casualSection.appendChild(casualContent);
                container.appendChild(casualSection);
            }

            messageDiv.appendChild(container);
            conversation.appendChild(messageDiv);
            
            // ÊªæÂãïÂà∞Â∫ïÈÉ®
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Ë™øÁî® qwen-vl-plus API
        async function callQwenVLPlus(imageData, text) {
            const userMessage = {
                "role": "user",
                "content": [
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": imageData
                        }
                    },
                    {
                        "type": "text",
                        "text": `Ë´ãËß£ÊûêÈÄôÂºµÂúñÁâáÔºåÁî®Ëã±ÊñáÂÆåÊàê‰ª•‰∏ãÊèèËø∞Ôºö
- ÊåáÂá∫Âúñ‰∏≠ÁöÑ 2-3 ÂÄãÊ†∏ÂøÉ‰∫∫/Áâ©Ôºà‰ΩøÁî®Ë∫´‰ªΩÂêçË©ûÔºâ
- ÊèèËø∞ÊØèÂÄã‰∫∫/Áâ©ÁöÑ‰ΩçÁΩÆÔºà‰ΩøÁî®Êñπ‰Ωç‰ªãË©û/ÂâØË©ûÔºâ
- Ë™™Êòé‰∫∫/Áâ©ÁöÑÁâπÂæµÊàñÊ≠£Âú®ÈÄ≤Ë°åÁöÑÂãï‰ΩúÔºà‰ΩøÁî®ÂΩ¢ÂÆπË©û/ÂãïË©ûÔºâ
- ÂÖ®ÈÉ®‰ΩøÁî® A2 Á¥öÂà•Ë©ûÂΩôÔºåÂè•Â≠êÁ∞°ÂñÆÊòìÊáÇ

Ë´ãÊèê‰æõÂÖ©Á®ÆÁâàÊú¨Ôºö
1. Ê≠£ÂºèÁâàÔºàFormal VersionÔºâÔºö‰ΩøÁî®Ê≠£Âºè„ÄÅÊ®ôÊ∫ñÁöÑËã±ÊñáË°®ÈÅî
2. Âè£Ë™ûÁâàÔºàCasual VersionÔºâÔºö‰ΩøÁî®Âè£Ë™û„ÄÅËºïÈ¨ÜÁöÑËã±ÊñáË°®ÈÅî

ÊØèÁ®ÆÁâàÊú¨ÁöÑËã±ÊñáÂÖßÂÆπÊ†ºÂºèÁØÑ‰æãÔºö
"There is a woman in front of the window. She is sitting at a small table. The table has a red cup of coffee on it. The woman looks happy. She is not eating‚Äîshe is just drinking her coffee."

ÊØèÁ®ÆÁâàÊú¨ÈÉΩÈúÄË¶ÅÂåÖÂê´Ôºö
- Ëã±ÊñáÂÖßÂÆπÔºàÊåâÁÖß‰∏äËø∞Ê†ºÂºèË¶ÅÊ±ÇÔºâ
- ÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø

ÂêåÊôÇË´ãÁÇ∫ÊØèÁ®ÆÁâàÊú¨Êèê‰æõË©≥Á¥∞Ëß£ÊûêÔºö
- ÈáçÈªûË™™ÊòéÔºöÂàóÂá∫ÈÄôÊÆµËã±ÊñáÊèèËø∞ÁöÑÈóúÈçµÈáçÈªû
- Ë™ûÊ≥ïÁµêÊßãÔºöÂàÜÊûêÂè•Â≠ê‰∏≠‰ΩøÁî®ÁöÑA2Ë™ûÊ≥ïÁµêÊßã
- A2Á¥öÂà•Ë©ûÂΩôË°®ÔºöÂæûÂúñÁâáÊèèËø∞‰∏≠Ëæ®Ë≠ò‰∏¶ÂàóÂá∫ÊâÄÊúâA2Á¥öÂà•Ë©ûÂΩôÔºåÊ†ºÂºèÁÇ∫ÔºöË©ûÂΩô (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄùÔºà‰æãÂ¶ÇÔºöwoman (n.) Â•≥‰∫∫Ôºâ
- A2Á¥öÂà•‰æãÂè•ÔºöÊèê‰æõ3ÂÄã‰ΩøÁî®ÈÄô‰∫õË©ûÂΩôÁöÑA2Á¥öÂà•‰æãÂè•

Ë´ãÊåâÁÖß‰ª•‰∏ãÊ†ºÂºèÂõûË¶ÜÔºö
„ÄêÊ≠£ÂºèÁâà„Äë
[Ê≠£ÂºèËã±ÊñáÂÖßÂÆπ - ÊåâÁÖßÁØÑ‰æãÊ†ºÂºèÔºöThere is... She is... The table has... Á≠â]
[Ê≠£ÂºèÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø]

„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë
[ÈáçÈªûË™™Êòé]
[Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ]
[Ë©ûÂΩôË°®]ÔºàA2Á¥öÂà•Ôºâ
- Ë©ûÂΩô1 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
- Ë©ûÂΩô2 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
...
[‰æãÂè•]
1. ‰æãÂè•1
2. ‰æãÂè•2
3. ‰æãÂè•3

„ÄêÂè£Ë™ûÁâà„Äë
[Âè£Ë™ûËã±ÊñáÂÖßÂÆπ - ÊåâÁÖßÁØÑ‰æãÊ†ºÂºèÔºöThere is... She is... The table has... Á≠â]
[Âè£Ë™ûÁπÅÈ´î‰∏≠ÊñáÁøªË≠Ø]

„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë
[ÈáçÈªûË™™Êòé]
[Ë™ûÊ≥ïÁµêÊßãÔºàA2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûêÔºâ]
[Ë©ûÂΩôË°®]ÔºàA2Á¥öÂà•Ôºâ
- Ë©ûÂΩô1 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
- Ë©ûÂΩô2 (Ë©ûÊÄß) ‰∏≠ÊñáÊÑèÊÄù
...
[‰æãÂè•]
1. ‰æãÂè•1
2. ‰æãÂè•2
3. ‰æãÂè•3

Áî®Êà∂ÂïèÈ°åÔºö${text}`
                    }
                ]
            };

            const messages = [...conversationHistory, userMessage];

            const requestBody = {
                "model": "qwen-vl-plus",
                "messages": messages,
                "max_tokens": 2000,
                "temperature": 0.7
            };

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`,
                'X-DashScope-SSE': 'disable'
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();

            if (data.choices && data.choices[0] && data.choices[0].message) {
                const aiResponse = data.choices[0].message.content;

                // Êõ¥Êñ∞Â∞çË©±Ê≠∑Âè≤
                conversationHistory.push(userMessage);
                conversationHistory.push({
                    "role": "assistant",
                    "content": aiResponse
                });

                return aiResponse;
            } else {
                throw new Error('API ËøîÂõûÊ†ºÂºèÁï∞Â∏∏: ' + JSON.stringify(data));
            }
        }

        // Ëß£Êûê AI ÂõûÊáâÔºåÊèêÂèñÊ≠£ÂºèÁâàÂíåÂè£Ë™ûÁâàÁöÑËã±Êñá„ÄÅÁπÅÈ´î‰∏≠ÊñáÂíåËß£ÊûêÂÖßÂÆπ
        function parseAIResponse(response) {
            const result = {
                formal: { 
                    english: '',
                    chinese: '',
                    analyze: {
                        keyPoints: '',
                        grammarAnalysis: '',
                        vocabulary: [],
                        examples: []
                    }
                },
                casual: { 
                    english: '',
                    chinese: '',
                    analyze: {
                        keyPoints: '',
                        grammarAnalysis: '',
                        vocabulary: [],
                        examples: []
                    }
                }
            };

            // ÊèêÂèñÊ≠£ÂºèÁâàÂíåÊ≠£ÂºèÁâàËß£Êûê
            const formalSectionMatch = response.match(/„ÄêÊ≠£ÂºèÁâà„Äë\s*([\s\S]*?)(?=„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë|„ÄêÂè£Ë™ûÁâà„Äë|$)/i);
            const formalAnalyzeMatch = response.match(/„ÄêÊ≠£ÂºèÁâàËß£Êûê„Äë\s*([\s\S]*?)(?=„ÄêÂè£Ë™ûÁâà„Äë|$)/i);
            
            if (formalSectionMatch) {
                const formalContent = formalSectionMatch[1].trim();
                const lines = formalContent.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of lines) {
                    const trimmedLine = line.trim();
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^„Äê.*„Äë$/)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                result.formal.english = englishParts.join('\n').trim();
                result.formal.chinese = chineseParts.join('\n').trim();
            }

            if (formalAnalyzeMatch) {
                const analyzeContent = formalAnalyzeMatch[1].trim();
                parseAnalyzeContent(analyzeContent, result.formal.analyze);
            }

            // ÊèêÂèñÂè£Ë™ûÁâàÂíåÂè£Ë™ûÁâàËß£Êûê
            const casualSectionMatch = response.match(/„ÄêÂè£Ë™ûÁâà„Äë\s*([\s\S]*?)(?=„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë|$)/i);
            const casualAnalyzeMatch = response.match(/„ÄêÂè£Ë™ûÁâàËß£Êûê„Äë\s*([\s\S]*?)$/i);
            
            if (casualSectionMatch) {
                const casualContent = casualSectionMatch[1].trim();
                const lines = casualContent.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of lines) {
                    const trimmedLine = line.trim();
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^„Äê.*„Äë$/)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                result.casual.english = englishParts.join('\n').trim();
                result.casual.chinese = chineseParts.join('\n').trim();
            }

            if (casualAnalyzeMatch) {
                const analyzeContent = casualAnalyzeMatch[1].trim();
                parseAnalyzeContent(analyzeContent, result.casual.analyze);
            }

            // Â¶ÇÊûúÊ≤íÊúâÂåπÈÖçÂà∞ÔºåÂòóË©¶Á∞°ÂñÆÊ†ºÂºè
            if (!result.formal.english && !result.casual.english) {
                const allLines = response.split('\n').filter(line => line.trim());
                let englishParts = [];
                let chineseParts = [];
                
                for (let line of allLines) {
                    const trimmedLine = line.trim();
                    if (/[\u4e00-\u9fa5]/.test(trimmedLine)) {
                        chineseParts.push(trimmedLine);
                    } else if (trimmedLine && !trimmedLine.match(/^[„Äê„Äë\(\)\d\.\s]*$/)) {
                        englishParts.push(trimmedLine);
                    }
                }
                
                if (englishParts.length > 0) {
                    result.formal.english = englishParts.join('\n').trim();
                }
                if (chineseParts.length > 0) {
                    result.formal.chinese = chineseParts.join('\n').trim();
                }
                
                if (!result.formal.english) {
                    result.formal.english = response;
                }
            }

            return result;
        }

        // Ëß£ÊûêËß£ÊûêÂÖßÂÆπ
        function parseAnalyzeContent(content, analyzeObj) {
            // ÊèêÂèñÈáçÈªûË™™Êòé
            const keyPointsMatch = content.match(/\[ÈáçÈªûË™™Êòé\]\s*([\s\S]*?)(?=\[Ë™ûÊ≥ïÁµêÊßã\]|\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i);
            if (keyPointsMatch) {
                analyzeObj.keyPoints = keyPointsMatch[1].trim();
            }

            // ÊèêÂèñË™ûÊ≥ïÁµêÊßãÂàÜÊûê
            const grammarMatch = content.match(/\[Ë™ûÊ≥ïÁµêÊßã[^]*?A2Ë™ûÊ≥ïÁµêÊßãÂàÜÊûê[^]*?\]\s*([\s\S]*?)(?=\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i) ||
                                content.match(/\[Ë™ûÊ≥ïÁµêÊßã[^]*?\]\s*([\s\S]*?)(?=\[Ë©ûÂΩôË°®\]|\[‰æãÂè•\]|$)/i);
            if (grammarMatch) {
                analyzeObj.grammarAnalysis = grammarMatch[1].trim();
            }

            // ÊèêÂèñË©ûÂΩôË°®
            const vocabularyMatch = content.match(/\[Ë©ûÂΩôË°®\][^]*?A2Á¥öÂà•[^]*?\s*([\s\S]*?)(?=\[‰æãÂè•\]|$)/i) ||
                                  content.match(/\[Ë©ûÂΩôË°®\]\s*([\s\S]*?)(?=\[‰æãÂè•\]|$)/i);
            if (vocabularyMatch) {
                const vocabText = vocabularyMatch[1].trim();
                // ÊèêÂèñÊâÄÊúâ‰ª• - ÈñãÈ†≠ÁöÑË°å
                const vocabLines = vocabText.split('\n')
                    .filter(line => {
                        const trimmed = line.trim();
                        return trimmed.startsWith('-') && trimmed.length > 1;
                    })
                    .map(line => line.replace(/^-\s*/, '').trim())
                    .filter(line => line.length > 0);
                analyzeObj.vocabulary = vocabLines;
            }

            // ÊèêÂèñ‰æãÂè•
            const examplesMatch = content.match(/\[‰æãÂè•\]\s*([\s\S]*?)$/i);
            if (examplesMatch) {
                const examplesText = examplesMatch[1].trim();
                // ÊèêÂèñÊâÄÊúâ‰ª•Êï∏Â≠óÈñãÈ†≠ÁöÑË°å
                const exampleLines = examplesText.split('\n')
                    .filter(line => {
                        const trimmed = line.trim();
                        return /^\d+\./.test(trimmed) && trimmed.length > 2;
                    })
                    .map(line => line.replace(/^\d+\.\s*/, '').trim())
                    .filter(line => line.length > 0);
                analyzeObj.examples = exampleLines;
            }
        }

        // Ê®ôÁ§∫ÈóúÈçµËã±ÊñáÂñÆÂ≠óÂíåÁâáË™û
        function highlightKeywords(text) {
            // Â∏∏Ë¶ãÁöÑ A2 Á¥öÂà•ÈóúÈçµË©ûÂíåÁâáË™û
            const keywords = [
                // Âü∫Êú¨ÂãïË©û
                'is', 'are', 'was', 'were', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'can', 'could', 'should', 'must',
                'go', 'come', 'get', 'make', 'take', 'give', 'put', 'see', 'look', 'watch', 'listen', 'hear', 'say', 'tell', 'speak', 'talk',
                'eat', 'drink', 'sleep', 'work', 'play', 'study', 'learn', 'teach', 'read', 'write', 'buy', 'sell', 'help', 'need', 'want', 'like', 'love',
                
                // Â∏∏Áî®ÂêçË©û
                'time', 'day', 'week', 'month', 'year', 'morning', 'afternoon', 'evening', 'night', 'today', 'tomorrow', 'yesterday',
                'home', 'house', 'room', 'kitchen', 'bedroom', 'bathroom', 'school', 'office', 'shop', 'store', 'restaurant', 'hospital',
                'family', 'friend', 'people', 'person', 'man', 'woman', 'child', 'children', 'boy', 'girl', 'baby',
                'food', 'water', 'coffee', 'tea', 'bread', 'rice', 'meat', 'fish', 'fruit', 'vegetable',
                'car', 'bus', 'train', 'plane', 'bike', 'phone', 'computer', 'book', 'table', 'chair', 'bed', 'door', 'window',
                
                // ÂΩ¢ÂÆπË©û
                'good', 'bad', 'big', 'small', 'long', 'short', 'tall', 'high', 'low', 'fast', 'slow', 'hot', 'cold', 'warm', 'cool',
                'new', 'old', 'young', 'easy', 'difficult', 'hard', 'soft', 'heavy', 'light', 'dark', 'bright', 'clean', 'dirty',
                'happy', 'sad', 'angry', 'tired', 'hungry', 'thirsty', 'busy', 'free', 'ready', 'sure', 'right', 'wrong',
                
                // ‰ªãË©ûÂíåÂâØË©û
                'in', 'on', 'at', 'to', 'from', 'with', 'without', 'for', 'about', 'under', 'over', 'between', 'behind', 'next to',
                'here', 'there', 'now', 'then', 'always', 'never', 'sometimes', 'often', 'usually', 'very', 'really', 'quite', 'too', 'also',
                
                // Â∏∏Áî®ÁâáË™û
                'how are you', 'nice to meet you', 'excuse me', 'thank you', 'you\'re welcome', 'i\'m sorry', 'no problem',
                'what time', 'how much', 'how many', 'how long', 'how often', 'what about', 'would you like', 'i would like',
                'there is', 'there are', 'used to', 'going to', 'have to', 'need to', 'want to', 'like to', 'love to',
                'look at', 'listen to', 'wait for', 'look for', 'think about', 'talk about', 'worry about', 'care about',
                'turn on', 'turn off', 'pick up', 'put down', 'get up', 'sit down', 'stand up', 'wake up', 'go out', 'come back',
                'right now', 'just now', 'a little', 'a lot', 'too much', 'not enough', 'of course', 'by the way', 'at least', 'at most'
            ];

            let highlightedText = text;
            
            // ÊåâÈï∑Â∫¶ÊéíÂ∫èÔºåÂÖàËôïÁêÜÈï∑ÁâáË™û
            keywords.sort((a, b) => b.length - a.length);
            
            keywords.forEach(keyword => {
                // ÂâµÂª∫Ê≠£ÂâáË°®ÈÅîÂºèÔºåÂåπÈÖçÂÆåÊï¥ÂñÆË©ûÊàñÁâáË™ûÔºà‰∏çÂçÄÂàÜÂ§ßÂ∞èÂØ´Ôºâ
                const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="keyword-highlight">$&</span>`);
            });
            
            return highlightedText;
        }

        // Ë™ûÈü≥ÂêàÊàêÔºàËÆÄÂèñËã±ÊñáÔºâ
        function speakText(text, lang = 'en-US') {
            if (!('speechSynthesis' in window)) {
                console.log('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥ÂêàÊàê');
                return;
            }

            // ÂÅúÊ≠¢Áï∂ÂâçÊí≠Êîæ
            window.speechSynthesis.cancel();

            // ÈÅéÊøæÊéâ‰∏≠ÊñáÂ≠óÁ¨¶ÔºåÂè™‰øùÁïôËã±ÊñáÂ≠óÁ¨¶„ÄÅÊï∏Â≠ó„ÄÅÊ®ôÈªûÁ¨¶ËôüÂíåÁ©∫Ê†º
            const englishOnlyText = text.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
            
            if (!englishOnlyText) {
                console.log('Ê≤íÊúâËã±ÊñáÂÖßÂÆπÂèØ‰ª•ÊúóËÆÄ');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(englishOnlyText);
            utterance.lang = lang;
            utterance.volume = 0.8;
            utterance.rate = parseFloat(speechRateSlider.value); // ‰ΩøÁî®Áî®Êà∂Ë®≠ÂÆöÁöÑË™ûÈÄü
            utterance.pitch = 1;

            // ÈÅ∏ÊìáÂêàÈÅ©ÁöÑË™ûÈü≥ÔºàËã±ÊñáÔºâ
            const getVoices = () => {
                const voices = window.speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÁæéÂºèËã±Ë™ûÔºåÊâæ‰ªªÊÑèËã±Ë™ûË™ûÈü≥
                    const anyEnglish = voices.find(v => v.lang.startsWith('en'));
                    if (anyEnglish) {
                        utterance.voice = anyEnglish;
                    }
                }
                window.speechSynthesis.speak(utterance);
            };

            // Á¢∫‰øùË™ûÈü≥ÂàóË°®Â∑≤Âä†Ëºâ
            if (window.speechSynthesis.getVoices().length === 0) {
                window.speechSynthesis.onvoiceschanged = getVoices;
            } else {
                getVoices();
            }

            utterance.onstart = () => {
                status.textContent = 'Ê≠£Âú®ÊúóËÆÄËã±Êñá...';
            };

            utterance.onend = () => {
                status.textContent = 'ÊúóËÆÄÂÆåÊàê';
            };

            utterance.onerror = (event) => {
                console.error('Ë™ûÈü≥ÂêàÊàêÈåØË™§:', event.error);
                status.textContent = 'ÊúóËÆÄÂ§±Êïó';
            };
        }

        // È†êË¶ΩÈñãÈóú‰∫ã‰ª∂
        previewToggle.addEventListener('change', function() {
            if (this.checked) {
                video.style.display = 'block';
            } else {
                video.style.display = 'none';
            }
        });

        // ÊåâÈàï‰∫ã‰ª∂
        captureBtn.addEventListener('click', capturePhoto);

        // Ë™ûÈü≥ÊåâÈàï‰∫ã‰ª∂
        recordBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            if (!hasSpeechRecognition) {
                status.textContent = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ë≠òÂà•';
                return;
            }
            if (isRecording) return;

            if (!currentImageData) {
                status.textContent = 'Ë´ãÂÖàÊãçÁÖß';
                return;
            }

            isRecording = true;
            recordBtn.classList.add('recording');
            status.textContent = 'Ê≠£Âú®ËÅÜËÅΩ...';
            recognition.start();
        });

        recordBtn.addEventListener('mouseup', function(e) {
            e.preventDefault();
            if (isRecording && recognition) {
                recognition.stop();
                status.textContent = 'Ê≠£Âú®ËôïÁêÜË™ûÈü≥...';
            }
        });

        recordBtn.addEventListener('mouseleave', function(e) {
            if (isRecording && recognition) {
                recognition.stop();
                status.textContent = 'Â∑≤ÂÅúÊ≠¢ÈåÑÈü≥';
            }
        });

        // Ëß∏Êéß‰∫ã‰ª∂ÊîØÊè¥ÔºàÊâãÊ©üÔºâ
        recordBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (!hasSpeechRecognition) {
                status.textContent = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ë≠òÂà•';
                return;
            }
            if (isRecording) return;

            if (!currentImageData) {
                status.textContent = 'Ë´ãÂÖàÊãçÁÖß';
                return;
            }

            isRecording = true;
            recordBtn.classList.add('recording');
            status.textContent = 'Ê≠£Âú®ËÅÜËÅΩ...';
            recognition.start();
        });

        recordBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            if (isRecording && recognition) {
                recognition.stop();
                status.textContent = 'Ê≠£Âú®ËôïÁêÜË™ûÈü≥...';
            }
        });

        // API ÈÖçÁΩÆ‰∫ã‰ª∂
        apiKeyInput.addEventListener('input', (e) => {
            apiKey = e.target.value.trim();
            // Â¶ÇÊûúÂãæÈÅ∏‰∫Ü‰øùÂ≠òÔºåÂ∞±‰øùÂ≠òÂà∞ localStorage
            if (saveApiKeyCheckbox.checked && apiKey) {
                localStorage.setItem('qwen_api_key', apiKey);
            } else if (!saveApiKeyCheckbox.checked) {
                localStorage.removeItem('qwen_api_key');
            }
        });

        saveApiKeyCheckbox.addEventListener('change', (e) => {
            if (e.target.checked && apiKey) {
                // ‰øùÂ≠òÂà∞ localStorage
                localStorage.setItem('qwen_api_key', apiKey);
            } else {
                // Âæû localStorage ÁßªÈô§
                localStorage.removeItem('qwen_api_key');
            }
        });

        // ÁâàÊú¨ÈÅ∏ÊìáËÆäÊõ¥ÊôÇ‰øùÂ≠òÂà∞ localStorage
        showFormalCheckbox.addEventListener('change', (e) => {
            localStorage.setItem('showFormal', e.target.checked.toString());
        });

        showCasualCheckbox.addEventListener('change', (e) => {
            localStorage.setItem('showCasual', e.target.checked.toString());
        });

        // Ë™ûÈü≥ÈÄüÂ∫¶ÊªëÊ°ø‰∫ã‰ª∂
        speechRateSlider.addEventListener('input', (e) => {
            const rate = e.target.value;
            speechRateValue.textContent = rate + 'x';
            localStorage.setItem('speechRate', rate);
        });

        // Â±ïÈñã/Êî∂Á∏ÆÈÖçÁΩÆÂçÄÂüü
        configToggle.addEventListener('click', () => {
            const isExpanded = apiConfig.classList.contains('expanded');
            if (isExpanded) {
                apiConfig.classList.remove('expanded');
                toggleBtn.textContent = '+';
                localStorage.setItem('configExpanded', 'false');
            } else {
                apiConfig.classList.add('expanded');
                toggleBtn.textContent = '-';
                localStorage.setItem('configExpanded', 'true');
            }
        });

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂïüÂãïÁõ∏Ê©ü
        if (hasGetUserMedia) {
            startCamera();
        } else {
            status.textContent = 'ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Áõ∏Ê©üÂäüËÉΩ';
        }

        // È†ÅÈù¢Âç∏ËºâÊôÇÂÅúÊ≠¢Áõ∏Ê©ü
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // È†ÅÈù¢ÂèØË¶ãÊÄßÊîπËÆäÊôÇ‰øùÊåÅÁõ∏Ê©üÈñãÂïüÔºàÈÅøÂÖçÂàáÊèõÊ®ôÁ±§È†ÅÊôÇÈóúÈñâÔºâ
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && stream && stream.active) {
                // È†ÅÈù¢ÈáçÊñ∞ÂèØË¶ãÊôÇÔºåÁ¢∫‰øù video ÂÖÉÁ¥†È°ØÁ§∫ stream
                if (video.srcObject !== stream) {
                    video.srcObject = stream;
                }
            }
        });
    </script>
</body>
</html>
