<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹ç…§åˆ†æå°è©± - è‹±èªå­¸ç¿’ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 160px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 10px; }
        .config-toggle {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 6px 12px;
            margin-bottom: 10px; cursor: pointer;
        }
        .api-config {
            background: rgba(255, 255, 255, 0.95); border-radius: 10px; padding: 15px;
            margin-bottom: 10px; display: none; flex-direction: column; gap: 10px;
        }
        .api-config.expanded { display: flex; }
        .conversation {
            background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px;
            min-height: 300px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .message { margin-bottom: 20px; display: flex; flex-direction: column; }
        .message.user { align-items: flex-end; }
        .message.ai { align-items: flex-start; }
        .message-text {
            padding: 12px 16px; border-radius: 18px; max-width: 90%; font-size: 15px;
        }
        .message-text.user { background: #667eea; color: white; }
        .message-text.ai { background: #f0f0f0; color: #333; width: 100%; }
        
        /* è‹±èªå…§å®¹æ¨£å¼ */
        .eng-sentence {
            color: #2196F3; font-size: 18px; font-weight: 500; cursor: pointer;
            padding: 5px; border-radius: 5px; display: block; transition: 0.2s;
        }
        .eng-sentence:hover { background: rgba(33, 150, 243, 0.1); }
        .eng-sentence.speaking { background: #ffeb3b; color: #000; transform: scale(1.02); }
        .tra-sentence { color: #666; font-size: 14px; margin-bottom: 12px; padding-left: 5px; }

        /* ç›¸æ©Ÿæ§åˆ¶ */
        .camera-controls {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 15px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100;
        }
        #videoElement {
            position: fixed; bottom: 130px; left: 15px; width: 80px; height: 110px;
            object-fit: cover; border-radius: 8px; border: 2px solid white; background: #000;
        }
        .button-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .btn-capture { background: #667eea; color: white; }
        .btn-submit { background: #28a745; color: white; }
        .status { text-align: center; font-size: 12px; color: #666; margin-top: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“¸ æ‹ç…§å­¸è‹±èª</h1>
        <div class="config-toggle" onclick="toggleConfig()">âš™ï¸ è¨­å®š API Key / èªé€Ÿ</div>
        <div class="api-config" id="apiConfig">
            <input type="password" id="apiKey" placeholder="è¼¸å…¥ DashScope API Key" style="padding:8px;">
            <label><input type="checkbox" id="saveApiKey" checked> å„²å­˜é‡‘é‘°</label>
            <hr>
            <div>èªé€Ÿï¼š<input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.8" oninput="updateRateLabel(this.value)"> <span id="rateVal">0.8x</span></div>
            <label><input type="checkbox" id="continuousSpeech" checked> è‡ªå‹•å¾ªç’°æ’­æ”¾</label>
        </div>
    </div>

    <div class="conversation" id="conversation">
        <div style="text-align:center; color:#999; margin-top:50px;">æ‹ä¸€å¼µç…§ï¼Œæˆ‘æœƒç”¨è‹±æ–‡è·Ÿä½ èŠå¤©ï¼</div>
    </div>
</div>

<div class="camera-controls">
    <video id="videoElement" autoplay playsinline></video>
    <img id="previewImage" style="display:none; position:fixed; bottom:130px; left:15px; width:80px; height:110px; object-fit:cover; border-radius:8px; border:2px solid #fff;">
    
    <div class="button-group">
        <button class="btn btn-capture" onclick="capturePhoto()">ğŸ“· æ‹ç…§</button>
        <button class="btn btn-submit" onclick="handleSubmit()">ğŸ“¤ é€å‡ºåˆ†æ</button>
    </div>
    <div class="status" id="status">ç›¸æ©Ÿå•Ÿå‹•ä¸­...</div>
</div>

<canvas id="canvasElement" style="display:none;"></canvas>

<script>
    let stream;
    let currentImageData = null;
    const synth = window.speechSynthesis;
    let isSpeaking = false;

    // åˆå§‹åŒ–ç›¸æ©Ÿ
    async function initCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            document.getElementById('videoElement').srcObject = stream;
            document.getElementById('status').innerText = "ç›¸æ©Ÿå·²å°±ç·’";
        } catch (err) {
            document.getElementById('status').innerText = "ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—";
        }
    }

    function toggleConfig() {
        document.getElementById('apiConfig').classList.toggle('expanded');
    }

    function updateRateLabel(val) {
        document.getElementById('rateVal').innerText = val + 'x';
    }

    function capturePhoto() {
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        currentImageData = canvas.toDataURL('image/jpeg', 0.8);
        
        const preview = document.getElementById('previewImage');
        preview.src = currentImageData;
        preview.style.display = 'block';
        document.getElementById('status').innerText = "ç…§ç‰‡å·²å°±ç·’ï¼Œè«‹é»æ“Šé€å‡º";
    }

    async function handleSubmit() {
        const key = document.getElementById('apiKey').value;
        if (!key || !currentImageData) return alert("è«‹è¼¸å…¥ API Key ä¸¦å…ˆæ‹ç…§");
        if (document.getElementById('saveApiKey').checked) localStorage.setItem('qwen_api_key', key);

        document.getElementById('status').innerText = "AI æ­£åœ¨æ€è€ƒä¸­...";
        
        try {
            const response = await fetch('https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "qwen-vl-max",
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "text", text: "è«‹åˆ†æé€™å¼µç…§ç‰‡ã€‚è«‹ç›´æ¥è¼¸å‡º3å¥ç›¸é—œçš„è‹±æ–‡å¥å­ï¼Œæ¯å¥è‹±æ–‡å¾Œé¢ç·Šè·Ÿä¸­æ–‡ç¿»è­¯ã€‚æ ¼å¼å¦‚ä¸‹ï¼š\nSentence 1.\nä¸­æ–‡ç¿»è­¯1\nSentence 2.\nä¸­æ–‡ç¿»è­¯2" },
                                { type: "image_url", image_url: { url: currentImageData } }
                            ]
                        }
                    ]
                })
            });

            const data = await response.json();
            const content = data.choices[0].message.content;
            displayResponse(content);
            document.getElementById('status').innerText = "åˆ†æå®Œæˆ";
        } catch (err) {
            alert("API è«‹æ±‚å‡ºéŒ¯: " + err.message);
        }
    }

    function displayResponse(text) {
        const container = document.getElementById('conversation');
        container.innerHTML = ""; // æ¸…ç©º
        
        const msgDiv = document.createElement('div');
        msgDiv.className = "message ai";
        const textDiv = document.createElement('div');
        textDiv.className = "message-text ai";

        // ç°¡å–®è§£æï¼šå‡è¨­å¥‡æ•¸è¡Œç‚ºè‹±æ–‡ï¼Œå¶æ•¸è¡Œç‚ºä¸­æ–‡
        const lines = text.split('\n').filter(l => l.trim() !== "");
        let sentencesToRead = [];

        for (let i = 0; i < lines.length; i += 2) {
            const eng = lines[i];
            const chi = lines[i+1] || "";
            
            const engSpan = document.createElement('span');
            engSpan.className = "eng-sentence";
            engSpan.innerText = eng;
            engSpan.onclick = () => speak(eng, engSpan);
            
            const chiDiv = document.createElement('div');
            chiDiv.className = "tra-sentence";
            chiDiv.innerText = chi;

            textDiv.appendChild(engSpan);
            textDiv.appendChild(chiDiv);
            sentencesToRead.push({ text: eng, el: engSpan });
        }

        msgDiv.appendChild(textDiv);
        container.appendChild(msgDiv);

        // è‡ªå‹•é–‹å§‹æœ—è®€ç¬¬ä¸€å¥
        if (sentencesToRead.length > 0) {
            autoReadFlow(sentencesToRead, 0);
        }
    }

    function autoReadFlow(list, index) {
        if (index >= list.length) {
            if (document.getElementById('continuousSpeech').checked) {
                setTimeout(() => autoReadFlow(list, 0), 2000); // å¾ªç’°
            }
            return;
        }
        speak(list[index].text, list[index].el, () => {
            setTimeout(() => autoReadFlow(list, index + 1), 500);
        });
    }

    function speak(text, element, callback) {
        synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.rate = document.getElementById('speechRate').value;

        utter.onstart = () => element.classList.add('speaking');
        utter.onend = () => {
            element.classList.remove('speaking');
            if (callback) callback();
        };

        synth.speak(utter);
    }

    // è¼‰å…¥å­˜æª”
    window.onload = () => {
        const saved = localStorage.getItem('qwen_api_key');
        if (saved) document.getElementById('apiKey').value = saved;
        initCamera();
    };
</script>

</body>
</html>
