<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èªéŸ³è‡ªå‹•æ‹ç…§ç‰ˆ</title>
    <style>
        /* åŸºç¤æ¨£å¼ä¿æŒä¸€è‡´ */
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; text-align: center; }
        #videoElement { width: 100%; max-width: 400px; border-radius: 15px; border: 3px solid #667eea; margin-top: 10px; }
        .status-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .voice-log { color: #aaa; font-size: 14px; margin-top: 5px; font-style: italic; }
        .btn-start { background: #ff4757; color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; margin-bottom: 20px; }
        .recording { animation: pulse 1.5s infinite; color: #2ecc71; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="status-box">
        <h2>ğŸ™ èªéŸ³è¾¨è­˜ç‹€æ…‹</h2>
        <button id="startVoiceBtn" class="btn-start">é»æ“Šæ­¤è™•ï¼šå•Ÿå‹•èªéŸ³ç›£è½</button>
        <div id="voiceStatus">å°šæœªå•Ÿå‹•</div>
        <div id="lastHeard" class="voice-log">è½åˆ°çš„å…§å®¹æœƒé¡¯ç¤ºåœ¨é€™è£¡...</div>
    </div>

    <video id="videoElement" autoplay playsinline></video>
    <canvas id="canvasElement" style="display: none;"></canvas>

    <div style="margin-top: 20px;">
        <p>è«‹èªªï¼š<strong>ã€Œæ‹ç…§ã€</strong>ã€<strong>ã€Œç…§ç›¸ã€</strong> æˆ– <strong>ã€Œæ‹ä¸€å¼µã€</strong></p>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const voiceStatus = document.getElementById('voiceStatus');
        const lastHeard = document.getElementById('lastHeard');
        const startVoiceBtn = document.getElementById('startVoiceBtn');

        // 1. åˆå§‹åŒ–ç›¸æ©Ÿ
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(s => video.srcObject = s);

        // 2. æ ¸å¿ƒæ‹ç…§åŠŸèƒ½
        function takePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // è¦–è¦ºå›é¥‹ï¼šé–ƒä¸€ä¸‹ç™½å…‰
            document.body.style.backgroundColor = "white";
            setTimeout(() => document.body.style.backgroundColor = "#1a1a1a", 100);
            
            console.log("èªéŸ³è§¸ç™¼æ‹ç…§æˆåŠŸï¼");
            // æ­¤è™•å¯æ¥ handlePhotoSubmit();
        }

        // 3. èªéŸ³è¾¨è­˜è¨­å®š
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            voiceStatus.innerHTML = "âŒ ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome";
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = true;     // æŒçºŒç›£è½
            recognition.interimResults = true; // é¡¯ç¤ºä¸­é–“è¾¨è­˜çµæœï¼Œåæ‡‰æ›´å¿«

            recognition.onstart = () => {
                voiceStatus.innerHTML = "<span class='recording'>â— æ­£åœ¨è½ä½ èªªè©±...</span>";
                startVoiceBtn.style.display = "none";
            };

            recognition.onresult = (event) => {
                let resultText = "";
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    resultText += event.results[i][0].transcript;
                }
                
                lastHeard.innerText = "è½åˆ°çš„æ˜¯ï¼š" + resultText;

                // æ“´å¤§è¾¨è­˜ç¯„åœï¼Œåªè¦åŒ…å«é€™äº›å­—çœ¼å°±è§¸ç™¼
                const keywords = ["æ‹ç…§", "ç…§ç›¸", "æ‹ä¸€å¼µ", "æ”å½±", "èŒ„å­"];
                if (keywords.some(key => resultText.includes(key))) {
                    takePhoto();
                    // ç‚ºäº†é˜²æ­¢é‡è¤‡æ‹ç…§ï¼Œè¾¨è­˜åˆ°å¾Œå…ˆåœä¸€ä¸‹å†é‡é–‹
                    recognition.stop();
                }
            };

            recognition.onerror = (e) => {
                console.error("è¾¨è­˜éŒ¯èª¤:", e.error);
                if(e.error === 'not-allowed') alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™ï¼");
            };

            // è‡ªå‹•é‡å•Ÿï¼šç•¶è¾¨è­˜çµæŸæˆ–æ‹ç…§å¾Œè‡ªå‹•å†é–‹å•Ÿ
            recognition.onend = () => {
                console.log("è¾¨è­˜çµæŸï¼Œé‡æ–°å•Ÿå‹•...");
                recognition.start();
            };

            // å¿…é ˆé€éé»æ“ŠæŒ‰éˆ•ä¾†å•Ÿå‹•
            startVoiceBtn.addEventListener('click', () => {
                recognition.start();
            });
        }
    </script>
</body>
</html>
