<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹ç…§åˆ†æå°è©±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; padding-bottom: 100px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 10px; }
        .header h1 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
        .header p { font-size: 13px; margin: 0; }
        .config-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 6px 12px; margin-bottom: 10px; cursor: pointer; transition: background 0.3s ease; user-select: none; }
        .config-toggle:hover { background: rgba(255, 255, 255, 0.3); }
        .config-toggle-btn { font-size: 16px; font-weight: bold; color: white; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: rgba(255, 255, 255, 0.2); }
        .config-toggle-text { color: white; font-size: 12px; font-weight: 600; }
        .api-config { background: rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 10px; margin-bottom: 10px; display: none; flex-direction: column; gap: 8px; }
        .api-config.expanded { display: flex; }
        .api-config input[type="password"], .api-config input[type="text"] { width: 100%; padding: 8px; border: none; border-radius: 6px; font-size: 12px; background: rgba(255, 255, 255, 0.9); }
        .api-config input[type="password"]:focus, .api-config input[type="text"]:focus { outline: none; background: white; }
        .save-key-option { display: flex; align-items: center; gap: 8px; color: white; font-size: 12px; margin-top: 5px; }
        .save-key-option input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .version-select { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
        .version-select-title { color: white; font-size: 12px; font-weight: 600; margin-bottom: 5px; }
        .version-checkbox-group { display: flex; flex-direction: column; gap: 6px; }
        .version-checkbox-item { display: flex; align-items: center; gap: 8px; color: white; font-size: 12px; }
        .version-checkbox-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .speech-rate-control { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.3); }
        .speech-rate-title { color: white; font-size: 12px; font-weight: 600; margin-bottom: 5px; }
        .speech-rate-slider-container { display: flex; align-items: center; gap: 10px; }
        .speech-rate-label { color: white; font-size: 11px; min-width: 20px; text-align: center; }
        .speech-rate-slider { flex: 1; height: 4px; border-radius: 2px; background: rgba(255, 255, 255, 0.3); outline: none; cursor: pointer; }
        .speech-rate-slider::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .speech-rate-slider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; border: none; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .speech-rate-value { color: white; font-size: 11px; text-align: center; font-weight: 600; background: rgba(255, 255, 255, 0.2); padding: 2px 8px; border-radius: 10px; min-width: 40px; }
        .keyword-highlight { color: #2196F3; font-weight: 600; background: rgba(33, 150, 243, 0.1); padding: 1px 3px; border-radius: 3px; }
        .message-text.ai { background: #f0f0f0; color: #333; margin-left: 0; text-align: left; }
        .ai-response-section { margin-bottom: 15px; }
        .ai-response-title { font-weight: 600; font-size: 13px; margin-bottom: 5px; color: #555; }
        .ai-response-content { padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #667eea; margin-bottom: 8px; }
        .ai-response-content.formal { border-left-color: #667eea; }
        .ai-response-content.casual { border-left-color: #ff6b6b; }
        .ai-response-english { font-size: 15px; line-height: 1.6; margin-bottom: 8px; color: #2196F3; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s ease; user-select: none; }
        .ai-response-english:hover { background-color: rgba(102, 126, 234, 0.1); }
        .ai-response-english:active { background-color: rgba(102, 126, 234, 0.2); }
        .ai-response-chinese { font-size: 14px; line-height: 1.6; color: #666; padding-top: 0; }
        .reader-overlay { position: fixed; inset: 0; background: #000; color: #fff; z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; text-align: center; overflow: hidden; }
        .reader-container { max-width: 95vw; max-height: 90vh; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 16px; overflow: auto; padding-bottom: env(safe-area-inset-bottom); }
        .reader-english { font-size: clamp(40px, 8.6vw, 81px); line-height: 1.4; margin-bottom: 12px; color: #fff; max-width: 95vw; max-height: 42vh; overflow: auto; word-break: break-word; overflow-wrap: break-word; white-space: normal; }
        .reader-chinese { font-size: clamp(40px, 8.6vw, 81px); line-height: 1.4; color: #ffd; max-width: 95vw; max-height: 42vh; overflow: auto; word-break: break-word; overflow-wrap: break-word; white-space: normal; }
        .overlay-close-btn { margin-top: 16px; background: #444; color: #fff; border: none; padding: 10px 18px; border-radius: 20px; font-size: 14px; cursor: pointer; }
        .overlay-close-btn:hover { background: #555; transform: scale(1.03); }
        .ai-response-sentence-translation { font-size: 13px; line-height: 1.5; color: #888; margin-bottom: 8px; padding-left: 10px; border-left: 3px solid #e0e0e0; font-style: italic; }
        .ai-response-english.speaking { background: linear-gradient(90deg, #667eea, #764ba2); color: white; animation: speakingGlow 1s ease-in-out infinite alternate; transform: scale(1.02); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        @keyframes speakingGlow { 0% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); } 100% { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); } }
        .btn-play-all { background: #8ae8a0; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin: 10px 0; transition: all 0.3s ease; }
        .btn-play-all:hover { background: #218838; transform: scale(1.05); }
        .btn-play-all:active { transform: scale(0.95); }
        .loading-indicator { text-align: center; padding: 10px; color: #666; font-size: 14px; }
        .conversation { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px; min-height: 400px; max-height: calc(100vh - 250px); overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .message { margin-bottom: 20px; animation: fadeIn 0.3s ease-in; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: flex-end; }
        .message-image { width: 100%; max-width: 100%; max-height: 50vh; height: auto; border-radius: 12px; margin-top: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: block; object-fit: contain; }
        .message-text { background: #f0f0f0; padding: 12px 16px; border-radius: 18px; line-height: 1.5; color: #333; font-size: clamp(14px, 3vw, 16px); word-wrap: break-word; max-width: 90%; margin-bottom: 8px; width: fit-content; }
        .message-text.user { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .camera-controls { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); padding: 20px; border-top-left-radius: 25px; border-top-right-radius: 25px; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1); z-index: 100; }
        .camera-preview { position: fixed; bottom: 120px; right: 20px; width: 80px; height: 142px; border-radius: 8px; object-fit: cover; display: block; background: #000; z-index: 50; border: 2px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
        .button-group { display: flex; gap: 15px; justify-content: center; align-items: center; }
        .btn { padding: 15px 30px; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; outline: none; font-family: inherit; }
        .btn-capture { background: #667eea; color: white; flex: 1; max-width: 180px; }
        .btn-reload { background: #28a745; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 0 10px; }
        .status { text-align: center; color: #666; font-size: 14px; margin-top: 10px; min-height: 20px; }
        #videoElement { position: fixed; bottom: 120px; right: 20px; width: 80px; height: 142px; border-radius: 8px; object-fit: cover; display: block; background: #000; z-index: 50; border: 2px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ æ‹ç…§åˆ†æå°è©±</h1>
            <p>æ‹ç…§ä¸¦ç›´æ¥é€å‡ºåˆ†æ</p>
            <div class="config-toggle" id="configToggle">
                <div class="config-toggle-btn" id="toggleBtn">+</div>
                <div class="config-toggle-text">è¨­å®š</div>
            </div>
            <div class="api-config" id="apiConfig">
                <input type="password" id="apiKey" placeholder="è«‹è¼¸å…¥ API Key" />
                <div class="save-key-option">
                    <input type="checkbox" id="saveApiKey" />
                    <label for="saveApiKey">å°‡ key å­˜åœ¨ç€è¦½å™¨ç«¯</label>
                </div>
                <div class="version-select">
                    <div class="version-select-title">å›è¦†ç‰ˆæœ¬é¸æ“‡ï¼š</div>
                    <div class="version-checkbox-group">
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showFormal" />
                            <label for="showFormal">æ­£å¼ç‰ˆ (Formal)</label>
                        </div>
                        <div class="version-checkbox-item">
                            <input type="checkbox" id="showCasual" />
                            <label for="showCasual">å£èªç‰ˆ (Casual)</label>
                        </div>
                    </div>
                </div>
                <div class="speech-rate-control">
                    <div class="speech-rate-title">èªéŸ³æ’­æ”¾é€Ÿåº¦ï¼š</div>
                    <div class="speech-rate-slider-container">
                        <span class="speech-rate-label">æ…¢</span>
                        <input type="range" id="speechRate" min="0.5" max="1.5" step="0.1" value="0.8" class="speech-rate-slider" />
                        <span class="speech-rate-label">å¿«</span>
                    </div>
                    <div class="speech-rate-value" id="speechRateValue">0.8x</div>
                </div>
            </div>
        </div>

        <div class="conversation" id="conversation">
            <div class="empty-state">é‚„æ²’æœ‰ä»»ä½•å°è©±ï¼Œæ‹ç…§ä¸¦é€å‡ºåˆ†æå§ï¼</div>
        </div>
    </div>

    <div class="camera-controls">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement" style="display: none;"></canvas>
        <img id="previewImage" class="camera-preview" alt="é è¦½" style="display: none;">
        
        <div class="background-speech-option">
            <input type="checkbox" id="backgroundSpeech" />
            <label for="backgroundSpeech">ğŸ”Š èƒŒæ™¯æœ—è®€ï¼ˆè¢å¹•é—œé–‰æ™‚ç¹¼çºŒï¼‰</label>
        </div>
        
        <div class="continuous-speech-option">
            <input type="checkbox" id="continuousSpeech" checked />
            <label for="continuousSpeech">ğŸ”„ æŒçºŒæœ—è®€ï¼ˆä¸€ç›´é‡è¤‡æœ—è®€ï¼‰</label>
        </div>
        
        <div class="button-group">
            <button class="btn btn-capture" id="captureBtn">ğŸ“· æ‹ç…§ä¸¦åˆ†æ</button>
            <button class="btn btn-reload" id="reloadBtn" title="é‡æ–°è¼‰å…¥é é¢">ğŸ”„</button>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <div id="readerOverlay" class="reader-overlay">
        <div class="reader-container">
            <div id="readerEnglish" class="reader-english"></div>
            <div id="readerChinese" class="reader-chinese"></div>
            <button id="overlayCloseBtn" class="overlay-close-btn">é—œé–‰</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const conversation = document.getElementById('conversation');
        const captureBtn = document.getElementById('captureBtn');
        const reloadBtn = document.getElementById('reloadBtn');
        const status = document.getElementById('status');
        const previewImage = document.getElementById('previewImage');
        const readerOverlay = document.getElementById('readerOverlay');
        const readerEnglish = document.getElementById('readerEnglish');
        const readerChinese = document.getElementById('readerChinese');
        const overlayCloseBtn = document.getElementById('overlayCloseBtn');

        let stream = null;
        let currentImageData = null;
        
        let apiKey = '';
        const apiUrl = 'https://dashscope-intl.aliyuncs.com/compatible-mode/v1/chat/completions';
        let conversationHistory = [];
        const apiKeyInput = document.getElementById('apiKey');
        const saveApiKeyCheckbox = document.getElementById('saveApiKey');
        const showFormalCheckbox = document.getElementById('showFormal');
        const showCasualCheckbox = document.getElementById('showCasual');
        const configToggle = document.getElementById('configToggle');
        const apiConfig = document.getElementById('apiConfig');
        const toggleBtn = document.getElementById('toggleBtn');
        const speechRateSlider = document.getElementById('speechRate');
        const speechRateValue = document.getElementById('speechRateValue');
        const backgroundSpeechCheckbox = document.getElementById('backgroundSpeech');
        const continuousSpeechCheckbox = document.getElementById('continuousSpeech');
        
        function showOverlay(englishText, chineseText) {
            readerEnglish.textContent = englishText || '';
            readerChinese.textContent = chineseText || '';
            readerOverlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function hideOverlay() {
            readerOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }

        const savedApiKey = localStorage.getItem('qwen_api_key');
        if (savedApiKey) {
            apiKey = savedApiKey;
            apiKeyInput.value = savedApiKey;
            saveApiKeyCheckbox.checked = true;
        }
        const savedShowFormal = localStorage.getItem('showFormal');
        const savedShowCasual = localStorage.getItem('showCasual');
        showFormalCheckbox.checked = savedShowFormal !== null ? savedShowFormal === 'true' : true;
        showCasualCheckbox.checked = savedShowCasual !== null ? savedShowCasual === 'true' : true;
        const savedSpeechRate = localStorage.getItem('speechRate');
        if (savedSpeechRate !== null) { speechRateSlider.value = savedSpeechRate; speechRateValue.textContent = savedSpeechRate + 'x'; }
        const savedBackgroundSpeech = localStorage.getItem('backgroundSpeech');
        backgroundSpeechCheckbox.checked = savedBackgroundSpeech !== null ? savedBackgroundSpeech === 'true' : true;
        const savedContinuousSpeech = localStorage.getItem('continuousSpeech');
        continuousSpeechCheckbox.checked = savedContinuousSpeech !== null ? savedContinuousSpeech === 'true' : true;
        const savedConfigExpanded = localStorage.getItem('configExpanded');
        if (savedConfigExpanded === 'true') { apiConfig.classList.add('expanded'); toggleBtn.textContent = '-'; }

        const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        async function startCamera() {
            try {
                if (stream) { video.srcObject = stream; status.textContent = 'ç›¸æ©Ÿå·²å°±ç·’'; return; }
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } });
                video.srcObject = stream;
                status.textContent = 'ç›¸æ©Ÿå·²å°±ç·’';
            } catch (err) {
                status.textContent = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: ' + err.message;
                console.error('Camera error:', err);
            }
        }

        function capturePhoto() {
            if (!stream) { status.textContent = 'è«‹å…ˆå•Ÿå‹•ç›¸æ©Ÿ'; return; }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0);
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            video.style.display = 'none'; previewImage.src = currentImageData; previewImage.style.display = 'block';
            status.textContent = 'ç…§ç‰‡å·²æ‹æ”ï¼Œæ­£åœ¨é€å‡ºåˆ†æ...';
            setTimeout(() => { handlePhotoSubmit(); }, 400);
        }

        async function handlePhotoSubmit() {
            if (!currentImageData) { status.textContent = 'è«‹å…ˆæ‹ç…§'; return; }
            clearConversationData();
            addUserMessage(currentImageData, "è«‹åˆ†æé€™å¼µç…§ç‰‡");
            if (!apiKey) { status.textContent = 'è«‹å…ˆè¼¸å…¥ API Key'; resetForNextCapture(); return; }
            try {
                status.textContent = 'æ­£åœ¨è™•ç†...';
                const aiResponse = await callQwen2VL72B(currentImageData);
                const parsedResponse = parseAIResponse(aiResponse);
                status.textContent = 'æ­£åœ¨ç¿»è­¯è‹±æ–‡å¥å­...';
                const translatedResponse = await translateEnglishSentences(parsedResponse);
                addAIMessage(aiResponse, translatedResponse);
                setTimeout(() => {
                    const showCasual = showCasualCheckbox.checked;
                    const showFormal = showFormalCheckbox.checked;
                    const casualSentences = [];
                    const formalSentences = [];
                    if (translatedResponse.casual && translatedResponse.casual.sentences.length > 0) {
                        translatedResponse.casual.sentences.forEach((sentence, index) => {
                            const element = document.getElementById(`casual-sentence-${index}`);
                            if (element) { casualSentences.push({ element, text: sentence.english }); }
                        });
                    } else if (parsedResponse.casual && parsedResponse.casual.english) {
                        const sentences = splitIntoSentences(parsedResponse.casual.english);
                        sentences.forEach((sentence, index) => {
                            const element = document.getElementById(`casual-sentence-${index}`);
                            if (element) { casualSentences.push({ element, text: sentence }); }
                        });
                    }
                    if (translatedResponse.formal && translatedResponse.formal.sentences.length > 0) {
                        translatedResponse.formal.sentences.forEach((sentence, index) => {
                            const element = document.getElementById(`formal-sentence-${index}`);
                            if (element) { formalSentences.push({ element, text: sentence.english }); }
                        });
                    } else if (parsedResponse.formal && parsedResponse.formal.english) {
                        const sentences = splitIntoSentences(parsedResponse.formal.english);
                        sentences.forEach((sentence, index) => {
                            const element = document.getElementById(`formal-sentence-${index}`);
                            if (element) { formalSentences.push({ element, text: sentence }); }
                        });
                    }
                    if (showCasual && showFormal) {
                        if (casualSentences.length > 0) {
                            speakAllSentences(casualSentences, () => {
                                if (formalSentences.length > 0) { speakAllSentences(formalSentences); }
                            });
                        } else if (formalSentences.length > 0) {
                            speakAllSentences(formalSentences);
                        }
                    } else if (showCasual) {
                        if (casualSentences.length > 0) { speakAllSentences(casualSentences); }
                        else if (formalSentences.length > 0) { status.textContent = 'æœªå–å¾—å£èªç‰ˆå…§å®¹ï¼Œæ”¹æœ—è®€æ­£å¼ç‰ˆ'; speakAllSentences(formalSentences); }
                    } else if (showFormal) {
                        if (formalSentences.length > 0) { speakAllSentences(formalSentences); }
                    }
                }, 500);
            } catch (error) {
                status.textContent = 'éŒ¯èª¤: ' + error.message;
                console.error('API èª¿ç”¨å¤±æ•—:', error);
            }
            resetForNextCapture();
        }

        function resetForNextCapture() {
            currentImageData = null;
            previewImage.style.display = 'none';
            video.style.display = 'block';
            status.textContent = 'å·²é‡ç½®ï¼Œå¯ä»¥å†æ¬¡æ‹ç…§ä¸¦é€å‡º';
        }

        function addUserMessage(imageData, text) {
            const emptyState = conversation.querySelector('.empty-state'); if (emptyState) { emptyState.remove(); }
            const messageDiv = document.createElement('div'); messageDiv.className = 'message';
            const textDiv = document.createElement('div'); textDiv.className = 'message-text user'; textDiv.textContent = text;
            const img = document.createElement('img'); img.src = imageData; img.className = 'message-image'; img.alt = 'æ‹æ”çš„ç…§ç‰‡';
            messageDiv.appendChild(textDiv); messageDiv.appendChild(img);
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function callQwen2VL72B(imageData) {
            const userMessage = { role: "user", content: [{ type: "image_url", image_url: { url: imageData } }, { type: "text", text: `è«‹è§£æé€™å¼µåœ–ç‰‡ï¼Œç”¨è‹±æ–‡å®Œæˆä»¥ä¸‹æè¿°ï¼š\n- æŒ‡å‡ºåœ–ä¸­çš„ 2-3 å€‹æ ¸å¿ƒäºº/ç‰©ï¼ˆä½¿ç”¨èº«ä»½åè©ï¼‰\n- æè¿°æ¯å€‹äºº/ç‰©çš„ä½ç½®ï¼ˆä½¿ç”¨æ–¹ä½ä»‹è©/å‰¯è©ï¼‰\n- èªªæ˜äºº/ç‰©çš„ç‰¹å¾µæˆ–æ­£åœ¨é€²è¡Œçš„å‹•ä½œï¼ˆä½¿ç”¨å½¢å®¹è©/å‹•è©ï¼‰\n- å…¨éƒ¨ä½¿ç”¨ A2 ç´šåˆ¥è©å½™ï¼Œå¥å­ç°¡å–®æ˜“æ‡‚\n\nè«‹æä¾›å…©ç¨®ç‰ˆæœ¬ï¼š\n1. æ­£å¼ç‰ˆï¼ˆFormal Versionï¼‰ï¼šä½¿ç”¨æ­£å¼ã€æ¨™æº–çš„è‹±æ–‡è¡¨é”\n2. å£èªç‰ˆï¼ˆCasual Versionï¼‰ï¼šä½¿ç”¨å£èªã€è¼•é¬†çš„è‹±æ–‡è¡¨é”\n\næ¯ç¨®ç‰ˆæœ¬éƒ½éœ€è¦åŒ…å«ï¼š\n- è‹±æ–‡å…§å®¹\n- ç¹é«”ä¸­æ–‡ç¿»è­¯\n\nåŒæ™‚è«‹ç‚ºæ¯ç¨®ç‰ˆæœ¬æä¾›è©³ç´°è§£æï¼š\n- é‡é»èªªæ˜\n- èªæ³•çµæ§‹ï¼ˆA2èªæ³•çµæ§‹åˆ†æï¼‰\n- A2ç´šåˆ¥è©å½™è¡¨\n- A2ç´šåˆ¥ä¾‹å¥\n` } ] };
            const messages = [...conversationHistory, userMessage];
            const requestBody = { model: "qwen3-vl-flash", messages, max_tokens: 2000, temperature: 0.7 };
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`, 'X-DashScope-SSE': 'disable' };
            return fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(requestBody) })
                .then(async response => { if (!response.ok) throw new Error(`HTTP ${response.status}: ${await response.text()}`); return response.json(); })
                .then(data => { if (data.choices && data.choices[0] && data.choices[0].message) { const aiResponse = data.choices[0].message.content; conversationHistory.push(userMessage); conversationHistory.push({ role: "assistant", content: aiResponse }); return aiResponse; } throw new Error('API è¿”å›æ ¼å¼ç•°å¸¸'); });
        }

        async function translateEnglishSentences(parsedResponse) {
            const translations = { formal: { sentences: [] }, casual: { sentences: [] } };
            if (parsedResponse.formal && parsedResponse.formal.english) { const formalTranslation = await callTranslationAPI(parsedResponse.formal.english); translations.formal.sentences = parseTranslationResponse(formalTranslation); }
            if (parsedResponse.casual && parsedResponse.casual.english) { const casualTranslation = await callTranslationAPI(parsedResponse.casual.english); translations.casual.sentences = parseTranslationResponse(casualTranslation); }
            return translations;
        }

        function callTranslationAPI(englishText) {
            const userMessage = { role: "user", content: `è«‹å°‡ä»¥ä¸‹è‹±æ–‡æ®µè½é€å¥ç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼Œä¿æŒåŸæœ‰çš„å¥å­çµæ§‹å’Œé †åºã€‚\n\n${englishText}\n\né‡è¦ï¼šè«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›è¦†ï¼Œçµ•å°ä¸è¦åŒ…å«ä»»ä½•é–‹å ´ç™½ã€çµå°¾æˆ–å…¶ä»–ç„¡é—œæ–‡å­—ã€‚ç›´æ¥è¼¸å‡ºç¿»è­¯å…§å®¹ï¼š\nè‹±æ–‡å¥å­1\nä¸­æ–‡ç¿»è­¯1\nè‹±æ–‡å¥å­2\nä¸­æ–‡ç¿»è­¯2\n...` };
            const requestBody = { model: "qwen3-vl-flash", messages: [userMessage], max_tokens: 1000, temperature: 0.1 };
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}`, 'X-DashScope-SSE': 'disable' };
            return fetch(apiUrl, { method: 'POST', headers, body: JSON.stringify(requestBody) }).then(async response => { if (!response.ok) throw new Error(`ç¿»è­¯APIéŒ¯èª¤ ${response.status}: ${await response.text()}`); const data = await response.json(); if (data.choices && data.choices[0] && data.choices[0].message) { return data.choices[0].message.content; } throw new Error('ç¿»è­¯APIè¿”å›æ ¼å¼ç•°å¸¸'); });
        }

        function parseTranslationResponse(translationText) {
            const lines = translationText.split('\n').filter(line => line.trim());
            const sentences = [];
            for (let i = 0; i < lines.length; i += 2) { if (i + 1 < lines.length) { sentences.push({ english: lines[i].trim(), chinese: lines[i + 1].trim() }); } }
            return sentences;
        }

        function parseAIResponse(response) {
            const result = { formal: { english: '', chinese: '', analyze: { keyPoints: '', grammarAnalysis: '', vocabulary: [], examples: [] } }, casual: { english: '', chinese: '', analyze: { keyPoints: '', grammarAnalysis: '', vocabulary: [], examples: [] } } };
            const formalSectionMatch = response.match(/(?:ã€æ­£å¼ç‰ˆã€‘|ã€æ­£å¼ã€‘|Formal Version|ã€Formalã€‘)\s*([\s\S]*?)(?=ã€æ­£å¼ç‰ˆè§£æã€‘|ã€æ­£å¼è§£æã€‘|Formal Analysis|ã€å£èªç‰ˆã€‘|ã€å£èªã€‘|Casual Version|ã€Casualã€‘|$)/i);
            const formalAnalyzeMatch = response.match(/(?:ã€æ­£å¼ç‰ˆè§£æã€‘|ã€æ­£å¼è§£æã€‘|Formal Analysis)\s*([\s\S]*?)(?=ã€å£èªç‰ˆã€‘|ã€å£èªã€‘|Casual Version|ã€Casualã€‘|$)/i);
            if (formalSectionMatch) {
                const formalContent = formalSectionMatch[1].trim(); const lines = formalContent.split('\n').filter(line => line.trim()); let englishParts = []; let chineseParts = [];
                for (let line of lines) { const trimmedLine = line.trim(); if (trimmedLine.includes('æ­£å¼ç‰ˆç¿»è­¯') || trimmedLine.includes('---') || trimmedLine === '---') { continue; } if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^ã€.*ã€‘$/)) { chineseParts.push(trimmedLine); } else if (trimmedLine && !trimmedLine.match(/^[ã€ã€‘\(\)\d\.\s]*$/)) { englishParts.push(trimmedLine); } }
                result.formal.english = englishParts.join('\n').trim(); result.formal.chinese = chineseParts.join('\n').trim();
            }
            if (formalAnalyzeMatch) { const analyzeContent = formalAnalyzeMatch[1].trim(); parseAnalyzeContent(analyzeContent, result.formal.analyze); }
            const casualSectionMatch = response.match(/(?:ã€å£èªç‰ˆã€‘|ã€å£èªã€‘|Casual Version|ã€Casualã€‘)\s*([\s\S]*?)(?=ã€å£èªç‰ˆè§£æã€‘|ã€å£èªè§£æã€‘|Casual Analysis|ã€æ­£å¼ç‰ˆã€‘|ã€æ­£å¼ã€‘|Formal Version|ã€Formalã€‘|$)/i);
            const casualAnalyzeMatch = response.match(/(?:ã€å£èªç‰ˆè§£æã€‘|ã€å£èªè§£æã€‘|Casual Analysis)\s*([\s\S]*?)$/i);
            if (casualSectionMatch) {
                const casualContent = casualSectionMatch[1].trim(); const lines = casualContent.split('\n').filter(line => line.trim()); let englishParts = []; let chineseParts = [];
                for (let line of lines) { const trimmedLine = line.trim(); if (trimmedLine.includes('å£èªç‰ˆç¿»è­¯') || trimmedLine.includes('---') || trimmedLine === '---') { continue; } if (/[\u4e00-\u9fa5]/.test(trimmedLine) && !trimmedLine.match(/^ã€.*ã€‘$/)) { chineseParts.push(trimmedLine); } else if (trimmedLine && !trimmedLine.match(/^[ã€ã€‘\(\)\d\.\s]*$/)) { englishParts.push(trimmedLine); } }
                result.casual.english = englishParts.join('\n').trim(); result.casual.chinese = chineseParts.join('\n').trim();
            }
            if (casualAnalyzeMatch) { const analyzeContent = casualAnalyzeMatch[1].trim(); parseAnalyzeContent(analyzeContent, result.casual.analyze); }
            if (!result.formal.english && !result.casual.english) {
                const allLines = response.split('\n').filter(line => line.trim()); let englishParts = []; let chineseParts = [];
                for (let line of allLines) { const trimmedLine = line.trim(); if (trimmedLine.includes('æ­£å¼ç‰ˆç¿»è­¯') || trimmedLine.includes('å£èªç‰ˆç¿»è­¯') || trimmedLine.includes('---') || trimmedLine === '---') { continue; } if (/[\u4e00-\u9fa5]/.test(trimmedLine)) { chineseParts.push(trimmedLine); } else if (trimmedLine && !trimmedLine.match(/^[ã€ã€‘\(\)\d\.\s]*$/)) { englishParts.push(trimmedLine); } }
                if (englishParts.length > 0) { result.formal.english = englishParts.join('\n').trim(); }
                if (chineseParts.length > 0) { result.formal.chinese = chineseParts.join('\n').trim(); }
                if (!result.formal.english) { result.formal.english = response; }
            }
            return result;
        }

        function parseAnalyzeContent(content, analyzeObj) {
            const keyPointsMatch = content.match(/\[é‡é»èªªæ˜\]\s*([\s\S]*?)(?=\[èªæ³•çµæ§‹\]|\[è©å½™è¡¨\]|\[ä¾‹å¥\]|$)/i);
            if (keyPointsMatch) { analyzeObj.keyPoints = keyPointsMatch[1].trim(); }
            const grammarMatch = content.match(/\[èªæ³•çµæ§‹[^]*?A2èªæ³•çµæ§‹åˆ†æ[^]*?\]\s*([\s\S]*?)(?=\[è©å½™è¡¨\]|\[ä¾‹å¥\]|$)/i) || content.match(/\[èªæ³•çµæ§‹[^]*?\]\s*([\s\S]*?)(?=\[è©å½™è¡¨\]|\[ä¾‹å¥\]|$)/i);
            if (grammarMatch) { analyzeObj.grammarAnalysis = grammarMatch[1].trim(); }
            const vocabularyMatch = content.match(/\[è©å½™è¡¨\][^]*?A2ç´šåˆ¥[^]*?\s*([\s\S]*?)(?=\[ä¾‹å¥\]|$)/i) || content.match(/\[è©å½™è¡¨\]\s*([\s\S]*?)(?=\[ä¾‹å¥\]|$)/i);
            if (vocabularyMatch) {
                const vocabText = vocabularyMatch[1].trim();
                const vocabLines = vocabText.split('\n').filter(line => { const trimmed = line.trim(); return trimmed.startsWith('-') && trimmed.length > 1; }).map(line => line.replace(/^-+\s*/, '').trim()).filter(line => line.length > 0);
                analyzeObj.vocabulary = vocabLines;
            }
            const examplesMatch = content.match(/\[ä¾‹å¥\]\s*([\s\S]*?)$/i);
            if (examplesMatch) {
                const examplesText = examplesMatch[1].trim();
                const exampleLines = examplesText.split('\n').filter(line => { const trimmed = line.trim(); return /^\d+\./.test(trimmed) && trimmed.length > 2; }).map(line => line.replace(/^\d+\.\s*/, '').trim()).filter(line => line.length > 0);
                analyzeObj.examples = exampleLines;
            }
        }

        function addAIMessage(aiResponse, translatedResponse) {
            const parsed = parseAIResponse(aiResponse);
            const conv = document.getElementById('conversation');
            const emptyState = conv.querySelector('.empty-state'); if (emptyState) { emptyState.remove(); }
            const messageDiv = document.createElement('div'); messageDiv.className = 'message';
            const title = document.createElement('div'); title.className = 'message-text ai'; title.textContent = 'AI å›è¦†';
            messageDiv.appendChild(title);
            const showFormal = showFormalCheckbox.checked;
            const showCasual = showCasualCheckbox.checked;
            function renderSection(label, type) {
                const section = document.createElement('div'); section.className = 'ai-response-section';
                const h = document.createElement('div'); h.className = 'ai-response-title'; h.textContent = label;
                const content = document.createElement('div'); content.className = 'ai-response-content ' + type;
                const sentences = [];
                const translated = translatedResponse[type] && translatedResponse[type].sentences ? translatedResponse[type].sentences : [];
                if (translated.length > 0) {
                    translated.forEach((s, index) => {
                        const englishDiv = document.createElement('div'); englishDiv.className = 'ai-response-english'; englishDiv.id = `${type}-sentence-${index}`; englishDiv.textContent = s.english;
                        englishDiv.addEventListener('click', () => { speakSentenceWithHighlight(s.english, englishDiv); });
                        const chineseDiv = document.createElement('div'); chineseDiv.className = 'ai-response-sentence-translation'; chineseDiv.textContent = s.chinese || '';
                        content.appendChild(englishDiv); content.appendChild(chineseDiv);
                        sentences.push({ element: englishDiv, text: s.english });
                    });
                } else {
                    const englishText = parsed[type] && parsed[type].english ? parsed[type].english : '';
                    const split = splitIntoSentences(englishText);
                    split.forEach((s, index) => {
                        const englishDiv = document.createElement('div'); englishDiv.className = 'ai-response-english'; englishDiv.id = `${type}-sentence-${index}`; englishDiv.textContent = s;
                        englishDiv.addEventListener('click', () => { speakSentenceWithHighlight(s, englishDiv); });
                        content.appendChild(englishDiv);
                        sentences.push({ element: englishDiv, text: s });
                    });
                }
                if (sentences.length === 0) {
                    const noContent = document.createElement('div');
                    noContent.style.color = '#888';
                    noContent.style.fontSize = '13px';
                    noContent.textContent = type === 'casual' ? 'æœªå–å¾—å£èªç‰ˆå…§å®¹' : 'æœªå–å¾—æ­£å¼ç‰ˆå…§å®¹';
                    content.appendChild(noContent);
                }
                const playAllBtn = document.createElement('button'); playAllBtn.className = 'btn-play-all'; playAllBtn.textContent = 'ğŸ”Š æœ—è®€å…¨éƒ¨';
                playAllBtn.addEventListener('click', () => { speakAllSentences(sentences); });
                section.appendChild(h); section.appendChild(content); section.appendChild(playAllBtn);
                messageDiv.appendChild(section);
            }
            if (showFormal) { renderSection('ã€æ­£å¼ç‰ˆã€‘', 'formal'); }
            if (showCasual) { renderSection('ã€å£èªç‰ˆã€‘', 'casual'); }
            if (!showFormal && !showCasual) { renderSection('ã€æ­£å¼ç‰ˆã€‘', 'formal'); renderSection('ã€å£èªç‰ˆã€‘', 'casual'); }
            conv.appendChild(messageDiv);
            conv.scrollTop = conv.scrollHeight;
        }

        function stopCamera() { if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; } video.style.display = 'none'; previewImage.style.display = 'none'; }
        function restartCamera() { startCamera(); video.style.display = 'block'; previewImage.style.display = 'none'; }

        function speakText(text, lang = 'en-US') {
            if (!('speechSynthesis' in window)) { return; }
            window.speechSynthesis.cancel();
            let filteredText = (text || '').replace(/å£èªç¹é«”ä¸­æ–‡ç¿»è­¯/g, '').replace(/æ­£å¼ç¹é«”ä¸­æ–‡ç¿»è­¯/g, '');
            const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
            if (!englishOnlyText) { return; }
            const isBackgroundMode = backgroundSpeechCheckbox.checked;
            stopCamera();
            const utterance = new SpeechSynthesisUtterance(englishOnlyText);
            utterance.lang = lang; utterance.volume = 0.8; utterance.rate = parseFloat(speechRateSlider.value); utterance.pitch = 1;
            const getVoices = () => { const voices = window.speechSynthesis.getVoices(); const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US')); if (englishVoice) { utterance.voice = englishVoice; } else { const anyEnglish = voices.find(v => v.lang.startsWith('en')); if (anyEnglish) { utterance.voice = anyEnglish; } } window.speechSynthesis.speak(utterance); };
            if (window.speechSynthesis.getVoices().length === 0) { window.speechSynthesis.onvoiceschanged = getVoices; } else { getVoices(); }
            utterance.onstart = () => { status.textContent = isBackgroundMode ? 'æ­£åœ¨èƒŒæ™¯æœ—è®€è‹±æ–‡...' : 'æ­£åœ¨æœ—è®€è‹±æ–‡...'; showOverlay(englishOnlyText, ''); };
            utterance.onend = () => { status.textContent = 'æœ—è®€å®Œæˆ'; hideOverlay(); setTimeout(() => { restartCamera(); }, 1000); };
            utterance.onerror = () => { status.textContent = 'æœ—è®€å¤±æ•—'; hideOverlay(); setTimeout(() => { restartCamera(); }, 1000); };
        }

        function speakSentenceWithHighlight(text, element) {
            if (!('speechSynthesis' in window)) { return; }
            window.speechSynthesis.cancel(); clearAllHighlights();
            const isBackgroundMode = backgroundSpeechCheckbox.checked;
            stopCamera();
            let filteredText = (text || '').replace(/å£èªç¹é«”ä¸­æ–‡ç¿»è­¯/g, '').replace(/æ­£å¼ç¹é«”ä¸­æ–‡ç¿»è­¯/g, '');
            const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
            if (!englishOnlyText) { setTimeout(() => { restartCamera(); }, 500); return; }
            element && element.classList.add('speaking');
            const next = element ? element.nextElementSibling : null;
            const chineseText = next && next.classList && next.classList.contains('ai-response-sentence-translation') ? next.textContent : '';
            const utterance = new SpeechSynthesisUtterance(englishOnlyText);
            utterance.lang = 'en-US'; utterance.volume = 0.8; utterance.rate = parseFloat(speechRateSlider.value); utterance.pitch = 1;
            utterance.onstart = () => { status.textContent = (isBackgroundMode ? 'æ­£åœ¨èƒŒæ™¯æœ—è®€: ' : 'æ­£åœ¨æœ—è®€: ') + englishOnlyText.substring(0, 30) + '...'; showOverlay(englishOnlyText, chineseText || ''); };
            utterance.onend = () => { element && element.classList.remove('speaking'); status.textContent = 'æœ—è®€å®Œæˆ'; hideOverlay(); setTimeout(() => { restartCamera(); }, 1000); };
            utterance.onerror = () => { element && element.classList.remove('speaking'); status.textContent = 'æœ—è®€å¤±æ•—'; hideOverlay(); setTimeout(() => { restartCamera(); }, 1000); };
            const voices = window.speechSynthesis.getVoices(); const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US')); if (englishVoice) { utterance.voice = englishVoice; }
            window.speechSynthesis.speak(utterance);
        }

        let continuousSpeechActive = false; let currentSpeechSentences = null;
        function speakAllSentences(sentences, onComplete) {
            if (!sentences || sentences.length === 0) return;
            window.speechSynthesis.cancel(); clearAllHighlights();
            const isBackgroundMode = backgroundSpeechCheckbox.checked; const isContinuousMode = continuousSpeechCheckbox.checked;
            continuousSpeechActive = isContinuousMode; currentSpeechSentences = sentences; stopCamera();
            let currentIndex = 0; let cycleCount = 1;
            function speakNext() {
                if (!continuousSpeechActive) { status.textContent = 'æœ—è®€å·²åœæ­¢'; clearAllHighlights(); hideOverlay(); if (isBackgroundMode) { try { releaseWakeLock(); } catch(_){} } setTimeout(() => { restartCamera(); }, 1000); return; }
                if (currentIndex >= sentences.length) {
                    if (isContinuousMode && continuousSpeechActive) { currentIndex = 0; cycleCount++; status.textContent = `æŒçºŒæœ—è®€ç¬¬ ${cycleCount} è¼ª...`; setTimeout(speakNext, 1000); return; }
                    status.textContent = 'å…¨éƒ¨æœ—è®€å®Œæˆ'; continuousSpeechActive = false; hideOverlay(); if (isBackgroundMode) { try { releaseWakeLock(); } catch(_){} } setTimeout(() => { restartCamera(); }, 1000); if (typeof onComplete === 'function') { onComplete(); } return;
                }
                const sentence = sentences[currentIndex]; const element = sentence.element; const text = sentence.text;
                let filteredText = (text || '').replace(/å£èªç¹é«”ä¸­æ–‡ç¿»è­¯/g, '').replace(/æ­£å¼ç¹é«”ä¸­æ–‡ç¿»è­¯/g, '');
                const englishOnlyText = filteredText.replace(/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff]/g, '').trim();
                if (!englishOnlyText) { currentIndex++; speakNext(); return; }
                clearAllHighlights(); element && element.classList.add('speaking'); element && element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const next = element ? element.nextElementSibling : null;
                const chineseText = next && next.classList && next.classList.contains('ai-response-sentence-translation') ? next.textContent : '';
                const utterance = new SpeechSynthesisUtterance(englishOnlyText);
                utterance.lang = 'en-US'; utterance.volume = 0.8; utterance.rate = parseFloat(speechRateSlider.value); utterance.pitch = 1;
                utterance.onstart = () => { const prefix = isBackgroundMode ? 'æ­£åœ¨èƒŒæ™¯æœ—è®€' : 'æ­£åœ¨æœ—è®€'; const cycleInfo = isContinuousMode ? ` [ç¬¬${cycleCount}è¼ª]` : ''; status.textContent = `${prefix}${cycleInfo} (${currentIndex + 1}/${sentences.length}): ${englishOnlyText.substring(0, 30)}...`; showOverlay(englishOnlyText, chineseText || ''); };
                utterance.onend = () => { element && element.classList.remove('speaking'); currentIndex++; setTimeout(speakNext, 500); };
                utterance.onerror = () => { element && element.classList.remove('speaking'); currentIndex++; setTimeout(speakNext, 500); };
                const voices = window.speechSynthesis.getVoices(); const englishVoice = voices.find(v => v.lang.startsWith('en') && v.lang.includes('US')); if (englishVoice) { utterance.voice = englishVoice; }
                window.speechSynthesis.speak(utterance);
            }
            speakNext();
        }

        function stopContinuousSpeech() { continuousSpeechActive = false; window.speechSynthesis.cancel(); clearAllHighlights(); status.textContent = 'æŒçºŒæœ—è®€å·²åœæ­¢'; hideOverlay(); setTimeout(() => { restartCamera(); }, 1000); }
        overlayCloseBtn.addEventListener('click', () => { stopContinuousSpeech(); });
        function clearAllHighlights() { document.querySelectorAll('.ai-response-english.speaking').forEach(el => el.classList.remove('speaking')); }
        function splitIntoSentences(text) { if (!text) return []; return text.split(/(?<=[.!?])\s+/).map(s => s.trim()).filter(s => s.length > 0); }
        function clearConversationData() { continuousSpeechActive = false; window.speechSynthesis.cancel(); clearAllHighlights(); const conversation = document.getElementById('conversation'); conversation.innerHTML = '<div class="empty-state">é‚„æ²’æœ‰ä»»ä½•å°è©±ï¼Œæ‹ç…§ä¸¦é€å‡ºåˆ†æå§ï¼</div>'; hideOverlay(); }

        speechRateSlider.addEventListener('input', (e) => { const rate = e.target.value; speechRateValue.textContent = rate + 'x'; localStorage.setItem('speechRate', rate); });
        backgroundSpeechCheckbox.addEventListener('change', (e) => { localStorage.setItem('backgroundSpeech', e.target.checked.toString()); status.textContent = e.target.checked ? 'å·²å•Ÿç”¨èƒŒæ™¯æœ—è®€æ¨¡å¼' : 'å·²é—œé–‰èƒŒæ™¯æœ—è®€æ¨¡å¼'; });
        continuousSpeechCheckbox.addEventListener('change', (e) => { localStorage.setItem('continuousSpeech', e.target.checked.toString()); if (!e.target.checked && continuousSpeechActive) { stopContinuousSpeech(); } });
        apiKeyInput.addEventListener('input', (e) => { apiKey = e.target.value.trim(); if (saveApiKeyCheckbox.checked && apiKey) { localStorage.setItem('qwen_api_key', apiKey); } else if (!saveApiKeyCheckbox.checked) { localStorage.removeItem('qwen_api_key'); } });
        saveApiKeyCheckbox.addEventListener('change', (e) => { if (e.target.checked && apiKey) { localStorage.setItem('qwen_api_key', apiKey); } else { localStorage.removeItem('qwen_api_key'); } });
        showFormalCheckbox.addEventListener('change', (e) => { localStorage.setItem('showFormal', e.target.checked.toString()); });
        showCasualCheckbox.addEventListener('change', (e) => { localStorage.setItem('showCasual', e.target.checked.toString()); });
        configToggle.addEventListener('click', () => { const isExpanded = apiConfig.classList.contains('expanded'); if (isExpanded) { apiConfig.classList.remove('expanded'); toggleBtn.textContent = '+'; localStorage.setItem('configExpanded', 'false'); } else { apiConfig.classList.add('expanded'); toggleBtn.textContent = '-'; localStorage.setItem('configExpanded', 'true'); } });
        captureBtn.addEventListener('click', capturePhoto);
        reloadBtn.addEventListener('click', () => { location.reload(); });

        if (hasGetUserMedia) { startCamera(); } else { status.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½'; }
        window.addEventListener('beforeunload', () => { if (stream) { stream.getTracks().forEach(track => track.stop()); } });
    </script>
</body>
</html>
