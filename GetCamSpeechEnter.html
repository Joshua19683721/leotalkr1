<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èªéŸ³æ§åˆ¶æ‹ç…§åˆ†æ</title>
    <style>
        /* ... ä¿æŒåŸæœ¬çš„ CSS æ¨£å¼ ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 10px; }
        .conversation { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px; min-height: 400px; max-height: calc(100vh - 280px); overflow-y: auto; }
        .camera-controls { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); padding: 15px; border-top-left-radius: 25px; z-index: 100; }
        #videoElement { position: fixed; bottom: 130px; left: 20px; width: 80px; height: 142px; border-radius: 8px; object-fit: cover; background: #000; border: 2px solid white; }
        .button-group { display: flex; gap: 10px; justify-content: center; }
        .btn { padding: 12px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; }
        .btn-capture { background: #667eea; color: white; }
        .btn-submit { background: #28a745; color: white; }
        .status { text-align: center; color: #666; font-size: 13px; margin-top: 8px; font-weight: bold; }
        .voice-indicator { color: #ffeb3b; font-size: 12px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ èªéŸ³æ„Ÿæ‡‰åˆ†æå„€</h1>
            <p>å°è‘—æ‰‹æ©Ÿèªªã€Œ**æ‹ç…§**ã€å³å¯è‡ªå‹•åŸ·è¡Œ</p>
            <div id="voiceStatus" class="voice-indicator">æ­£åœ¨å•Ÿå‹•èªéŸ³ç›£è½...</div>
        </div>
        <div class="conversation" id="conversation"></div>
    </div>

    <div class="camera-controls">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement" style="display: none;"></canvas>
        <div class="button-group">
            <button class="btn btn-capture" id="captureBtn">ğŸ“· æ‹ç…§</button>
            <button class="btn btn-submit" id="submitBtn">ğŸ“¤ é€å‡º</button>
        </div>
        <div class="status" id="status">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const status = document.getElementById('status');
        const voiceStatus = document.getElementById('voiceStatus');
        let currentImageData = null;

        // --- 1. ç›¸æ©Ÿå•Ÿå‹• ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
            } catch (err) {
                status.textContent = "ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—";
            }
        }

        // --- 2. æ ¸å¿ƒæ‹ç…§å‹•ä½œ ---
        function performCapture() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            status.textContent = "ğŸ“¸ å·²è‡ªå‹•æ‹ç…§ï¼æ­£åœ¨é€å‡º...";
            
            // é€™è£¡ç›´æ¥è§¸ç™¼ä½ çš„ API é€å‡ºé‚è¼¯
            // handlePhotoSubmit(); 
        }

        // --- 3. èªéŸ³è¾¨è­˜ç›£è½ (é—œéµå­—ï¼šæ‹ç…§) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = true; // æŒçºŒç›£è½
            recognition.interimResults = false; // åªå–æœ€çµ‚çµæœ
            recognition.lang = 'zh-TW';

            recognition.onstart = () => {
                voiceStatus.textContent = "ğŸŸ¢ èªéŸ³ç›£è½ä¸­ï¼šè«‹èªªã€Œæ‹ç…§ã€";
            };

            recognition.onresult = (event) => {
                const lastResult = event.results[event.results.length - 1][0].transcript;
                console.log("è½åˆ°èªéŸ³ï¼š", lastResult);

                if (lastResult.includes("æ‹ç…§")) {
                    performCapture();
                    // æ‹ç…§å¾Œå¯ä»¥çµ¦ä¸€å€‹éœ‡å‹•å›é¥‹ (å¦‚æœæ‰‹æ©Ÿæ”¯æ´)
                    if (navigator.vibrate) navigator.vibrate(100);
                }
            };

            recognition.onerror = (event) => {
                console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š", event.error);
                voiceStatus.textContent = "ğŸŸ¡ èªéŸ³æš«ä¸­æ–·ï¼Œé»æ“Šé é¢é‡å•Ÿ";
            };

            // è‡ªå‹•é‡é€£ï¼Œç¢ºä¿ç›£è½ä¸ä¸­æ–·
            recognition.onend = () => {
                recognition.start();
            };

            // å•Ÿå‹•è¾¨è­˜ (éœ€ä½¿ç”¨è€…æ‰‹å‹•é»éé é¢å¾Œç”Ÿæ•ˆ)
            document.body.addEventListener('click', () => {
                recognition.start();
            }, { once: true });

        } else {
            voiceStatus.textContent = "âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³è¾¨è­˜";
        }

        // æŒ‰éˆ•é»æ“Šäº‹ä»¶ (ä¿ç•™æ‰‹å‹•åŠŸèƒ½)
        document.getElementById('captureBtn').addEventListener('click', performCapture);

        window.onload = startCamera;
    </script>
</body>
</html>
