<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S29 æŒ‡ç’°é€£å‹•ï¼šæ‹ç…§åˆ†æå°è©±</title>
    <style>
        /* ä¿ç•™ä½ åŸæœ¬çš„æ‰€æœ‰ CSS æ¨£å¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 10px; }
        .header h1 { font-size: 20px; margin-bottom: 4px; }
        .config-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 6px 12px; margin-bottom: 10px; cursor: pointer; color: white; }
        .api-config { background: rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 10px; margin-bottom: 10px; display: none; flex-direction: column; gap: 8px; }
        .api-config.expanded { display: flex; }
        .api-config input { width: 100%; padding: 8px; border-radius: 6px; border: none; }
        .conversation { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 15px; min-height: 400px; max-height: calc(100vh - 280px); overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .message { margin-bottom: 20px; display: flex; flex-direction: column; }
        .message-text { padding: 12px 16px; border-radius: 18px; max-width: 90%; margin-bottom: 8px; font-size: 14px; }
        .message-text.user { background: #667eea; color: white; align-self: flex-end; }
        .message-text.ai { background: #f0f0f0; color: #333; align-self: flex-start; }
        .message-image { width: 100%; border-radius: 12px; margin-top: 8px; }
        .camera-controls { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.98); padding: 15px; border-top-left-radius: 25px; border-top-right-radius: 25px; z-index: 100; }
        #videoElement { position: fixed; bottom: 130px; left: 20px; width: 80px; height: 142px; border-radius: 8px; object-fit: cover; background: #000; z-index: 50; border: 2px solid white; }
        .button-group { display: flex; gap: 10px; justify-content: center; }
        .btn { padding: 12px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; }
        .btn-capture { background: #667eea; color: white; }
        .btn-submit { background: #28a745; color: white; }
        .status { text-align: center; color: #666; font-size: 12px; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ S29 æŒ‡ç’°è‡ªå‹•åŒ–åˆ†æ</h1>
            <p>æŒ‰ä¸‹æŒ‡ç’°éŸ³é‡ä¸Šéµè‡ªå‹•æ‹ç…§</p>
            <div class="config-toggle" onclick="document.getElementById('apiConfig').classList.toggle('expanded')">âš™ï¸ è¨­å®š API</div>
            <div class="api-config" id="apiConfig">
                <input type="password" id="apiKey" placeholder="è²¼ä¸Š API Key" />
            </div>
        </div>
        <div class="conversation" id="conversation">
            <div class="status" id="keyDebugger">ç­‰å¾…æŒ‡ç’°è¨Šè™Ÿ...</div>
        </div>
    </div>

    <div class="camera-controls">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvasElement" style="display: none;"></canvas>
        <div class="button-group">
            <button class="btn btn-capture" id="captureBtn">ğŸ“· æ‹ç…§</button>
            <button class="btn btn-submit" id="submitBtn">ğŸ“¤ é€å‡º</button>
        </div>
        <div class="status" id="status">ç›¸æ©Ÿå•Ÿå‹•ä¸­...</div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const status = document.getElementById('status');
        const keyDebugger = document.getElementById('keyDebugger');
        let currentImageData = null;
        let isProcessing = false;

        // --- 1. S29 æŒ‡ç’°æ””æˆªé‚è¼¯ ---
        document.addEventListener('keydown', function(event) {
            const keyName = event.key;
            keyDebugger.innerText = "åµæ¸¬åˆ°æŒ‰éµ: " + keyName; // æ–¹ä¾¿ä½ åœ¨æ‰‹æ©Ÿä¸Šçœ‹æŒ‰éµåç¨±

            // Android ä¸Š S29 éŸ³é‡ä¸Šéµå°æ‡‰åç¨±
            if (keyName === 'AudioVolumeUp' || keyName === 'VolumeUp') {
                event.preventDefault(); 
                if (isProcessing) return; // é˜²æ­¢é‡è¤‡è§¸ç™¼
                
                status.textContent = "ğŸš€ æŒ‡ç’°è§¸ç™¼ï¼šæ­£åœ¨æ‹ç…§...";
                triggerRingAction();
            }
        }, { passive: false });

        async function triggerRingAction() {
            isProcessing = true;
            capturePhoto();
            
            // å»¶é²ä¸€ä¸‹ç¢ºä¿åœ–ç‰‡ç”Ÿæˆï¼Œç„¶å¾Œè‡ªå‹•é€å‡º
            setTimeout(async () => {
                if (currentImageData) {
                    status.textContent = "ğŸ“¤ åœ–ç‰‡ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨ä¸Šå‚³åˆ†æ...";
                    await handlePhotoSubmit();
                } else {
                    status.textContent = "âŒ æ‹ç…§å¤±æ•—ï¼Œè«‹æ‰‹å‹•é»æ“Šç¶²é ç²å–æ¬Šé™";
                    isProcessing = false;
                }
            }, 600);
        }

        // --- 2. ç›¸æ©ŸåŠŸèƒ½ ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 1280, height: 720 } 
                });
                video.srcObject = stream;
                status.textContent = "âœ… ç›¸æ©Ÿå°±ç·’ï¼Œå¯ç”¨æŒ‡ç’°æ§åˆ¶";
            } catch (err) {
                status.textContent = "âŒ ç›¸æ©Ÿå¤±æ•—: " + err.message;
            }
        }

        function capturePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            currentImageData = canvas.toDataURL('image/jpeg', 0.8);
            status.textContent = "ğŸ“¸ å·²æ‹æ”ï¼";
        }

        // --- 3. æ¨¡æ“¬åŸæœ¬çš„é€å‡ºé‚è¼¯ (è«‹ç¢ºä¿æ­¤è™•èˆ‡ä½ åŸæœ‰çš„ API å‡½å¼å°æ¥) ---
        async function handlePhotoSubmit() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                status.textContent = "âš ï¸ è«‹å…ˆå¡«å¯« API Key";
                isProcessing = false;
                return;
            }

            // é€™è£¡å‘¼å«ä½ åŸæœ‰çš„ callQwen2VL72B ç­‰ API è™•ç†å‡½å¼...
            // åŸ·è¡Œå®Œç•¢å¾Œè¨˜å¾—å°‡ isProcessing è¨­å› false
            console.log("æ­£åœ¨ç™¼é€ API è«‹æ±‚...");
            
            // ç¤ºç¯„å®Œç•¢å¾Œé‡ç½®
            // isProcessing = false; 
        }

        // é é¢è¼‰å…¥è‡ªå‹•åŸ·è¡Œ
        window.addEventListener('load', () => {
            startCamera();
            // å¾ LocalStorage è®€å– API Key çš„é‚è¼¯å¯åŠ åœ¨æ­¤è™•
        });

        // åŠ å…¥é»æ“Šé é¢æ¿€æ´»èªéŸ³/ç›¸æ©Ÿçš„æé†’
        document.body.addEventListener('click', () => {
            if (status.textContent.includes("æ‰‹å‹•é»æ“Š")) {
                startCamera();
            }
        }, { once: true });

    </script>
</body>
</html>
